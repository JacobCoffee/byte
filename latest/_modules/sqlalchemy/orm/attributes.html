<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>sqlalchemy.orm.attributes - Docs</title>
    <link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />
  <script>
    const isDarkTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const sessionTheme = sessionStorage['_theme']
    if (sessionTheme) {
      document.documentElement.classList.add(sessionTheme)
    } else if (isDarkTheme) {
      document.documentElement.classList.add('dark')
    }
  </script><link rel="shortcut icon" href="../../../_static/badge.svg"/><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=aecf457f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=28c32440" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=ee381b95" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=80d31e7b" />
    <style>
:root {
  --sy-f-sys:-apple-system, BlinkMacSystemFont, Segoe UI, Oxygen, Ubuntu, Droid Sans, Helvetica Neue;--sy-f-cjk:PingFang SC, Hiragino Sans GB, Droid Sans Fallback, Microsoft YaHei;--sy-f-heading:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-text:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-mono:Menlo, Monaco, Consolas, "Courier New", monospace;--sy-c-divider:rgba(var(--sy-rc-text), 0.1);--sy-c-divider-weak:rgba(var(--sy-rc-text), 0.05);--sy-c-border:rgba(var(--sy-rc-text), 0.14);--sy-s-banner-height:0rem;--sy-s-navbar-height:56px;--sy-s-offset-top:calc(var(--sy-s-navbar-height) + var(--sy-s-banner-height));--sy-c-link:rgb(var(--sy-rc-theme));--sy-c-link-weak:rgba(var(--sy-rc-theme), 0.86);
  --sy-rc-theme:66, 177, 168;--sy-rc-bg:255, 255, 255;--sy-rc-invert:66, 177, 168;--sy-rc-text:66, 177, 168;--sy-c-bg:#fff;--sy-c-bg-weak:12, 12, 12;--sy-c-text:#0C0C0C;--sy-c-text-weak:#42B1A8;--sy-c-heading:#42B1A8;--sy-c-bold:#42B1A8;--sy-c-foot-text:#0C0C0C;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#42B1A8;
}
@media (prefers-color-scheme: light) {
  :root {
    --sy-rc-theme:66, 177, 168;--sy-rc-bg:255, 255, 255;--sy-rc-invert:66, 177, 168;--sy-rc-text:66, 177, 168;--sy-c-bg:#fff;--sy-c-bg-weak:12, 12, 12;--sy-c-text:#0C0C0C;--sy-c-text-weak:#42B1A8;--sy-c-heading:#42B1A8;--sy-c-bold:#42B1A8;--sy-c-foot-text:#0C0C0C;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#42B1A8;
  }
}
@media (prefers-color-scheme: dark) {
  :root {
    --sy-rc-theme:66, 177, 168;--sy-rc-bg:12, 12, 12;--sy-rc-invert:66, 177, 168;--sy-rc-text:66, 177, 168;--sy-c-bg:#42B1A8;--sy-c-bg-weak:#0C0C0C;--sy-c-text:#EBEBE9;--sy-c-text-weak:#42B1A8;--sy-c-heading:#42B1A8;--sy-c-bold:#42B1A8;--sy-c-foot-text:#EBEBE9;--sy-c-foot-bg:#0C0C0C;--sy-c-foot-divider:#42B1A8;
  }
}
html.light {
  --sy-rc-theme:66, 177, 168;--sy-rc-bg:255, 255, 255;--sy-rc-invert:66, 177, 168;--sy-rc-text:66, 177, 168;--sy-c-bg:#fff;--sy-c-bg-weak:12, 12, 12;--sy-c-text:#0C0C0C;--sy-c-text-weak:#42B1A8;--sy-c-heading:#42B1A8;--sy-c-bold:#42B1A8;--sy-c-foot-text:#0C0C0C;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#42B1A8;
}
html.dark {
  --sy-rc-theme:66, 177, 168;--sy-rc-bg:12, 12, 12;--sy-rc-invert:66, 177, 168;--sy-rc-text:66, 177, 168;--sy-c-bg:#42B1A8;--sy-c-bg-weak:#0C0C0C;--sy-c-text:#EBEBE9;--sy-c-text-weak:#42B1A8;--sy-c-heading:#42B1A8;--sy-c-bold:#42B1A8;--sy-c-foot-text:#EBEBE9;--sy-c-foot-bg:#0C0C0C;--sy-c-foot-divider:#42B1A8;
}
</style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-heading: Inter, var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sqlalchemy.orm.attributes"/>
<meta name="twitter:card" content="summary"/></head>
<body><div class="document"><div class="announcement">
    <div class="announcement-inner">
      <p>This documentation is currently under development.</p>
      <button class="announcement-close" aria-label="Close announcement">
        <i class="i-icon close"></i>
      </button>
    </div>
  </div><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand mr-4" href="/">
      <img class="light-logo" src="../../../_static/badge.svg" alt="byte-bot" height="28" />
      <img class="dark-logo" src="../../../_static/badge.svg" alt="byte-bot" height="28" />
      <strong>byte-bot</strong>
    </a>
    <div class="sy-head-links" id="NavLinks">
      <nav class="sy-head-nav">

<ul><li class="link">
          <a href="https://byte-bot.app/"><span>Dashboard</span><i class="i-icon external-link"></i></a>
        </li><li class="link">
          <a href="https://github.com/sponsors/JacobCoffee"><span>Sponsor me</span><i class="i-icon external-link"></i></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form>
        
        
        <div class="sy-head-social flex items-center">
            <a class="flex items-center" href="https://github.com/JacobCoffee/byte-bot" aria-label="GitHub">
              <i class="i-icon github"></i>
            </a>
            <a class="flex items-center" href="https://discord.gg/ZVG8hN6RrJ/" aria-label="Discord">
              <i class="i-icon discord"></i>
            </a>
        </div>
      </div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden">
      <button class="js-theme theme-switch flex items-center" data-aria-light="Switch to dark mode" data-aria-dark="Switch to light mode">
        <i class="i-icon theme-icon"></i>
      </button>
      <button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="NavLinks" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading"><span class="caption-text">Byte Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../byte/usage/index.html">Usage</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../byte/api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../byte/api/bot.html">bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../byte/api/plugins/index.html">plugins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/plugins/admin.html">admin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/plugins/astral.html">astral</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/plugins/events.html">events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/plugins/general.html">general</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/plugins/github.html">github</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/plugins/guild.html">guild</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/plugins/testing.html">testing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../byte/api/views/index.html">views</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/views/forums.html">forums</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../byte/api/lib/index.html">lib</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/lib/common.html">common</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/lib/logging.html">logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/lib/settings.html">settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../byte/api/lib/utils.html">utils</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Web Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../web/usage/index.html">Usage</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../web/api/app.html">app</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../web/api/cli.html">cli</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../web/api/metadata.html">metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../web/api/utils.html">utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../web/api/domain/index.html">domain</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/domain/init.html">Domain Initializer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/domain/urls.html">urls</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/domain/system/index.html">system</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../web/api/domain/system/controllers.html">controllers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/domain/web/index.html">web</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../web/api/domain/web/controllers.html">controllers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/domain/db/index.html">Database</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../web/api/domain/db/models.html">models</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../web/api/lib/index.html">lib</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/lib/cors.html">cors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/lib/exceptions.html">exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/lib/openapi.html">openapi</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/lib/schema.html">schema</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/lib/serialization.html">serialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/lib/settings.html">settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/lib/static_files.html">static files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/lib/template.html">template</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/lib/log/index.html">logging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../web/api/lib/log/controller.html">controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../web/api/lib/log/init.html">init</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../web/api/lib/log/utils.html">utils</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../web/api/lib/db/index.html">Database Library</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../web/api/lib/db/base.html">base</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../web/api/lib/db/orm.html">orm</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contribution-guide.html">Contribution guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
      
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-icon close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/JacobCoffee/byte"
  data-type="github" data-user="JacobCoffee" data-repo="byte">
  <span class="w-8 flex items-center justify-around shrink-0 text-2xl">
    <i class="i-icon github"></i>
  </span>
  <span class="flex-grow px-2">
    <span>JacobCoffee/byte</span>
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <i class="i-icon star"></i>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <i class="i-icon git-fork"></i>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
    <div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-icon menu"></i>
      </button>
    </div>
    <ul class="flex-1">
      
      
      <li><a href="../../../index.html">byte-bot</a><span>/</span></li>
      
      <li><a href="../../index.html">Module code</a><span>/</span></li>
      
      <li><strong>sqlalchemy.orm.attributes</strong></li>
      
      
    </ul>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-icon outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sqlalchemy.orm.attributes</h1><div class="highlight"><pre>
<span></span><span id="1-1"><span class="c1"># orm/attributes.py</span>
</span><span id="1-2"><span class="c1"># Copyright (C) 2005-2025 the SQLAlchemy authors and contributors</span>
</span><span id="1-3"><span class="c1"># &lt;see AUTHORS file&gt;</span>
</span><span id="1-4"><span class="c1">#</span>
</span><span id="1-5"><span class="c1"># This module is part of SQLAlchemy and is released under</span>
</span><span id="1-6"><span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
</span><span id="1-7"><span class="c1"># mypy: allow-untyped-defs, allow-untyped-calls</span>
</span><span id="1-8">
</span><span id="1-9"><span class="sd">&quot;&quot;&quot;Defines instrumentation for class attributes and their interaction</span>
</span><span id="1-10"><span class="sd">with instances.</span>
</span><span id="1-11">
</span><span id="1-12"><span class="sd">This module is usually not directly visible to user applications, but</span>
</span><span id="1-13"><span class="sd">defines a large part of the ORM&#39;s interactivity.</span>
</span><span id="1-14">
</span><span id="1-15">
</span><span id="1-16"><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-17">
</span><span id="1-18"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span id="1-19">
</span><span id="1-20"><span class="kn">import</span><span class="w"> </span><span class="nn">dataclasses</span>
</span><span id="1-21"><span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
</span><span id="1-22"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span id="1-23"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
</span><span id="1-24"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span>
</span><span id="1-25"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClassVar</span>
</span><span id="1-26"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
</span><span id="1-27"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
</span><span id="1-28"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</span><span id="1-29"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTuple</span>
</span><span id="1-30"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="1-31"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">overload</span>
</span><span id="1-32"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
</span><span id="1-33"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span>
</span><span id="1-34"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Type</span>
</span><span id="1-35"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span id="1-36"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeVar</span>
</span><span id="1-37"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span id="1-38">
</span><span id="1-39"><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">collections</span>
</span><span id="1-40"><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">orm_exc</span>
</span><span id="1-41"><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">interfaces</span>
</span><span id="1-42"><span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">insp_is_aliased_class</span>
</span><span id="1-43"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DeclarativeMapped</span>
</span><span id="1-44"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ATTR_EMPTY</span>
</span><span id="1-45"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ATTR_WAS_SET</span>
</span><span id="1-46"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">CALLABLES_OK</span>
</span><span id="1-47"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEFERRED_HISTORY_LOAD</span>
</span><span id="1-48"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">INCLUDE_PENDING_MUTATIONS</span>  <span class="c1"># noqa</span>
</span><span id="1-49"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">INIT_OK</span>
</span><span id="1-50"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">instance_dict</span> <span class="k">as</span> <span class="n">instance_dict</span>
</span><span id="1-51"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">instance_state</span> <span class="k">as</span> <span class="n">instance_state</span>
</span><span id="1-52"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">instance_str</span>
</span><span id="1-53"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">LOAD_AGAINST_COMMITTED</span>
</span><span id="1-54"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoaderCallableStatus</span>
</span><span id="1-55"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">manager_of_class</span> <span class="k">as</span> <span class="n">manager_of_class</span>
</span><span id="1-56"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span> <span class="k">as</span> <span class="n">Mapped</span>  <span class="c1"># noqa</span>
</span><span id="1-57"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NEVER_SET</span>  <span class="c1"># noqa</span>
</span><span id="1-58"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NO_AUTOFLUSH</span>
</span><span id="1-59"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NO_CHANGE</span>  <span class="c1"># noqa</span>
</span><span id="1-60"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NO_KEY</span>
</span><span id="1-61"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NO_RAISE</span>
</span><span id="1-62"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NO_VALUE</span>
</span><span id="1-63"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">NON_PERSISTENT_OK</span>  <span class="c1"># noqa</span>
</span><span id="1-64"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">opt_manager_of_class</span> <span class="k">as</span> <span class="n">opt_manager_of_class</span>
</span><span id="1-65"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_CLASS_MISMATCH</span>  <span class="c1"># noqa</span>
</span><span id="1-66"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_NO_FETCH</span>
</span><span id="1-67"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_NO_FETCH_RELATED</span>  <span class="c1"># noqa</span>
</span><span id="1-68"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_NO_INITIALIZE</span>
</span><span id="1-69"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span id="1-70"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_OFF</span>
</span><span id="1-71"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_ONLY_PERSISTENT</span>
</span><span id="1-72"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PASSIVE_RETURN_NO_VALUE</span>
</span><span id="1-73"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PassiveFlag</span>
</span><span id="1-74"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">RELATED_OBJECT_OK</span>  <span class="c1"># noqa</span>
</span><span id="1-75"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQL_OK</span>  <span class="c1"># noqa</span>
</span><span id="1-76"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLORMExpression</span>
</span><span id="1-77"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">state_str</span>
</span><span id="1-78"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">event</span>
</span><span id="1-79"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">exc</span>
</span><span id="1-80"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspection</span>
</span><span id="1-81"><span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">util</span>
</span><span id="1-82"><span class="kn">from</span><span class="w"> </span><span class="nn">..event</span><span class="w"> </span><span class="kn">import</span> <span class="n">dispatcher</span>
</span><span id="1-83"><span class="kn">from</span><span class="w"> </span><span class="nn">..event</span><span class="w"> </span><span class="kn">import</span> <span class="n">EventTarget</span>
</span><span id="1-84"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">base</span> <span class="k">as</span> <span class="n">sql_base</span>
</span><span id="1-85"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache_key</span>
</span><span id="1-86"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">coercions</span>
</span><span id="1-87"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">roles</span>
</span><span id="1-88"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">visitors</span>
</span><span id="1-89"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.cache_key</span><span class="w"> </span><span class="kn">import</span> <span class="n">HasCacheKey</span>
</span><span id="1-90"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.visitors</span><span class="w"> </span><span class="kn">import</span> <span class="n">_TraverseInternalsType</span>
</span><span id="1-91"><span class="kn">from</span><span class="w"> </span><span class="nn">..sql.visitors</span><span class="w"> </span><span class="kn">import</span> <span class="n">InternalTraversal</span>
</span><span id="1-92"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
</span><span id="1-93"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Self</span>
</span><span id="1-94"><span class="kn">from</span><span class="w"> </span><span class="nn">..util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeGuard</span>
</span><span id="1-95">
</span><span id="1-96"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-97">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_EntityType</span>
</span><span id="1-98">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_ExternalEntityType</span>
</span><span id="1-99">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_InstanceDict</span>
</span><span id="1-100">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_InternalEntityType</span>
</span><span id="1-101">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_LoaderCallable</span>
</span><span id="1-102">    <span class="kn">from</span><span class="w"> </span><span class="nn">._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_O</span>
</span><span id="1-103">    <span class="kn">from</span><span class="w"> </span><span class="nn">.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">_AdaptedCollectionProtocol</span>
</span><span id="1-104">    <span class="kn">from</span><span class="w"> </span><span class="nn">.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">CollectionAdapter</span>
</span><span id="1-105">    <span class="kn">from</span><span class="w"> </span><span class="nn">.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">MapperProperty</span>
</span><span id="1-106">    <span class="kn">from</span><span class="w"> </span><span class="nn">.relationships</span><span class="w"> </span><span class="kn">import</span> <span class="n">RelationshipProperty</span>
</span><span id="1-107">    <span class="kn">from</span><span class="w"> </span><span class="nn">.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">InstanceState</span>
</span><span id="1-108">    <span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">AliasedInsp</span>
</span><span id="1-109">    <span class="kn">from</span><span class="w"> </span><span class="nn">.writeonly</span><span class="w"> </span><span class="kn">import</span> <span class="n">WriteOnlyAttributeImpl</span>
</span><span id="1-110">    <span class="kn">from</span><span class="w"> </span><span class="nn">..event.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">_Dispatch</span>
</span><span id="1-111">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_ColumnExpressionArgument</span>
</span><span id="1-112">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DMLColumnArgument</span>
</span><span id="1-113">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_InfoType</span>
</span><span id="1-114">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_PropagateAttrsType</span>
</span><span id="1-115">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.annotation</span><span class="w"> </span><span class="kn">import</span> <span class="n">_AnnotationDict</span>
</span><span id="1-116">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.elements</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnElement</span>
</span><span id="1-117">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.elements</span><span class="w"> </span><span class="kn">import</span> <span class="n">Label</span>
</span><span id="1-118">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.operators</span><span class="w"> </span><span class="kn">import</span> <span class="n">OperatorType</span>
</span><span id="1-119">    <span class="kn">from</span><span class="w"> </span><span class="nn">..sql.selectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">FromClause</span>
</span><span id="1-120">
</span><span id="1-121">
</span><span id="1-122"><span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">)</span>
</span><span id="1-123"><span class="n">_T_co</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T_co&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">,</span> <span class="n">covariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-124">
</span><span id="1-125">
</span><span id="1-126"><span class="n">_AllPendingType</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">[</span>
</span><span id="1-127">    <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;InstanceState[Any]&quot;</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]]</span>
</span><span id="1-128"><span class="p">]</span>
</span><span id="1-129">
</span><span id="1-130">
</span><span id="1-131"><span class="n">_UNKNOWN_ATTR_KEY</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
</span><span id="1-132">
</span><span id="1-133">
</span><span id="1-134"><span class="nd">@inspection</span><span class="o">.</span><span class="n">_self_inspects</span>
</span><span id="1-135"><span class="k">class</span><span class="w"> </span><span class="nc">QueryableAttribute</span><span class="p">(</span>
</span><span id="1-136">    <span class="n">_DeclarativeMapped</span><span class="p">[</span><span class="n">_T_co</span><span class="p">],</span>
</span><span id="1-137">    <span class="n">SQLORMExpression</span><span class="p">[</span><span class="n">_T_co</span><span class="p">],</span>
</span><span id="1-138">    <span class="n">interfaces</span><span class="o">.</span><span class="n">InspectionAttr</span><span class="p">,</span>
</span><span id="1-139">    <span class="n">interfaces</span><span class="o">.</span><span class="n">PropComparator</span><span class="p">[</span><span class="n">_T_co</span><span class="p">],</span>
</span><span id="1-140">    <span class="n">roles</span><span class="o">.</span><span class="n">JoinTargetRole</span><span class="p">,</span>
</span><span id="1-141">    <span class="n">roles</span><span class="o">.</span><span class="n">OnClauseRole</span><span class="p">,</span>
</span><span id="1-142">    <span class="n">sql_base</span><span class="o">.</span><span class="n">Immutable</span><span class="p">,</span>
</span><span id="1-143">    <span class="n">cache_key</span><span class="o">.</span><span class="n">SlotsMemoizedHasCacheKey</span><span class="p">,</span>
</span><span id="1-144">    <span class="n">util</span><span class="o">.</span><span class="n">MemoizedSlots</span><span class="p">,</span>
</span><span id="1-145">    <span class="n">EventTarget</span><span class="p">,</span>
</span><span id="1-146"><span class="p">):</span>
</span><span id="1-147"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for :term:`descriptor` objects that intercept</span>
</span><span id="1-148"><span class="sd">    attribute events on behalf of a :class:`.MapperProperty`</span>
</span><span id="1-149"><span class="sd">    object.  The actual :class:`.MapperProperty` is accessible</span>
</span><span id="1-150"><span class="sd">    via the :attr:`.QueryableAttribute.property`</span>
</span><span id="1-151"><span class="sd">    attribute.</span>
</span><span id="1-152">
</span><span id="1-153">
</span><span id="1-154"><span class="sd">    .. seealso::</span>
</span><span id="1-155">
</span><span id="1-156"><span class="sd">        :class:`.InstrumentedAttribute`</span>
</span><span id="1-157">
</span><span id="1-158"><span class="sd">        :class:`.MapperProperty`</span>
</span><span id="1-159">
</span><span id="1-160"><span class="sd">        :attr:`_orm.Mapper.all_orm_descriptors`</span>
</span><span id="1-161">
</span><span id="1-162"><span class="sd">        :attr:`_orm.Mapper.attrs`</span>
</span><span id="1-163"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-164">
</span><span id="1-165">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-166">        <span class="s2">&quot;class_&quot;</span><span class="p">,</span>
</span><span id="1-167">        <span class="s2">&quot;key&quot;</span><span class="p">,</span>
</span><span id="1-168">        <span class="s2">&quot;impl&quot;</span><span class="p">,</span>
</span><span id="1-169">        <span class="s2">&quot;comparator&quot;</span><span class="p">,</span>
</span><span id="1-170">        <span class="s2">&quot;property&quot;</span><span class="p">,</span>
</span><span id="1-171">        <span class="s2">&quot;parent&quot;</span><span class="p">,</span>
</span><span id="1-172">        <span class="s2">&quot;expression&quot;</span><span class="p">,</span>
</span><span id="1-173">        <span class="s2">&quot;_of_type&quot;</span><span class="p">,</span>
</span><span id="1-174">        <span class="s2">&quot;_extra_criteria&quot;</span><span class="p">,</span>
</span><span id="1-175">        <span class="s2">&quot;_slots_dispatch&quot;</span><span class="p">,</span>
</span><span id="1-176">        <span class="s2">&quot;_propagate_attrs&quot;</span><span class="p">,</span>
</span><span id="1-177">        <span class="s2">&quot;_doc&quot;</span><span class="p">,</span>
</span><span id="1-178">    <span class="p">)</span>
</span><span id="1-179">
</span><span id="1-180">    <span class="n">is_attribute</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-181">
</span><span id="1-182">    <span class="n">dispatch</span><span class="p">:</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]]</span>
</span><span id="1-183">
</span><span id="1-184">    <span class="n">class_</span><span class="p">:</span> <span class="n">_ExternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-185">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="1-186">    <span class="n">parententity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-187">    <span class="n">impl</span><span class="p">:</span> <span class="n">AttributeImpl</span>
</span><span id="1-188">    <span class="n">comparator</span><span class="p">:</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">PropComparator</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]</span>
</span><span id="1-189">    <span class="n">_of_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-190">    <span class="n">_extra_criteria</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
</span><span id="1-191">    <span class="n">_doc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="1-192">
</span><span id="1-193">    <span class="c1"># PropComparator has a __visit_name__ to participate within</span>
</span><span id="1-194">    <span class="c1"># traversals.   Disambiguate the attribute vs. a comparator.</span>
</span><span id="1-195">    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">&quot;orm_instrumented_attribute&quot;</span>
</span><span id="1-196">
</span><span id="1-197">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-198">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-199">        <span class="n">class_</span><span class="p">:</span> <span class="n">_ExternalEntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-200">        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="1-201">        <span class="n">parententity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-202">        <span class="n">comparator</span><span class="p">:</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">PropComparator</span><span class="p">[</span><span class="n">_T_co</span><span class="p">],</span>
</span><span id="1-203">        <span class="n">impl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeImpl</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-204">        <span class="n">of_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-205">        <span class="n">extra_criteria</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ColumnElement</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
</span><span id="1-206">    <span class="p">):</span>
</span><span id="1-207">        <span class="bp">self</span><span class="o">.</span><span class="n">class_</span> <span class="o">=</span> <span class="n">class_</span>
</span><span id="1-208">        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
</span><span id="1-209">
</span><span id="1-210">        <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parententity</span>
</span><span id="1-211">
</span><span id="1-212">        <span class="c1"># this attribute is non-None after mappers are set up, however in the</span>
</span><span id="1-213">        <span class="c1"># interim class manager setup, there&#39;s a check for None to see if it</span>
</span><span id="1-214">        <span class="c1"># needs to be populated, so we assign None here leaving the attribute</span>
</span><span id="1-215">        <span class="c1"># in a temporarily not-type-correct state</span>
</span><span id="1-216">        <span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">=</span> <span class="n">impl</span>  <span class="c1"># type: ignore</span>
</span><span id="1-217">
</span><span id="1-218">        <span class="k">assert</span> <span class="n">comparator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-219">        <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span> <span class="o">=</span> <span class="n">comparator</span>
</span><span id="1-220">        <span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span> <span class="o">=</span> <span class="n">of_type</span>
</span><span id="1-221">        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span> <span class="o">=</span> <span class="n">extra_criteria</span>
</span><span id="1-222">        <span class="bp">self</span><span class="o">.</span><span class="n">_doc</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-223">
</span><span id="1-224">        <span class="n">manager</span> <span class="o">=</span> <span class="n">opt_manager_of_class</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
</span><span id="1-225">        <span class="c1"># manager is None in the case of AliasedClass</span>
</span><span id="1-226">        <span class="k">if</span> <span class="n">manager</span><span class="p">:</span>
</span><span id="1-227">            <span class="c1"># propagate existing event listeners from</span>
</span><span id="1-228">            <span class="c1"># immediate superclass</span>
</span><span id="1-229">            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">manager</span><span class="o">.</span><span class="n">_bases</span><span class="p">:</span>
</span><span id="1-230">                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
</span><span id="1-231">                    <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
</span><span id="1-232">                    <span class="k">if</span> <span class="n">base</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span><span class="p">:</span>
</span><span id="1-233">                        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore</span>
</span><span id="1-234">
</span><span id="1-235">    <span class="n">_cache_key_traversal</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-236">        <span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">ExtendedInternalTraversal</span><span class="o">.</span><span class="n">dp_string</span><span class="p">),</span>
</span><span id="1-237">        <span class="p">(</span><span class="s2">&quot;_parententity&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">ExtendedInternalTraversal</span><span class="o">.</span><span class="n">dp_multi</span><span class="p">),</span>
</span><span id="1-238">        <span class="p">(</span><span class="s2">&quot;_of_type&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">ExtendedInternalTraversal</span><span class="o">.</span><span class="n">dp_multi</span><span class="p">),</span>
</span><span id="1-239">        <span class="p">(</span><span class="s2">&quot;_extra_criteria&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">InternalTraversal</span><span class="o">.</span><span class="n">dp_clauseelement_list</span><span class="p">),</span>
</span><span id="1-240">    <span class="p">]</span>
</span><span id="1-241">
</span><span id="1-242">    <span class="k">def</span><span class="w"> </span><span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-243">        <span class="c1"># this method is only used in terms of the</span>
</span><span id="1-244">        <span class="c1"># sqlalchemy.ext.serializer extension</span>
</span><span id="1-245">        <span class="k">return</span> <span class="p">(</span>
</span><span id="1-246">            <span class="n">_queryable_attribute_unreduce</span><span class="p">,</span>
</span><span id="1-247">            <span class="p">(</span>
</span><span id="1-248">                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span id="1-249">                <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span id="1-250">                <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span id="1-251">                <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span>
</span><span id="1-252">            <span class="p">),</span>
</span><span id="1-253">        <span class="p">)</span>
</span><span id="1-254">
</span><span id="1-255">    <span class="nd">@property</span>
</span><span id="1-256">    <span class="k">def</span><span class="w"> </span><span class="nf">_impl_uses_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-257">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">uses_objects</span>
</span><span id="1-258">
</span><span id="1-259">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span id="1-260">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span>
</span><span id="1-261">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-262">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get_history</span><span class="p">(</span>
</span><span id="1-263">            <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">passive</span>
</span><span id="1-264">        <span class="p">)</span>
</span><span id="1-265">
</span><span id="1-266">    <span class="nd">@property</span>
</span><span id="1-267">    <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_InfoType</span><span class="p">:</span>
</span><span id="1-268"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the &#39;info&#39; dictionary for the underlying SQL element.</span>
</span><span id="1-269">
</span><span id="1-270"><span class="sd">        The behavior here is as follows:</span>
</span><span id="1-271">
</span><span id="1-272"><span class="sd">        * If the attribute is a column-mapped property, i.e.</span>
</span><span id="1-273"><span class="sd">          :class:`.ColumnProperty`, which is mapped directly</span>
</span><span id="1-274"><span class="sd">          to a schema-level :class:`_schema.Column` object, this attribute</span>
</span><span id="1-275"><span class="sd">          will return the :attr:`.SchemaItem.info` dictionary associated</span>
</span><span id="1-276"><span class="sd">          with the core-level :class:`_schema.Column` object.</span>
</span><span id="1-277">
</span><span id="1-278"><span class="sd">        * If the attribute is a :class:`.ColumnProperty` but is mapped to</span>
</span><span id="1-279"><span class="sd">          any other kind of SQL expression other than a</span>
</span><span id="1-280"><span class="sd">          :class:`_schema.Column`,</span>
</span><span id="1-281"><span class="sd">          the attribute will refer to the :attr:`.MapperProperty.info`</span>
</span><span id="1-282"><span class="sd">          dictionary associated directly with the :class:`.ColumnProperty`,</span>
</span><span id="1-283"><span class="sd">          assuming the SQL expression itself does not have its own ``.info``</span>
</span><span id="1-284"><span class="sd">          attribute (which should be the case, unless a user-defined SQL</span>
</span><span id="1-285"><span class="sd">          construct has defined one).</span>
</span><span id="1-286">
</span><span id="1-287"><span class="sd">        * If the attribute refers to any other kind of</span>
</span><span id="1-288"><span class="sd">          :class:`.MapperProperty`, including :class:`.Relationship`,</span>
</span><span id="1-289"><span class="sd">          the attribute will refer to the :attr:`.MapperProperty.info`</span>
</span><span id="1-290"><span class="sd">          dictionary associated with that :class:`.MapperProperty`.</span>
</span><span id="1-291">
</span><span id="1-292"><span class="sd">        * To access the :attr:`.MapperProperty.info` dictionary of the</span>
</span><span id="1-293"><span class="sd">          :class:`.MapperProperty` unconditionally, including for a</span>
</span><span id="1-294"><span class="sd">          :class:`.ColumnProperty` that&#39;s associated directly with a</span>
</span><span id="1-295"><span class="sd">          :class:`_schema.Column`, the attribute can be referred to using</span>
</span><span id="1-296"><span class="sd">          :attr:`.QueryableAttribute.property` attribute, as</span>
</span><span id="1-297"><span class="sd">          ``MyClass.someattribute.property.info``.</span>
</span><span id="1-298">
</span><span id="1-299"><span class="sd">        .. seealso::</span>
</span><span id="1-300">
</span><span id="1-301"><span class="sd">            :attr:`.SchemaItem.info`</span>
</span><span id="1-302">
</span><span id="1-303"><span class="sd">            :attr:`.MapperProperty.info`</span>
</span><span id="1-304">
</span><span id="1-305"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-306">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">info</span>
</span><span id="1-307">
</span><span id="1-308">    <span class="n">parent</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-309"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return an inspection instance representing the parent.</span>
</span><span id="1-310">
</span><span id="1-311"><span class="sd">    This will be either an instance of :class:`_orm.Mapper`</span>
</span><span id="1-312"><span class="sd">    or :class:`.AliasedInsp`, depending upon the nature</span>
</span><span id="1-313"><span class="sd">    of the parent entity which this attribute is associated</span>
</span><span id="1-314"><span class="sd">    with.</span>
</span><span id="1-315">
</span><span id="1-316"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-317">
</span><span id="1-318">    <span class="n">expression</span><span class="p">:</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]</span>
</span><span id="1-319"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The SQL expression object represented by this</span>
</span><span id="1-320"><span class="sd">    :class:`.QueryableAttribute`.</span>
</span><span id="1-321">
</span><span id="1-322"><span class="sd">    This will typically be an instance of a :class:`_sql.ColumnElement`</span>
</span><span id="1-323"><span class="sd">    subclass representing a column expression.</span>
</span><span id="1-324">
</span><span id="1-325"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-326">
</span><span id="1-327">    <span class="k">def</span><span class="w"> </span><span class="nf">_memoized_attr_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-328">        <span class="n">annotations</span><span class="p">:</span> <span class="n">_AnnotationDict</span>
</span><span id="1-329">
</span><span id="1-330">        <span class="c1"># applies only to Proxy() as used by hybrid.</span>
</span><span id="1-331">        <span class="c1"># currently is an exception to typing rather than feeding through</span>
</span><span id="1-332">        <span class="c1"># non-string keys.</span>
</span><span id="1-333">        <span class="c1"># ideally Proxy() would have a separate set of methods to deal</span>
</span><span id="1-334">        <span class="c1"># with this case.</span>
</span><span id="1-335">        <span class="n">entity_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity_namespace</span>
</span><span id="1-336">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_namespace</span><span class="p">,</span> <span class="n">HasCacheKey</span><span class="p">)</span>
</span><span id="1-337">
</span><span id="1-338">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="n">_UNKNOWN_ATTR_KEY</span><span class="p">:</span>
</span><span id="1-339">            <span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;entity_namespace&quot;</span><span class="p">:</span> <span class="n">entity_namespace</span><span class="p">}</span>
</span><span id="1-340">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-341">            <span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-342">                <span class="s2">&quot;proxy_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span id="1-343">                <span class="s2">&quot;proxy_owner&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span id="1-344">                <span class="s2">&quot;entity_namespace&quot;</span><span class="p">:</span> <span class="n">entity_namespace</span><span class="p">,</span>
</span><span id="1-345">            <span class="p">}</span>
</span><span id="1-346">
</span><span id="1-347">        <span class="n">ce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
</span><span id="1-348">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-349">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-350">                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ce</span><span class="p">,</span> <span class="n">ColumnElement</span><span class="p">)</span>
</span><span id="1-351">            <span class="n">anno</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">_annotate</span>
</span><span id="1-352">        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">ae</span><span class="p">:</span>
</span><span id="1-353">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-354">                <span class="s1">&#39;When interpreting attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; as a SQL expression, &#39;</span>
</span><span id="1-355">                <span class="s2">&quot;expected __clause_element__() to return &quot;</span>
</span><span id="1-356">                <span class="s2">&quot;a ClauseElement object, got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ce</span><span class="p">)</span>
</span><span id="1-357">            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ae</span>
</span><span id="1-358">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-359">            <span class="k">return</span> <span class="n">anno</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
</span><span id="1-360">
</span><span id="1-361">    <span class="k">def</span><span class="w"> </span><span class="nf">_memoized_attr__propagate_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_PropagateAttrsType</span><span class="p">:</span>
</span><span id="1-362">        <span class="c1"># this suits the case in coercions where we don&#39;t actually</span>
</span><span id="1-363">        <span class="c1"># call ``__clause_element__()`` but still need to get</span>
</span><span id="1-364">        <span class="c1"># resolved._propagate_attrs.  See #6558.</span>
</span><span id="1-365">        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">(</span>
</span><span id="1-366">            <span class="p">{</span>
</span><span id="1-367">                <span class="s2">&quot;compile_state_plugin&quot;</span><span class="p">:</span> <span class="s2">&quot;orm&quot;</span><span class="p">,</span>
</span><span id="1-368">                <span class="s2">&quot;plugin_subject&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parentmapper</span><span class="p">,</span>
</span><span id="1-369">            <span class="p">}</span>
</span><span id="1-370">        <span class="p">)</span>
</span><span id="1-371">
</span><span id="1-372">    <span class="nd">@property</span>
</span><span id="1-373">    <span class="k">def</span><span class="w"> </span><span class="nf">_entity_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-374">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span>
</span><span id="1-375">
</span><span id="1-376">    <span class="nd">@property</span>
</span><span id="1-377">    <span class="k">def</span><span class="w"> </span><span class="nf">_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AnnotationDict</span><span class="p">:</span>
</span><span id="1-378">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span><span class="o">.</span><span class="n">_annotations</span>
</span><span id="1-379">
</span><span id="1-380">    <span class="k">def</span><span class="w"> </span><span class="nf">__clause_element__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]:</span>
</span><span id="1-381">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span>
</span><span id="1-382">
</span><span id="1-383">    <span class="nd">@property</span>
</span><span id="1-384">    <span class="k">def</span><span class="w"> </span><span class="nf">_from_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]:</span>
</span><span id="1-385">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">_from_objects</span>
</span><span id="1-386">
</span><span id="1-387">    <span class="k">def</span><span class="w"> </span><span class="nf">_bulk_update_tuples</span><span class="p">(</span>
</span><span id="1-388">        <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-389">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_DMLColumnArgument</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-390"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return setter tuples for a bulk UPDATE.&quot;&quot;&quot;</span>
</span><span id="1-391">
</span><span id="1-392">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">_bulk_update_tuples</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="1-393">
</span><span id="1-394">    <span class="k">def</span><span class="w"> </span><span class="nf">adapt_to_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adapt_to_entity</span><span class="p">:</span> <span class="n">AliasedInsp</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
</span><span id="1-395">        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span>
</span><span id="1-396">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
</span><span id="1-397">            <span class="n">adapt_to_entity</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span>
</span><span id="1-398">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span id="1-399">            <span class="n">impl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span>
</span><span id="1-400">            <span class="n">comparator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">adapt_to_entity</span><span class="p">(</span><span class="n">adapt_to_entity</span><span class="p">),</span>
</span><span id="1-401">            <span class="n">parententity</span><span class="o">=</span><span class="n">adapt_to_entity</span><span class="p">,</span>
</span><span id="1-402">        <span class="p">)</span>
</span><span id="1-403">
</span><span id="1-404">    <span class="k">def</span><span class="w"> </span><span class="nf">of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">_EntityType</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-405">        <span class="k">return</span> <span class="n">QueryableAttribute</span><span class="p">(</span>
</span><span id="1-406">            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span id="1-407">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span id="1-408">            <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span id="1-409">            <span class="n">impl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span>
</span><span id="1-410">            <span class="n">comparator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">entity</span><span class="p">),</span>
</span><span id="1-411">            <span class="n">of_type</span><span class="o">=</span><span class="n">inspection</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">entity</span><span class="p">),</span>
</span><span id="1-412">            <span class="n">extra_criteria</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span><span class="p">,</span>
</span><span id="1-413">        <span class="p">)</span>
</span><span id="1-414">
</span><span id="1-415">    <span class="k">def</span><span class="w"> </span><span class="nf">and_</span><span class="p">(</span>
</span><span id="1-416">        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">clauses</span><span class="p">:</span> <span class="n">_ColumnExpressionArgument</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
</span><span id="1-417">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
</span><span id="1-418">        <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-419">            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="o">.</span><span class="n">Comparator</span><span class="p">)</span>
</span><span id="1-420">
</span><span id="1-421">        <span class="n">exprs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span id="1-422">            <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">roles</span><span class="o">.</span><span class="n">WhereHavingRole</span><span class="p">,</span> <span class="n">clause</span><span class="p">)</span>
</span><span id="1-423">            <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">coerce_generator_arg</span><span class="p">(</span><span class="n">clauses</span><span class="p">)</span>
</span><span id="1-424">        <span class="p">)</span>
</span><span id="1-425">
</span><span id="1-426">        <span class="k">return</span> <span class="n">QueryableAttribute</span><span class="p">(</span>
</span><span id="1-427">            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span id="1-428">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span id="1-429">            <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span id="1-430">            <span class="n">impl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span>
</span><span id="1-431">            <span class="n">comparator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">exprs</span><span class="p">),</span>
</span><span id="1-432">            <span class="n">of_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span><span class="p">,</span>
</span><span id="1-433">            <span class="n">extra_criteria</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span> <span class="o">+</span> <span class="n">exprs</span><span class="p">,</span>
</span><span id="1-434">        <span class="p">)</span>
</span><span id="1-435">
</span><span id="1-436">    <span class="k">def</span><span class="w"> </span><span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-437">        <span class="k">return</span> <span class="n">QueryableAttribute</span><span class="p">(</span>
</span><span id="1-438">            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span id="1-439">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span id="1-440">            <span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">,</span>
</span><span id="1-441">            <span class="n">impl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span>
</span><span id="1-442">            <span class="n">comparator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">,</span>
</span><span id="1-443">            <span class="n">of_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_of_type</span><span class="p">,</span>
</span><span id="1-444">            <span class="n">extra_criteria</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra_criteria</span><span class="p">,</span>
</span><span id="1-445">        <span class="p">)</span>
</span><span id="1-446">
</span><span id="1-447">    <span class="k">def</span><span class="w"> </span><span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Label</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]:</span>
</span><span id="1-448">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="1-449">
</span><span id="1-450">    <span class="k">def</span><span class="w"> </span><span class="nf">operate</span><span class="p">(</span>
</span><span id="1-451">        <span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">OperatorType</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-452">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-453">        <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[no-any-return]  # noqa: E501</span>
</span><span id="1-454">
</span><span id="1-455">    <span class="k">def</span><span class="w"> </span><span class="nf">reverse_operate</span><span class="p">(</span>
</span><span id="1-456">        <span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">OperatorType</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-457">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnElement</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-458">        <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[no-any-return]  # noqa: E501</span>
</span><span id="1-459">
</span><span id="1-460">    <span class="k">def</span><span class="w"> </span><span class="nf">hasparent</span><span class="p">(</span>
</span><span id="1-461">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">optimistic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-462">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-463">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">hasparent</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">optimistic</span><span class="o">=</span><span class="n">optimistic</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
</span><span id="1-464">
</span><span id="1-465">    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-466">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-467">            <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">MemoizedSlots</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span id="1-468">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-469">            <span class="k">pass</span>
</span><span id="1-470">
</span><span id="1-471">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-472">            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span id="1-473">        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-474">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
</span><span id="1-475">                <span class="s2">&quot;Neither </span><span class="si">%r</span><span class="s2"> object nor </span><span class="si">%r</span><span class="s2"> object associated with </span><span class="si">%s</span><span class="s2"> &quot;</span>
</span><span id="1-476">                <span class="s2">&quot;has an attribute </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span id="1-477">                <span class="o">%</span> <span class="p">(</span>
</span><span id="1-478">                    <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="1-479">                    <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="1-480">                    <span class="bp">self</span><span class="p">,</span>
</span><span id="1-481">                    <span class="n">key</span><span class="p">,</span>
</span><span id="1-482">                <span class="p">)</span>
</span><span id="1-483">            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
</span><span id="1-484">
</span><span id="1-485">    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="1-486">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="1-487">
</span><span id="1-488">    <span class="k">def</span><span class="w"> </span><span class="nf">_memoized_attr_property</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MapperProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-489">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">property</span>
</span><span id="1-490">
</span><span id="1-491">
</span><span id="1-492"><span class="k">def</span><span class="w"> </span><span class="nf">_queryable_attribute_unreduce</span><span class="p">(</span>
</span><span id="1-493">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="1-494">    <span class="n">mapped_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-495">    <span class="n">parententity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-496">    <span class="n">entity</span><span class="p">:</span> <span class="n">_ExternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-497"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-498">    <span class="c1"># this method is only used in terms of the</span>
</span><span id="1-499">    <span class="c1"># sqlalchemy.ext.serializer extension</span>
</span><span id="1-500">    <span class="k">if</span> <span class="n">insp_is_aliased_class</span><span class="p">(</span><span class="n">parententity</span><span class="p">):</span>
</span><span id="1-501">        <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_get_from_serialized</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mapped_class</span><span class="p">,</span> <span class="n">parententity</span><span class="p">)</span>
</span><span id="1-502">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-503">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span id="1-504">
</span><span id="1-505">
</span><span id="1-506"><span class="k">class</span><span class="w"> </span><span class="nc">InstrumentedAttribute</span><span class="p">(</span><span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]):</span>
</span><span id="1-507"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class bound instrumented attribute which adds basic</span>
</span><span id="1-508"><span class="sd">    :term:`descriptor` methods.</span>
</span><span id="1-509">
</span><span id="1-510"><span class="sd">    See :class:`.QueryableAttribute` for a description of most features.</span>
</span><span id="1-511">
</span><span id="1-512">
</span><span id="1-513"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-514">
</span><span id="1-515">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="1-516">
</span><span id="1-517">    <span class="n">inherit_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-518"><span class="w">    </span><span class="sd">&quot;&quot;&quot;:meta private:&quot;&quot;&quot;</span>
</span><span id="1-519">
</span><span id="1-520">    <span class="c1"># hack to make __doc__ writeable on instances of</span>
</span><span id="1-521">    <span class="c1"># InstrumentedAttribute, while still keeping classlevel</span>
</span><span id="1-522">    <span class="c1"># __doc__ correct</span>
</span><span id="1-523">
</span><span id="1-524">    <span class="nd">@util</span><span class="o">.</span><span class="n">rw_hybridproperty</span>
</span><span id="1-525">    <span class="k">def</span><span class="w"> </span><span class="nf">__doc__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="1-526">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_doc</span>
</span><span id="1-527">
</span><span id="1-528">    <span class="nd">@__doc__</span><span class="o">.</span><span class="n">setter</span>  <span class="c1"># type: ignore</span>
</span><span id="1-529">    <span class="k">def</span><span class="w"> </span><span class="nf">__doc__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-530">        <span class="bp">self</span><span class="o">.</span><span class="n">_doc</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="1-531">
</span><span id="1-532">    <span class="nd">@__doc__</span><span class="o">.</span><span class="n">classlevel</span>  <span class="c1"># type: ignore</span>
</span><span id="1-533">    <span class="k">def</span><span class="w"> </span><span class="nf">__doc__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="1-534">        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span id="1-535">
</span><span id="1-536">    <span class="k">def</span><span class="w"> </span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-537">        <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="1-538">            <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="1-539">        <span class="p">)</span>
</span><span id="1-540">
</span><span id="1-541">    <span class="k">def</span><span class="w"> </span><span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-542">        <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
</span><span id="1-543">
</span><span id="1-544">    <span class="nd">@overload</span>
</span><span id="1-545">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span>
</span><span id="1-546">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-547">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-548">
</span><span id="1-549">    <span class="nd">@overload</span>
</span><span id="1-550">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T_co</span><span class="p">:</span> <span class="o">...</span>
</span><span id="1-551">
</span><span id="1-552">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span>
</span><span id="1-553">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-554">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T_co</span><span class="p">],</span> <span class="n">_T_co</span><span class="p">]:</span>
</span><span id="1-555">        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-556">            <span class="k">return</span> <span class="bp">self</span>
</span><span id="1-557">
</span><span id="1-558">        <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-559">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">supports_population</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span id="1-560">            <span class="k">return</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># type: ignore[no-any-return]</span>
</span><span id="1-561">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-562">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-563">                <span class="n">state</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-564">            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-565">                <span class="k">raise</span> <span class="n">orm_exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
</span><span id="1-566">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>  <span class="c1"># type: ignore[no-any-return]</span>
</span><span id="1-567">
</span><span id="1-568">
</span><span id="1-569"><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-570"><span class="k">class</span><span class="w"> </span><span class="nc">AdHocHasEntityNamespace</span><span class="p">(</span><span class="n">HasCacheKey</span><span class="p">):</span>
</span><span id="1-571">    <span class="n">_traverse_internals</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">_TraverseInternalsType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-572">        <span class="p">(</span><span class="s2">&quot;_entity_namespace&quot;</span><span class="p">,</span> <span class="n">InternalTraversal</span><span class="o">.</span><span class="n">dp_has_cache_key</span><span class="p">),</span>
</span><span id="1-573">    <span class="p">]</span>
</span><span id="1-574">
</span><span id="1-575">    <span class="c1"># py37 compat, no slots=True on dataclass</span>
</span><span id="1-576">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_entity_namespace&quot;</span><span class="p">,)</span>
</span><span id="1-577">    <span class="n">_entity_namespace</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-578">    <span class="n">is_mapper</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-579">    <span class="n">is_aliased_class</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-580">
</span><span id="1-581">    <span class="nd">@property</span>
</span><span id="1-582">    <span class="k">def</span><span class="w"> </span><span class="nf">entity_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-583">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity_namespace</span><span class="o">.</span><span class="n">entity_namespace</span>
</span><span id="1-584">
</span><span id="1-585">
</span><span id="1-586"><span class="k">def</span><span class="w"> </span><span class="nf">create_proxied_attribute</span><span class="p">(</span>
</span><span id="1-587">    <span class="n">descriptor</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-588"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-589"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an QueryableAttribute / user descriptor hybrid.</span>
</span><span id="1-590">
</span><span id="1-591"><span class="sd">    Returns a new QueryableAttribute type that delegates descriptor</span>
</span><span id="1-592"><span class="sd">    behavior and getattr() to the given descriptor.</span>
</span><span id="1-593"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-594">
</span><span id="1-595">    <span class="c1"># TODO: can move this to descriptor_props if the need for this</span>
</span><span id="1-596">    <span class="c1"># function is removed from ext/hybrid.py</span>
</span><span id="1-597">
</span><span id="1-598">    <span class="k">class</span><span class="w"> </span><span class="nc">Proxy</span><span class="p">(</span><span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">Any</span><span class="p">]):</span>
</span><span id="1-599"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Presents the :class:`.QueryableAttribute` interface as a</span>
</span><span id="1-600"><span class="sd">        proxy on top of a Python descriptor / :class:`.PropComparator`</span>
</span><span id="1-601"><span class="sd">        combination.</span>
</span><span id="1-602">
</span><span id="1-603"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-604">
</span><span id="1-605">        <span class="n">_extra_criteria</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="1-606">
</span><span id="1-607">        <span class="c1"># the attribute error catches inside of __getattr__ basically create a</span>
</span><span id="1-608">        <span class="c1"># singularity if you try putting slots on this too</span>
</span><span id="1-609">        <span class="c1"># __slots__ = (&quot;descriptor&quot;, &quot;original_property&quot;, &quot;_comparator&quot;)</span>
</span><span id="1-610">
</span><span id="1-611">        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-612">            <span class="bp">self</span><span class="p">,</span>
</span><span id="1-613">            <span class="n">class_</span><span class="p">,</span>
</span><span id="1-614">            <span class="n">key</span><span class="p">,</span>
</span><span id="1-615">            <span class="n">descriptor</span><span class="p">,</span>
</span><span id="1-616">            <span class="n">comparator</span><span class="p">,</span>
</span><span id="1-617">            <span class="n">adapt_to_entity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="1-618">            <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="1-619">            <span class="n">original_property</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="1-620">        <span class="p">):</span>
</span><span id="1-621">            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span> <span class="o">=</span> <span class="n">class_</span>
</span><span id="1-622">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
</span><span id="1-623">            <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span> <span class="o">=</span> <span class="n">descriptor</span>
</span><span id="1-624">            <span class="bp">self</span><span class="o">.</span><span class="n">original_property</span> <span class="o">=</span> <span class="n">original_property</span>
</span><span id="1-625">            <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span> <span class="o">=</span> <span class="n">comparator</span>
</span><span id="1-626">            <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span> <span class="o">=</span> <span class="n">adapt_to_entity</span>
</span><span id="1-627">            <span class="bp">self</span><span class="o">.</span><span class="n">_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>
</span><span id="1-628">
</span><span id="1-629">        <span class="nd">@property</span>
</span><span id="1-630">        <span class="k">def</span><span class="w"> </span><span class="nf">_parententity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-631">            <span class="k">return</span> <span class="n">inspection</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="n">raiseerr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="1-632">
</span><span id="1-633">        <span class="nd">@property</span>
</span><span id="1-634">        <span class="k">def</span><span class="w"> </span><span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-635">            <span class="k">return</span> <span class="n">inspection</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="n">raiseerr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="1-636">
</span><span id="1-637">        <span class="n">_is_internal_proxy</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-638">
</span><span id="1-639">        <span class="n">_cache_key_traversal</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-640">            <span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">ExtendedInternalTraversal</span><span class="o">.</span><span class="n">dp_string</span><span class="p">),</span>
</span><span id="1-641">            <span class="p">(</span><span class="s2">&quot;_parententity&quot;</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">ExtendedInternalTraversal</span><span class="o">.</span><span class="n">dp_multi</span><span class="p">),</span>
</span><span id="1-642">        <span class="p">]</span>
</span><span id="1-643">
</span><span id="1-644">        <span class="nd">@property</span>
</span><span id="1-645">        <span class="k">def</span><span class="w"> </span><span class="nf">_impl_uses_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-646">            <span class="k">return</span> <span class="p">(</span>
</span><span id="1-647">                <span class="bp">self</span><span class="o">.</span><span class="n">original_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-648">                <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">uses_objects</span>
</span><span id="1-649">            <span class="p">)</span>
</span><span id="1-650">
</span><span id="1-651">        <span class="nd">@property</span>
</span><span id="1-652">        <span class="k">def</span><span class="w"> </span><span class="nf">_entity_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-653">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="p">,</span> <span class="s2">&quot;_parententity&quot;</span><span class="p">):</span>
</span><span id="1-654">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">_parententity</span>
</span><span id="1-655">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-656">                <span class="c1"># used by hybrid attributes which try to remain</span>
</span><span id="1-657">                <span class="c1"># agnostic of any ORM concepts like mappers</span>
</span><span id="1-658">                <span class="k">return</span> <span class="n">AdHocHasEntityNamespace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parententity</span><span class="p">)</span>
</span><span id="1-659">
</span><span id="1-660">        <span class="nd">@property</span>
</span><span id="1-661">        <span class="k">def</span><span class="w"> </span><span class="nf">property</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-662">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">property</span>
</span><span id="1-663">
</span><span id="1-664">        <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span id="1-665">        <span class="k">def</span><span class="w"> </span><span class="nf">comparator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-666">            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="p">):</span>
</span><span id="1-667">                <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="p">()</span>
</span><span id="1-668">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span><span class="p">:</span>
</span><span id="1-669">                <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="o">.</span><span class="n">adapt_to_entity</span><span class="p">(</span>
</span><span id="1-670">                    <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span>
</span><span id="1-671">                <span class="p">)</span>
</span><span id="1-672">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span>
</span><span id="1-673">
</span><span id="1-674">        <span class="k">def</span><span class="w"> </span><span class="nf">adapt_to_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adapt_to_entity</span><span class="p">):</span>
</span><span id="1-675">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
</span><span id="1-676">                <span class="n">adapt_to_entity</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span>
</span><span id="1-677">                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span id="1-678">                <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="p">,</span>
</span><span id="1-679">                <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="p">,</span>
</span><span id="1-680">                <span class="n">adapt_to_entity</span><span class="p">,</span>
</span><span id="1-681">            <span class="p">)</span>
</span><span id="1-682">
</span><span id="1-683">        <span class="k">def</span><span class="w"> </span><span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span><span id="1-684">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
</span><span id="1-685">                <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span id="1-686">                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span id="1-687">                <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="p">,</span>
</span><span id="1-688">                <span class="bp">self</span><span class="o">.</span><span class="n">_comparator</span><span class="p">,</span>
</span><span id="1-689">                <span class="n">adapt_to_entity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_adapt_to_entity</span><span class="p">,</span>
</span><span id="1-690">                <span class="n">original_property</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">original_property</span><span class="p">,</span>
</span><span id="1-691">            <span class="p">)</span>
</span><span id="1-692">
</span><span id="1-693">        <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
</span><span id="1-694">            <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">)</span>
</span><span id="1-695">            <span class="c1"># detect if this is a plain Python @property, which just returns</span>
</span><span id="1-696">            <span class="c1"># itself for class level access.  If so, then return us.</span>
</span><span id="1-697">            <span class="c1"># Otherwise, return the object returned by the descriptor.</span>
</span><span id="1-698">            <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span> <span class="ow">and</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-699">                <span class="k">return</span> <span class="bp">self</span>
</span><span id="1-700">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-701">                <span class="k">return</span> <span class="n">retval</span>
</span><span id="1-702">
</span><span id="1-703">        <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="1-704">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="1-705">
</span><span id="1-706">        <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
</span><span id="1-707"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Delegate __getattr__ to the original descriptor and/or</span>
</span><span id="1-708"><span class="sd">            comparator.&quot;&quot;&quot;</span>
</span><span id="1-709">
</span><span id="1-710">            <span class="c1"># this is unfortunately very complicated, and is easily prone</span>
</span><span id="1-711">            <span class="c1"># to recursion overflows when implementations of related</span>
</span><span id="1-712">            <span class="c1"># __getattr__ schemes are changed</span>
</span><span id="1-713">
</span><span id="1-714">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-715">                <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">MemoizedSlots</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
</span><span id="1-716">            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-717">                <span class="k">pass</span>
</span><span id="1-718">
</span><span id="1-719">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-720">                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
</span><span id="1-721">            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-722">                <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="s2">&quot;comparator&quot;</span><span class="p">:</span>
</span><span id="1-723">                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;comparator&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
</span><span id="1-724">                <span class="k">try</span><span class="p">:</span>
</span><span id="1-725">                    <span class="c1"># comparator itself might be unreachable</span>
</span><span id="1-726">                    <span class="n">comparator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span>
</span><span id="1-727">                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err2</span><span class="p">:</span>
</span><span id="1-728">                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
</span><span id="1-729">                        <span class="s2">&quot;Neither </span><span class="si">%r</span><span class="s2"> object nor unconfigured comparator &quot;</span>
</span><span id="1-730">                        <span class="s2">&quot;object associated with </span><span class="si">%s</span><span class="s2"> has an attribute </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span id="1-731">                        <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
</span><span id="1-732">                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err2</span>
</span><span id="1-733">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-734">                    <span class="k">try</span><span class="p">:</span>
</span><span id="1-735">                        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">comparator</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
</span><span id="1-736">                    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err3</span><span class="p">:</span>
</span><span id="1-737">                        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
</span><span id="1-738">                            <span class="s2">&quot;Neither </span><span class="si">%r</span><span class="s2"> object nor </span><span class="si">%r</span><span class="s2"> object &quot;</span>
</span><span id="1-739">                            <span class="s2">&quot;associated with </span><span class="si">%s</span><span class="s2"> has an attribute </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span id="1-740">                            <span class="o">%</span> <span class="p">(</span>
</span><span id="1-741">                                <span class="nb">type</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="1-742">                                <span class="nb">type</span><span class="p">(</span><span class="n">comparator</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="1-743">                                <span class="bp">self</span><span class="p">,</span>
</span><span id="1-744">                                <span class="n">attribute</span><span class="p">,</span>
</span><span id="1-745">                            <span class="p">)</span>
</span><span id="1-746">                        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err3</span>
</span><span id="1-747">
</span><span id="1-748">    <span class="n">Proxy</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;Proxy&quot;</span>
</span><span id="1-749">
</span><span id="1-750">    <span class="n">util</span><span class="o">.</span><span class="n">monkeypatch_proxied_specials</span><span class="p">(</span>
</span><span id="1-751">        <span class="n">Proxy</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">descriptor</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;descriptor&quot;</span><span class="p">,</span> <span class="n">from_instance</span><span class="o">=</span><span class="n">descriptor</span>
</span><span id="1-752">    <span class="p">)</span>
</span><span id="1-753">    <span class="k">return</span> <span class="n">Proxy</span>
</span><span id="1-754">
</span><span id="1-755">
</span><span id="1-756"><span class="n">OP_REMOVE</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;REMOVE&quot;</span><span class="p">)</span>
</span><span id="1-757"><span class="n">OP_APPEND</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;APPEND&quot;</span><span class="p">)</span>
</span><span id="1-758"><span class="n">OP_REPLACE</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;REPLACE&quot;</span><span class="p">)</span>
</span><span id="1-759"><span class="n">OP_BULK_REPLACE</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;BULK_REPLACE&quot;</span><span class="p">)</span>
</span><span id="1-760"><span class="n">OP_MODIFIED</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;MODIFIED&quot;</span><span class="p">)</span>
</span><span id="1-761">
</span><span id="1-762">
</span><span id="1-763"><span class="k">class</span><span class="w"> </span><span class="nc">AttributeEventToken</span><span class="p">:</span>
</span><span id="1-764"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A token propagated throughout the course of a chain of attribute</span>
</span><span id="1-765"><span class="sd">    events.</span>
</span><span id="1-766">
</span><span id="1-767"><span class="sd">    Serves as an indicator of the source of the event and also provides</span>
</span><span id="1-768"><span class="sd">    a means of controlling propagation across a chain of attribute</span>
</span><span id="1-769"><span class="sd">    operations.</span>
</span><span id="1-770">
</span><span id="1-771"><span class="sd">    The :class:`.Event` object is sent as the ``initiator`` argument</span>
</span><span id="1-772"><span class="sd">    when dealing with events such as :meth:`.AttributeEvents.append`,</span>
</span><span id="1-773"><span class="sd">    :meth:`.AttributeEvents.set`,</span>
</span><span id="1-774"><span class="sd">    and :meth:`.AttributeEvents.remove`.</span>
</span><span id="1-775">
</span><span id="1-776"><span class="sd">    The :class:`.Event` object is currently interpreted by the backref</span>
</span><span id="1-777"><span class="sd">    event handlers, and is used to control the propagation of operations</span>
</span><span id="1-778"><span class="sd">    across two mutually-dependent attributes.</span>
</span><span id="1-779">
</span><span id="1-780"><span class="sd">    .. versionchanged:: 2.0  Changed the name from ``AttributeEvent``</span>
</span><span id="1-781"><span class="sd">       to ``AttributeEventToken``.</span>
</span><span id="1-782">
</span><span id="1-783"><span class="sd">    :attribute impl: The :class:`.AttributeImpl` which is the current event</span>
</span><span id="1-784"><span class="sd">     initiator.</span>
</span><span id="1-785">
</span><span id="1-786"><span class="sd">    :attribute op: The symbol :attr:`.OP_APPEND`, :attr:`.OP_REMOVE`,</span>
</span><span id="1-787"><span class="sd">     :attr:`.OP_REPLACE`, or :attr:`.OP_BULK_REPLACE`, indicating the</span>
</span><span id="1-788"><span class="sd">     source operation.</span>
</span><span id="1-789">
</span><span id="1-790"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-791">
</span><span id="1-792">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s2">&quot;impl&quot;</span><span class="p">,</span> <span class="s2">&quot;op&quot;</span><span class="p">,</span> <span class="s2">&quot;parent_token&quot;</span>
</span><span id="1-793">
</span><span id="1-794">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute_impl</span><span class="p">:</span> <span class="n">AttributeImpl</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">):</span>
</span><span id="1-795">        <span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">=</span> <span class="n">attribute_impl</span>
</span><span id="1-796">        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>
</span><span id="1-797">        <span class="bp">self</span><span class="o">.</span><span class="n">parent_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">parent_token</span>
</span><span id="1-798">
</span><span id="1-799">    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="1-800">        <span class="k">return</span> <span class="p">(</span>
</span><span id="1-801">            <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">AttributeEventToken</span><span class="p">)</span>
</span><span id="1-802">            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">impl</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span>
</span><span id="1-803">            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span>
</span><span id="1-804">        <span class="p">)</span>
</span><span id="1-805">
</span><span id="1-806">    <span class="nd">@property</span>
</span><span id="1-807">    <span class="k">def</span><span class="w"> </span><span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-808">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">key</span>
</span><span id="1-809">
</span><span id="1-810">    <span class="k">def</span><span class="w"> </span><span class="nf">hasparent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="1-811">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">hasparent</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-812">
</span><span id="1-813">
</span><span id="1-814"><span class="n">AttributeEvent</span> <span class="o">=</span> <span class="n">AttributeEventToken</span>  <span class="c1"># legacy</span>
</span><span id="1-815"><span class="n">Event</span> <span class="o">=</span> <span class="n">AttributeEventToken</span>  <span class="c1"># legacy</span>
</span><span id="1-816">
</span><span id="1-817">
</span><span id="1-818"><span class="k">class</span><span class="w"> </span><span class="nc">AttributeImpl</span><span class="p">:</span>
</span><span id="1-819"><span class="w">    </span><span class="sd">&quot;&quot;&quot;internal implementation for instrumented attributes.&quot;&quot;&quot;</span>
</span><span id="1-820">
</span><span id="1-821">    <span class="n">collection</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-822">    <span class="n">default_accepts_scalar_loader</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-823">    <span class="n">uses_objects</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-824">    <span class="n">supports_population</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-825">    <span class="n">dynamic</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-826">
</span><span id="1-827">    <span class="n">_is_has_collection_adapter</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-828">
</span><span id="1-829">    <span class="n">_replace_token</span><span class="p">:</span> <span class="n">AttributeEventToken</span>
</span><span id="1-830">    <span class="n">_remove_token</span><span class="p">:</span> <span class="n">AttributeEventToken</span>
</span><span id="1-831">    <span class="n">_append_token</span><span class="p">:</span> <span class="n">AttributeEventToken</span>
</span><span id="1-832">
</span><span id="1-833">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-834">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-835">        <span class="n">class_</span><span class="p">:</span> <span class="n">_ExternalEntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-836">        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="1-837">        <span class="n">callable_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_LoaderCallable</span><span class="p">],</span>
</span><span id="1-838">        <span class="n">dispatch</span><span class="p">:</span> <span class="n">_Dispatch</span><span class="p">[</span><span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span id="1-839">        <span class="n">trackparent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-840">        <span class="n">compare_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-841">        <span class="n">active_history</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-842">        <span class="n">parent_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-843">        <span class="n">load_on_unexpire</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-844">        <span class="n">send_modified_events</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-845">        <span class="n">accepts_scalar_loader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-846">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-847">    <span class="p">):</span>
</span><span id="1-848"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct an AttributeImpl.</span>
</span><span id="1-849">
</span><span id="1-850"><span class="sd">        :param \class_: associated class</span>
</span><span id="1-851">
</span><span id="1-852"><span class="sd">        :param key: string name of the attribute</span>
</span><span id="1-853">
</span><span id="1-854"><span class="sd">        :param \callable_:</span>
</span><span id="1-855"><span class="sd">          optional function which generates a callable based on a parent</span>
</span><span id="1-856"><span class="sd">          instance, which produces the &quot;default&quot; values for a scalar or</span>
</span><span id="1-857"><span class="sd">          collection attribute when it&#39;s first accessed, if not present</span>
</span><span id="1-858"><span class="sd">          already.</span>
</span><span id="1-859">
</span><span id="1-860"><span class="sd">        :param trackparent:</span>
</span><span id="1-861"><span class="sd">          if True, attempt to track if an instance has a parent attached</span>
</span><span id="1-862"><span class="sd">          to it via this attribute.</span>
</span><span id="1-863">
</span><span id="1-864"><span class="sd">        :param compare_function:</span>
</span><span id="1-865"><span class="sd">          a function that compares two values which are normally</span>
</span><span id="1-866"><span class="sd">          assignable to this attribute.</span>
</span><span id="1-867">
</span><span id="1-868"><span class="sd">        :param active_history:</span>
</span><span id="1-869"><span class="sd">          indicates that get_history() should always return the &quot;old&quot; value,</span>
</span><span id="1-870"><span class="sd">          even if it means executing a lazy callable upon attribute change.</span>
</span><span id="1-871">
</span><span id="1-872"><span class="sd">        :param parent_token:</span>
</span><span id="1-873"><span class="sd">          Usually references the MapperProperty, used as a key for</span>
</span><span id="1-874"><span class="sd">          the hasparent() function to identify an &quot;owning&quot; attribute.</span>
</span><span id="1-875"><span class="sd">          Allows multiple AttributeImpls to all match a single</span>
</span><span id="1-876"><span class="sd">          owner attribute.</span>
</span><span id="1-877">
</span><span id="1-878"><span class="sd">        :param load_on_unexpire:</span>
</span><span id="1-879"><span class="sd">          if False, don&#39;t include this attribute in a load-on-expired</span>
</span><span id="1-880"><span class="sd">          operation, i.e. the &quot;expired_attribute_loader&quot; process.</span>
</span><span id="1-881"><span class="sd">          The attribute can still be in the &quot;expired&quot; list and be</span>
</span><span id="1-882"><span class="sd">          considered to be &quot;expired&quot;.   Previously, this flag was called</span>
</span><span id="1-883"><span class="sd">          &quot;expire_missing&quot; and is only used by a deferred column</span>
</span><span id="1-884"><span class="sd">          attribute.</span>
</span><span id="1-885">
</span><span id="1-886"><span class="sd">        :param send_modified_events:</span>
</span><span id="1-887"><span class="sd">          if False, the InstanceState._modified_event method will have no</span>
</span><span id="1-888"><span class="sd">          effect; this means the attribute will never show up as changed in a</span>
</span><span id="1-889"><span class="sd">          history entry.</span>
</span><span id="1-890">
</span><span id="1-891"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-892">        <span class="bp">self</span><span class="o">.</span><span class="n">class_</span> <span class="o">=</span> <span class="n">class_</span>
</span><span id="1-893">        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
</span><span id="1-894">        <span class="bp">self</span><span class="o">.</span><span class="n">callable_</span> <span class="o">=</span> <span class="n">callable_</span>
</span><span id="1-895">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span> <span class="o">=</span> <span class="n">dispatch</span>
</span><span id="1-896">        <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span> <span class="o">=</span> <span class="n">trackparent</span>
</span><span id="1-897">        <span class="bp">self</span><span class="o">.</span><span class="n">parent_token</span> <span class="o">=</span> <span class="n">parent_token</span> <span class="ow">or</span> <span class="bp">self</span>
</span><span id="1-898">        <span class="bp">self</span><span class="o">.</span><span class="n">send_modified_events</span> <span class="o">=</span> <span class="n">send_modified_events</span>
</span><span id="1-899">        <span class="k">if</span> <span class="n">compare_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-900">            <span class="bp">self</span><span class="o">.</span><span class="n">is_equal</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">eq</span>
</span><span id="1-901">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-902">            <span class="bp">self</span><span class="o">.</span><span class="n">is_equal</span> <span class="o">=</span> <span class="n">compare_function</span>
</span><span id="1-903">
</span><span id="1-904">        <span class="k">if</span> <span class="n">accepts_scalar_loader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-905">            <span class="bp">self</span><span class="o">.</span><span class="n">accepts_scalar_loader</span> <span class="o">=</span> <span class="n">accepts_scalar_loader</span>
</span><span id="1-906">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-907">            <span class="bp">self</span><span class="o">.</span><span class="n">accepts_scalar_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_accepts_scalar_loader</span>
</span><span id="1-908">
</span><span id="1-909">        <span class="n">_deferred_history</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_deferred_history&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="1-910">        <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_history</span> <span class="o">=</span> <span class="n">_deferred_history</span>
</span><span id="1-911">
</span><span id="1-912">        <span class="k">if</span> <span class="n">active_history</span><span class="p">:</span>
</span><span id="1-913">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-914">
</span><span id="1-915">        <span class="bp">self</span><span class="o">.</span><span class="n">load_on_unexpire</span> <span class="o">=</span> <span class="n">load_on_unexpire</span>
</span><span id="1-916">        <span class="bp">self</span><span class="o">.</span><span class="n">_modified_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_MODIFIED</span><span class="p">)</span>
</span><span id="1-917">
</span><span id="1-918">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-919">        <span class="s2">&quot;class_&quot;</span><span class="p">,</span>
</span><span id="1-920">        <span class="s2">&quot;key&quot;</span><span class="p">,</span>
</span><span id="1-921">        <span class="s2">&quot;callable_&quot;</span><span class="p">,</span>
</span><span id="1-922">        <span class="s2">&quot;dispatch&quot;</span><span class="p">,</span>
</span><span id="1-923">        <span class="s2">&quot;trackparent&quot;</span><span class="p">,</span>
</span><span id="1-924">        <span class="s2">&quot;parent_token&quot;</span><span class="p">,</span>
</span><span id="1-925">        <span class="s2">&quot;send_modified_events&quot;</span><span class="p">,</span>
</span><span id="1-926">        <span class="s2">&quot;is_equal&quot;</span><span class="p">,</span>
</span><span id="1-927">        <span class="s2">&quot;load_on_unexpire&quot;</span><span class="p">,</span>
</span><span id="1-928">        <span class="s2">&quot;_modified_token&quot;</span><span class="p">,</span>
</span><span id="1-929">        <span class="s2">&quot;accepts_scalar_loader&quot;</span><span class="p">,</span>
</span><span id="1-930">        <span class="s2">&quot;_deferred_history&quot;</span><span class="p">,</span>
</span><span id="1-931">    <span class="p">)</span>
</span><span id="1-932">
</span><span id="1-933">    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="1-934">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="1-935">
</span><span id="1-936">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_active_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-937"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Backwards compat for impl.active_history&quot;&quot;&quot;</span>
</span><span id="1-938">
</span><span id="1-939">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span>
</span><span id="1-940">
</span><span id="1-941">    <span class="k">def</span><span class="w"> </span><span class="nf">_set_active_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="1-942">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="1-943">
</span><span id="1-944">    <span class="n">active_history</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_active_history</span><span class="p">,</span> <span class="n">_set_active_history</span><span class="p">)</span>
</span><span id="1-945">
</span><span id="1-946">    <span class="k">def</span><span class="w"> </span><span class="nf">hasparent</span><span class="p">(</span>
</span><span id="1-947">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">optimistic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-948">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-949"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the boolean value of a `hasparent` flag attached to</span>
</span><span id="1-950"><span class="sd">        the given state.</span>
</span><span id="1-951">
</span><span id="1-952"><span class="sd">        The `optimistic` flag determines what the default return value</span>
</span><span id="1-953"><span class="sd">        should be if no `hasparent` flag can be located.</span>
</span><span id="1-954">
</span><span id="1-955"><span class="sd">        As this function is used to determine if an instance is an</span>
</span><span id="1-956"><span class="sd">        *orphan*, instances that were loaded from storage should be</span>
</span><span id="1-957"><span class="sd">        assumed to not be orphans, until a True/False value for this</span>
</span><span id="1-958"><span class="sd">        flag is set.</span>
</span><span id="1-959">
</span><span id="1-960"><span class="sd">        An instance attribute that is loaded by a callable function</span>
</span><span id="1-961"><span class="sd">        will also not have a `hasparent` flag.</span>
</span><span id="1-962">
</span><span id="1-963"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-964">        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;This AttributeImpl is not configured to track parents.&quot;</span>
</span><span id="1-965">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span><span class="p">,</span> <span class="n">msg</span>
</span><span id="1-966">
</span><span id="1-967">        <span class="k">return</span> <span class="p">(</span>
</span><span id="1-968">            <span class="n">state</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_token</span><span class="p">),</span> <span class="n">optimistic</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
</span><span id="1-969">        <span class="p">)</span>
</span><span id="1-970">
</span><span id="1-971">    <span class="k">def</span><span class="w"> </span><span class="nf">sethasparent</span><span class="p">(</span>
</span><span id="1-972">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-973">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-974">        <span class="n">parent_state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-975">        <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="1-976">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-977"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a boolean flag on the given item corresponding to</span>
</span><span id="1-978"><span class="sd">        whether or not it is attached to a parent object via the</span>
</span><span id="1-979"><span class="sd">        attribute represented by this ``InstrumentedAttribute``.</span>
</span><span id="1-980">
</span><span id="1-981"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-982">        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;This AttributeImpl is not configured to track parents.&quot;</span>
</span><span id="1-983">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span><span class="p">,</span> <span class="n">msg</span>
</span><span id="1-984">
</span><span id="1-985">        <span class="n">id_</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_token</span><span class="p">)</span>
</span><span id="1-986">        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
</span><span id="1-987">            <span class="n">state</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_state</span>
</span><span id="1-988">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-989">            <span class="k">if</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
</span><span id="1-990">                <span class="n">last_parent</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span>
</span><span id="1-991">
</span><span id="1-992">                <span class="k">if</span> <span class="p">(</span>
</span><span id="1-993">                    <span class="n">last_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
</span><span id="1-994">                    <span class="ow">and</span> <span class="n">last_parent</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">parent_state</span><span class="o">.</span><span class="n">key</span>
</span><span id="1-995">                <span class="p">):</span>
</span><span id="1-996">                    <span class="k">if</span> <span class="n">last_parent</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-997">                        <span class="k">raise</span> <span class="n">orm_exc</span><span class="o">.</span><span class="n">StaleDataError</span><span class="p">(</span>
</span><span id="1-998">                            <span class="s2">&quot;Removing state </span><span class="si">%s</span><span class="s2"> from parent &quot;</span>
</span><span id="1-999">                            <span class="s2">&quot;state </span><span class="si">%s</span><span class="s2"> along attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span>
</span><span id="1-1000">                            <span class="s2">&quot;but the parent record &quot;</span>
</span><span id="1-1001">                            <span class="s2">&quot;has gone stale, can&#39;t be sure this &quot;</span>
</span><span id="1-1002">                            <span class="s2">&quot;is the most recent parent.&quot;</span>
</span><span id="1-1003">                            <span class="o">%</span> <span class="p">(</span>
</span><span id="1-1004">                                <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
</span><span id="1-1005">                                <span class="n">state_str</span><span class="p">(</span><span class="n">parent_state</span><span class="p">),</span>
</span><span id="1-1006">                                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span id="1-1007">                            <span class="p">)</span>
</span><span id="1-1008">                        <span class="p">)</span>
</span><span id="1-1009">
</span><span id="1-1010">                    <span class="k">return</span>
</span><span id="1-1011">
</span><span id="1-1012">            <span class="n">state</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1013">
</span><span id="1-1014">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span id="1-1015">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1016">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1017">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1018">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1019">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-1020">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span id="1-1021">
</span><span id="1-1022">    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_pending</span><span class="p">(</span>
</span><span id="1-1023">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1024">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1025">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1026">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">,</span>
</span><span id="1-1027">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AllPendingType</span><span class="p">:</span>
</span><span id="1-1028"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of tuples of (state, obj)</span>
</span><span id="1-1029"><span class="sd">        for all objects in this attribute&#39;s current state</span>
</span><span id="1-1030"><span class="sd">        + history.</span>
</span><span id="1-1031">
</span><span id="1-1032"><span class="sd">        Only applies to object-based attributes.</span>
</span><span id="1-1033">
</span><span id="1-1034"><span class="sd">        This is an inlining of existing functionality</span>
</span><span id="1-1035"><span class="sd">        which roughly corresponds to:</span>
</span><span id="1-1036">
</span><span id="1-1037"><span class="sd">            get_state_history(</span>
</span><span id="1-1038"><span class="sd">                        state,</span>
</span><span id="1-1039"><span class="sd">                        key,</span>
</span><span id="1-1040"><span class="sd">                        passive=PASSIVE_NO_INITIALIZE).sum()</span>
</span><span id="1-1041">
</span><span id="1-1042"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1043">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span id="1-1044">
</span><span id="1-1045">    <span class="k">def</span><span class="w"> </span><span class="nf">_default_value</span><span class="p">(</span>
</span><span id="1-1046">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span>
</span><span id="1-1047">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1048"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce an empty value for an uninitialized scalar attribute.&quot;&quot;&quot;</span>
</span><span id="1-1049">
</span><span id="1-1050">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">,</span> <span class="p">(</span>
</span><span id="1-1051">            <span class="s2">&quot;_default_value should only be invoked for an &quot;</span>
</span><span id="1-1052">            <span class="s2">&quot;uninitialized or expired attribute&quot;</span>
</span><span id="1-1053">        <span class="p">)</span>
</span><span id="1-1054">
</span><span id="1-1055">        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1056">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">init_scalar</span><span class="p">:</span>
</span><span id="1-1057">            <span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span id="1-1058">            <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ATTR_EMPTY</span><span class="p">:</span>
</span><span id="1-1059">                <span class="n">value</span> <span class="o">=</span> <span class="n">ret</span>
</span><span id="1-1060">
</span><span id="1-1061">        <span class="k">return</span> <span class="n">value</span>
</span><span id="1-1062">
</span><span id="1-1063">    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
</span><span id="1-1064">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1065">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1066">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1067">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1068">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1069"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a value from the given object.</span>
</span><span id="1-1070"><span class="sd">        If a callable is assembled on this object&#39;s attribute, and</span>
</span><span id="1-1071"><span class="sd">        passive is False, the callable will be executed and the</span>
</span><span id="1-1072"><span class="sd">        resulting value will be set as the new value for this attribute.</span>
</span><span id="1-1073"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1074">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span id="1-1075">            <span class="k">return</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1076">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1077">            <span class="c1"># if history present, don&#39;t load</span>
</span><span id="1-1078">            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
</span><span id="1-1079">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1080">                <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span>
</span><span id="1-1081">                <span class="ow">or</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="n">NO_VALUE</span>
</span><span id="1-1082">            <span class="p">):</span>
</span><span id="1-1083">                <span class="k">if</span> <span class="ow">not</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">CALLABLES_OK</span><span class="p">:</span>
</span><span id="1-1084">                    <span class="k">return</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span id="1-1085">
</span><span id="1-1086">                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fire_loader_callables</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span id="1-1087">
</span><span id="1-1088">                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span id="1-1089">                    <span class="k">return</span> <span class="n">value</span>
</span><span id="1-1090">                <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">ATTR_WAS_SET</span><span class="p">:</span>
</span><span id="1-1091">                    <span class="k">try</span><span class="p">:</span>
</span><span id="1-1092">                        <span class="k">return</span> <span class="n">dict_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1093">                    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-1094">                        <span class="c1"># TODO: no test coverage here.</span>
</span><span id="1-1095">                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
</span><span id="1-1096">                            <span class="s2">&quot;Deferred loader for attribute &quot;</span>
</span><span id="1-1097">                            <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> failed to populate &quot;</span>
</span><span id="1-1098">                            <span class="s2">&quot;correctly&quot;</span> <span class="o">%</span> <span class="n">key</span>
</span><span id="1-1099">                        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
</span><span id="1-1100">                <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ATTR_EMPTY</span><span class="p">:</span>
</span><span id="1-1101">                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_committed_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-1102">
</span><span id="1-1103">            <span class="k">if</span> <span class="ow">not</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">INIT_OK</span><span class="p">:</span>
</span><span id="1-1104">                <span class="k">return</span> <span class="n">NO_VALUE</span>
</span><span id="1-1105">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1106">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span id="1-1107">
</span><span id="1-1108">    <span class="k">def</span><span class="w"> </span><span class="nf">_fire_loader_callables</span><span class="p">(</span>
</span><span id="1-1109">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span>
</span><span id="1-1110">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1111">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1112">            <span class="bp">self</span><span class="o">.</span><span class="n">accepts_scalar_loader</span>
</span><span id="1-1113">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_on_unexpire</span>
</span><span id="1-1114">            <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">expired_attributes</span>
</span><span id="1-1115">        <span class="p">):</span>
</span><span id="1-1116">            <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">_load_expired</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span id="1-1117">        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">callables</span><span class="p">:</span>
</span><span id="1-1118">            <span class="n">callable_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">callables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1119">            <span class="k">return</span> <span class="n">callable_</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span id="1-1120">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">callable_</span><span class="p">:</span>
</span><span id="1-1121">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callable_</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span id="1-1122">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1123">            <span class="k">return</span> <span class="n">ATTR_EMPTY</span>
</span><span id="1-1124">
</span><span id="1-1125">    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span>
</span><span id="1-1126">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1127">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1128">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1129">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1130">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1131">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1132">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1133">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span id="1-1134">
</span><span id="1-1135">    <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span>
</span><span id="1-1136">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1137">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1138">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1139">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1140">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1141">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1142">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1143">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="1-1144">            <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">,</span> <span class="n">check_old</span><span class="o">=</span><span class="n">value</span>
</span><span id="1-1145">        <span class="p">)</span>
</span><span id="1-1146">
</span><span id="1-1147">    <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span>
</span><span id="1-1148">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1149">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1150">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1151">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1152">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1153">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1154">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1155">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="1-1156">            <span class="n">state</span><span class="p">,</span>
</span><span id="1-1157">            <span class="n">dict_</span><span class="p">,</span>
</span><span id="1-1158">            <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1159">            <span class="n">initiator</span><span class="p">,</span>
</span><span id="1-1160">            <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">,</span>
</span><span id="1-1161">            <span class="n">check_old</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
</span><span id="1-1162">            <span class="n">pop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-1163">        <span class="p">)</span>
</span><span id="1-1164">
</span><span id="1-1165">    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
</span><span id="1-1166">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1167">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1168">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1169">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1170">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1171">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1172">        <span class="n">check_old</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1173">        <span class="n">pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-1174">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1175">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span id="1-1176">
</span><span id="1-1177">    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1178">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span id="1-1179">
</span><span id="1-1180">    <span class="k">def</span><span class="w"> </span><span class="nf">get_committed_value</span><span class="p">(</span>
</span><span id="1-1181">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1182">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1183">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1184">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1185">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1186"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return the unchanged value of this attribute&quot;&quot;&quot;</span>
</span><span id="1-1187">
</span><span id="1-1188">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">:</span>
</span><span id="1-1189">            <span class="n">value</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1190">            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span id="1-1191">                <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-1192">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1193">                <span class="k">return</span> <span class="n">value</span>
</span><span id="1-1194">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1195">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span id="1-1196">
</span><span id="1-1197">    <span class="k">def</span><span class="w"> </span><span class="nf">set_committed_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="1-1198"><span class="w">        </span><span class="sd">&quot;&quot;&quot;set an attribute value on the given instance and &#39;commit&#39; it.&quot;&quot;&quot;</span>
</span><span id="1-1199">
</span><span id="1-1200">        <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="1-1201">        <span class="n">state</span><span class="o">.</span><span class="n">_commit</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">])</span>
</span><span id="1-1202">        <span class="k">return</span> <span class="n">value</span>
</span><span id="1-1203">
</span><span id="1-1204">
</span><span id="1-1205"><span class="k">class</span><span class="w"> </span><span class="nc">ScalarAttributeImpl</span><span class="p">(</span><span class="n">AttributeImpl</span><span class="p">):</span>
</span><span id="1-1206"><span class="w">    </span><span class="sd">&quot;&quot;&quot;represents a scalar value-holding InstrumentedAttribute.&quot;&quot;&quot;</span>
</span><span id="1-1207">
</span><span id="1-1208">    <span class="n">default_accepts_scalar_loader</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1209">    <span class="n">uses_objects</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1210">    <span class="n">supports_population</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1211">    <span class="n">collection</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1212">    <span class="n">dynamic</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1213">
</span><span id="1-1214">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s2">&quot;_replace_token&quot;</span><span class="p">,</span> <span class="s2">&quot;_append_token&quot;</span><span class="p">,</span> <span class="s2">&quot;_remove_token&quot;</span>
</span><span id="1-1215">
</span><span id="1-1216">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span><span id="1-1217">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="1-1218">        <span class="bp">self</span><span class="o">.</span><span class="n">_replace_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span>
</span><span id="1-1219">            <span class="bp">self</span><span class="p">,</span> <span class="n">OP_REPLACE</span>
</span><span id="1-1220">        <span class="p">)</span>
</span><span id="1-1221">        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_REMOVE</span><span class="p">)</span>
</span><span id="1-1222">
</span><span id="1-1223">    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1224">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span><span class="p">:</span>
</span><span id="1-1225">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">PASSIVE_RETURN_NO_VALUE</span><span class="p">)</span>
</span><span id="1-1226">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1227">            <span class="n">old</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">)</span>
</span><span id="1-1228">
</span><span id="1-1229">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
</span><span id="1-1230">            <span class="bp">self</span><span class="o">.</span><span class="n">fire_remove_event</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span><span class="p">)</span>
</span><span id="1-1231">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>
</span><span id="1-1232">
</span><span id="1-1233">        <span class="n">existing</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">)</span>
</span><span id="1-1234">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1235">            <span class="n">existing</span> <span class="ow">is</span> <span class="n">NO_VALUE</span>
</span><span id="1-1236">            <span class="ow">and</span> <span class="n">old</span> <span class="ow">is</span> <span class="n">NO_VALUE</span>
</span><span id="1-1237">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">expired</span>
</span><span id="1-1238">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">expired_attributes</span>
</span><span id="1-1239">        <span class="p">):</span>
</span><span id="1-1240">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> object does not have a value&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="1-1241">
</span><span id="1-1242">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span id="1-1243">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1244">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1245">        <span class="n">dict_</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="1-1246">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1247">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-1248">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span id="1-1249">            <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_scalar_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">])</span>
</span><span id="1-1250">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">:</span>
</span><span id="1-1251">            <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_scalar_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">)</span>
</span><span id="1-1252">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1253">            <span class="k">if</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">INIT_OK</span><span class="p">:</span>
</span><span id="1-1254">                <span class="n">passive</span> <span class="o">^=</span> <span class="n">INIT_OK</span>
</span><span id="1-1255">            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span id="1-1256">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span id="1-1257">                <span class="k">return</span> <span class="n">HISTORY_BLANK</span>
</span><span id="1-1258">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1259">                <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_scalar_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
</span><span id="1-1260">
</span><span id="1-1261">    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
</span><span id="1-1262">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1263">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1264">        <span class="n">dict_</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="1-1265">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1266">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1267">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1268">        <span class="n">check_old</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1269">        <span class="n">pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-1270">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1271">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span><span class="p">:</span>
</span><span id="1-1272">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">PASSIVE_RETURN_NO_VALUE</span><span class="p">)</span>
</span><span id="1-1273">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1274">            <span class="n">old</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">)</span>
</span><span id="1-1275">
</span><span id="1-1276">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">set</span><span class="p">:</span>
</span><span id="1-1277">            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fire_replace_event</span><span class="p">(</span>
</span><span id="1-1278">                <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">initiator</span>
</span><span id="1-1279">            <span class="p">)</span>
</span><span id="1-1280">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>
</span><span id="1-1281">        <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="1-1282">
</span><span id="1-1283">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_replace_event</span><span class="p">(</span>
</span><span id="1-1284">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1285">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1286">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1287">        <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span>
</span><span id="1-1288">        <span class="n">previous</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1289">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1290">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span id="1-1291">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">set</span><span class="p">:</span>
</span><span id="1-1292">            <span class="n">value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span>
</span><span id="1-1293">                <span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">previous</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace_token</span>
</span><span id="1-1294">            <span class="p">)</span>
</span><span id="1-1295">        <span class="k">return</span> <span class="n">value</span>
</span><span id="1-1296">
</span><span id="1-1297">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_remove_event</span><span class="p">(</span>
</span><span id="1-1298">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1299">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1300">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1301">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1302">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1303">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1304">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
</span><span id="1-1305">            <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span><span class="p">)</span>
</span><span id="1-1306">
</span><span id="1-1307">
</span><span id="1-1308"><span class="k">class</span><span class="w"> </span><span class="nc">ScalarObjectAttributeImpl</span><span class="p">(</span><span class="n">ScalarAttributeImpl</span><span class="p">):</span>
</span><span id="1-1309"><span class="w">    </span><span class="sd">&quot;&quot;&quot;represents a scalar-holding InstrumentedAttribute,</span>
</span><span id="1-1310"><span class="sd">    where the target object is also instrumented.</span>
</span><span id="1-1311">
</span><span id="1-1312"><span class="sd">    Adds events to delete/set operations.</span>
</span><span id="1-1313">
</span><span id="1-1314"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-1315">
</span><span id="1-1316">    <span class="n">default_accepts_scalar_loader</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1317">    <span class="n">uses_objects</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1318">    <span class="n">supports_population</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1319">    <span class="n">collection</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1320">
</span><span id="1-1321">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="1-1322">
</span><span id="1-1323">    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1324">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span><span class="p">:</span>
</span><span id="1-1325">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-1326">                <span class="n">state</span><span class="p">,</span>
</span><span id="1-1327">                <span class="n">dict_</span><span class="p">,</span>
</span><span id="1-1328">                <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_ONLY_PERSISTENT</span>
</span><span id="1-1329">                <span class="o">|</span> <span class="n">NO_AUTOFLUSH</span>
</span><span id="1-1330">                <span class="o">|</span> <span class="n">LOAD_AGAINST_COMMITTED</span><span class="p">,</span>
</span><span id="1-1331">            <span class="p">)</span>
</span><span id="1-1332">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1333">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-1334">                <span class="n">state</span><span class="p">,</span>
</span><span id="1-1335">                <span class="n">dict_</span><span class="p">,</span>
</span><span id="1-1336">                <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span> <span class="o">^</span> <span class="n">INIT_OK</span>
</span><span id="1-1337">                <span class="o">|</span> <span class="n">LOAD_AGAINST_COMMITTED</span>
</span><span id="1-1338">                <span class="o">|</span> <span class="n">NO_RAISE</span><span class="p">,</span>
</span><span id="1-1339">            <span class="p">)</span>
</span><span id="1-1340">
</span><span id="1-1341">        <span class="bp">self</span><span class="o">.</span><span class="n">fire_remove_event</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span><span class="p">)</span>
</span><span id="1-1342">
</span><span id="1-1343">        <span class="n">existing</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">)</span>
</span><span id="1-1344">
</span><span id="1-1345">        <span class="c1"># if the attribute is expired, we currently have no way to tell</span>
</span><span id="1-1346">        <span class="c1"># that an object-attribute was expired vs. not loaded.   So</span>
</span><span id="1-1347">        <span class="c1"># for this test, we look to see if the object has a DB identity.</span>
</span><span id="1-1348">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1349">            <span class="n">existing</span> <span class="ow">is</span> <span class="n">NO_VALUE</span>
</span><span id="1-1350">            <span class="ow">and</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span id="1-1351">            <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-1352">        <span class="p">):</span>
</span><span id="1-1353">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> object does not have a value&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="1-1354">
</span><span id="1-1355">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span id="1-1356">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1357">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1358">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1359">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1360">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-1361">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span id="1-1362">            <span class="n">current</span> <span class="o">=</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1363">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1364">            <span class="k">if</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">INIT_OK</span><span class="p">:</span>
</span><span id="1-1365">                <span class="n">passive</span> <span class="o">^=</span> <span class="n">INIT_OK</span>
</span><span id="1-1366">            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span id="1-1367">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span id="1-1368">                <span class="k">return</span> <span class="n">HISTORY_BLANK</span>
</span><span id="1-1369">
</span><span id="1-1370">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_history</span><span class="p">:</span>
</span><span id="1-1371">            <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_object_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
</span><span id="1-1372">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1373">            <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">_NO_HISTORY</span><span class="p">)</span>
</span><span id="1-1374">            <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span id="1-1375">                <span class="n">loader_passive</span> <span class="o">=</span> <span class="n">passive</span> <span class="o">|</span> <span class="p">(</span>
</span><span id="1-1376">                    <span class="n">PASSIVE_ONLY_PERSISTENT</span>
</span><span id="1-1377">                    <span class="o">|</span> <span class="n">NO_AUTOFLUSH</span>
</span><span id="1-1378">                    <span class="o">|</span> <span class="n">LOAD_AGAINST_COMMITTED</span>
</span><span id="1-1379">                    <span class="o">|</span> <span class="n">NO_RAISE</span>
</span><span id="1-1380">                    <span class="o">|</span> <span class="n">DEFERRED_HISTORY_LOAD</span>
</span><span id="1-1381">                <span class="p">)</span>
</span><span id="1-1382">                <span class="n">original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fire_loader_callables</span><span class="p">(</span>
</span><span id="1-1383">                    <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">loader_passive</span>
</span><span id="1-1384">                <span class="p">)</span>
</span><span id="1-1385">            <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_object_attribute</span><span class="p">(</span>
</span><span id="1-1386">                <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">original</span><span class="o">=</span><span class="n">original</span>
</span><span id="1-1387">            <span class="p">)</span>
</span><span id="1-1388">
</span><span id="1-1389">    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_pending</span><span class="p">(</span>
</span><span id="1-1390">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1391">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1392">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1393">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">,</span>
</span><span id="1-1394">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AllPendingType</span><span class="p">:</span>
</span><span id="1-1395">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span id="1-1396">            <span class="n">current</span> <span class="o">=</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1397">        <span class="k">elif</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">CALLABLES_OK</span><span class="p">:</span>
</span><span id="1-1398">            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span id="1-1399">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1400">            <span class="k">return</span> <span class="p">[]</span>
</span><span id="1-1401">
</span><span id="1-1402">        <span class="n">ret</span><span class="p">:</span> <span class="n">_AllPendingType</span>
</span><span id="1-1403">
</span><span id="1-1404">        <span class="c1"># can&#39;t use __hash__(), can&#39;t use __eq__() here</span>
</span><span id="1-1405">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1406">            <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1407">            <span class="ow">and</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span id="1-1408">            <span class="ow">and</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span>
</span><span id="1-1409">        <span class="p">):</span>
</span><span id="1-1410">            <span class="n">ret</span> <span class="o">=</span> <span class="p">[(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">current</span><span class="p">)]</span>
</span><span id="1-1411">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1412">            <span class="n">ret</span> <span class="o">=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
</span><span id="1-1413">
</span><span id="1-1414">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">:</span>
</span><span id="1-1415">            <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1416">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1417">                <span class="n">original</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1418">                <span class="ow">and</span> <span class="n">original</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span id="1-1419">                <span class="ow">and</span> <span class="n">original</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span>
</span><span id="1-1420">                <span class="ow">and</span> <span class="n">original</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">current</span>
</span><span id="1-1421">            <span class="p">):</span>
</span><span id="1-1422">                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">instance_state</span><span class="p">(</span><span class="n">original</span><span class="p">),</span> <span class="n">original</span><span class="p">))</span>
</span><span id="1-1423">        <span class="k">return</span> <span class="n">ret</span>
</span><span id="1-1424">
</span><span id="1-1425">    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
</span><span id="1-1426">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1427">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1428">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1429">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1430">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1431">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1432">        <span class="n">check_old</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1433">        <span class="n">pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-1434">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1435"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a value on the given InstanceState.&quot;&quot;&quot;</span>
</span><span id="1-1436">
</span><span id="1-1437">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_active_history</span><span class="p">:</span>
</span><span id="1-1438">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-1439">                <span class="n">state</span><span class="p">,</span>
</span><span id="1-1440">                <span class="n">dict_</span><span class="p">,</span>
</span><span id="1-1441">                <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_ONLY_PERSISTENT</span>
</span><span id="1-1442">                <span class="o">|</span> <span class="n">NO_AUTOFLUSH</span>
</span><span id="1-1443">                <span class="o">|</span> <span class="n">LOAD_AGAINST_COMMITTED</span><span class="p">,</span>
</span><span id="1-1444">            <span class="p">)</span>
</span><span id="1-1445">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1446">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-1447">                <span class="n">state</span><span class="p">,</span>
</span><span id="1-1448">                <span class="n">dict_</span><span class="p">,</span>
</span><span id="1-1449">                <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span> <span class="o">^</span> <span class="n">INIT_OK</span>
</span><span id="1-1450">                <span class="o">|</span> <span class="n">LOAD_AGAINST_COMMITTED</span>
</span><span id="1-1451">                <span class="o">|</span> <span class="n">NO_RAISE</span><span class="p">,</span>
</span><span id="1-1452">            <span class="p">)</span>
</span><span id="1-1453">
</span><span id="1-1454">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1455">            <span class="n">check_old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1456">            <span class="ow">and</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span id="1-1457">            <span class="ow">and</span> <span class="n">check_old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">old</span>
</span><span id="1-1458">        <span class="p">):</span>
</span><span id="1-1459">            <span class="k">if</span> <span class="n">pop</span><span class="p">:</span>
</span><span id="1-1460">                <span class="k">return</span>
</span><span id="1-1461">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1462">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="1-1463">                    <span class="s2">&quot;Object </span><span class="si">%s</span><span class="s2"> not associated with </span><span class="si">%s</span><span class="s2"> on attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
</span><span id="1-1464">                    <span class="o">%</span> <span class="p">(</span><span class="n">instance_str</span><span class="p">(</span><span class="n">check_old</span><span class="p">),</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-1465">                <span class="p">)</span>
</span><span id="1-1466">
</span><span id="1-1467">        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fire_replace_event</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">initiator</span><span class="p">)</span>
</span><span id="1-1468">        <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="1-1469">
</span><span id="1-1470">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_remove_event</span><span class="p">(</span>
</span><span id="1-1471">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1472">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1473">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1474">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1475">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1476">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1477">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="1-1478">            <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1479">            <span class="n">PASSIVE_NO_RESULT</span><span class="p">,</span>
</span><span id="1-1480">            <span class="n">NO_VALUE</span><span class="p">,</span>
</span><span id="1-1481">        <span class="p">):</span>
</span><span id="1-1482">            <span class="bp">self</span><span class="o">.</span><span class="n">sethasparent</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="1-1483">
</span><span id="1-1484">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
</span><span id="1-1485">            <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span><span class="p">)</span>
</span><span id="1-1486">
</span><span id="1-1487">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-1488">
</span><span id="1-1489">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_replace_event</span><span class="p">(</span>
</span><span id="1-1490">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1491">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1492">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1493">        <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span>
</span><span id="1-1494">        <span class="n">previous</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1495">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1496">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span id="1-1497">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span><span class="p">:</span>
</span><span id="1-1498">            <span class="k">if</span> <span class="n">previous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">previous</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="1-1499">                <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1500">                <span class="n">PASSIVE_NO_RESULT</span><span class="p">,</span>
</span><span id="1-1501">                <span class="n">NO_VALUE</span><span class="p">,</span>
</span><span id="1-1502">            <span class="p">):</span>
</span><span id="1-1503">                <span class="bp">self</span><span class="o">.</span><span class="n">sethasparent</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">previous</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="1-1504">
</span><span id="1-1505">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">set</span><span class="p">:</span>
</span><span id="1-1506">            <span class="n">value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span>
</span><span id="1-1507">                <span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">previous</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace_token</span>
</span><span id="1-1508">            <span class="p">)</span>
</span><span id="1-1509">
</span><span id="1-1510">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="1-1511">
</span><span id="1-1512">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span><span class="p">:</span>
</span><span id="1-1513">            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1514">                <span class="bp">self</span><span class="o">.</span><span class="n">sethasparent</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="1-1515">
</span><span id="1-1516">        <span class="k">return</span> <span class="n">value</span>
</span><span id="1-1517">
</span><span id="1-1518">
</span><span id="1-1519"><span class="k">class</span><span class="w"> </span><span class="nc">HasCollectionAdapter</span><span class="p">:</span>
</span><span id="1-1520">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="1-1521">
</span><span id="1-1522">    <span class="n">collection</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-1523">    <span class="n">_is_has_collection_adapter</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1524">
</span><span id="1-1525">    <span class="k">def</span><span class="w"> </span><span class="nf">_dispose_previous_collection</span><span class="p">(</span>
</span><span id="1-1526">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1527">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1528">        <span class="n">collection</span><span class="p">:</span> <span class="n">_AdaptedCollectionProtocol</span><span class="p">,</span>
</span><span id="1-1529">        <span class="n">adapter</span><span class="p">:</span> <span class="n">CollectionAdapter</span><span class="p">,</span>
</span><span id="1-1530">        <span class="n">fire_event</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="1-1531">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1532">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span id="1-1533">
</span><span id="1-1534">    <span class="nd">@overload</span>
</span><span id="1-1535">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span id="1-1536">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1537">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1538">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1539">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1540">        <span class="n">passive</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1541">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span> <span class="o">...</span>
</span><span id="1-1542">
</span><span id="1-1543">    <span class="nd">@overload</span>
</span><span id="1-1544">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span id="1-1545">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1546">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1547">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1548">        <span class="n">user_data</span><span class="p">:</span> <span class="n">_AdaptedCollectionProtocol</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1549">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1550">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span> <span class="o">...</span>
</span><span id="1-1551">
</span><span id="1-1552">    <span class="nd">@overload</span>
</span><span id="1-1553">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span id="1-1554">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1555">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1556">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1557">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AdaptedCollectionProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1558">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1559">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="1-1560">        <span class="n">Literal</span><span class="p">[</span><span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">],</span> <span class="n">CollectionAdapter</span>
</span><span id="1-1561">    <span class="p">]:</span> <span class="o">...</span>
</span><span id="1-1562">
</span><span id="1-1563">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span id="1-1564">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1565">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1566">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1567">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AdaptedCollectionProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1568">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1569">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="1-1570">        <span class="n">Literal</span><span class="p">[</span><span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">],</span> <span class="n">CollectionAdapter</span>
</span><span id="1-1571">    <span class="p">]:</span>
</span><span id="1-1572">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span id="1-1573">
</span><span id="1-1574">    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
</span><span id="1-1575">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1576">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1577">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1578">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1579">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1580">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1581">        <span class="n">check_old</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1582">        <span class="n">pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-1583">        <span class="n">_adapt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-1584">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1585">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span id="1-1586">
</span><span id="1-1587">
</span><span id="1-1588"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-1589">
</span><span id="1-1590">    <span class="k">def</span><span class="w"> </span><span class="nf">_is_collection_attribute_impl</span><span class="p">(</span>
</span><span id="1-1591">        <span class="n">impl</span><span class="p">:</span> <span class="n">AttributeImpl</span><span class="p">,</span>
</span><span id="1-1592">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="n">CollectionAttributeImpl</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-1593">
</span><span id="1-1594"><span class="k">else</span><span class="p">:</span>
</span><span id="1-1595">    <span class="n">_is_collection_attribute_impl</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;collection&quot;</span><span class="p">)</span>
</span><span id="1-1596">
</span><span id="1-1597">
</span><span id="1-1598"><span class="k">class</span><span class="w"> </span><span class="nc">CollectionAttributeImpl</span><span class="p">(</span><span class="n">HasCollectionAdapter</span><span class="p">,</span> <span class="n">AttributeImpl</span><span class="p">):</span>
</span><span id="1-1599"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A collection-holding attribute that instruments changes in membership.</span>
</span><span id="1-1600">
</span><span id="1-1601"><span class="sd">    Only handles collections of instrumented objects.</span>
</span><span id="1-1602">
</span><span id="1-1603"><span class="sd">    InstrumentedCollectionAttribute holds an arbitrary, user-specified</span>
</span><span id="1-1604"><span class="sd">    container object (defaulting to a list) and brokers access to the</span>
</span><span id="1-1605"><span class="sd">    CollectionAdapter, a &quot;view&quot; onto that object that presents consistent bag</span>
</span><span id="1-1606"><span class="sd">    semantics to the orm layer independent of the user data implementation.</span>
</span><span id="1-1607">
</span><span id="1-1608"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-1609">
</span><span id="1-1610">    <span class="n">uses_objects</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1611">    <span class="n">collection</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1612">    <span class="n">default_accepts_scalar_loader</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1613">    <span class="n">supports_population</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1614">    <span class="n">dynamic</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1615">
</span><span id="1-1616">    <span class="n">_bulk_replace_token</span><span class="p">:</span> <span class="n">AttributeEventToken</span>
</span><span id="1-1617">
</span><span id="1-1618">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1619">        <span class="s2">&quot;copy&quot;</span><span class="p">,</span>
</span><span id="1-1620">        <span class="s2">&quot;collection_factory&quot;</span><span class="p">,</span>
</span><span id="1-1621">        <span class="s2">&quot;_append_token&quot;</span><span class="p">,</span>
</span><span id="1-1622">        <span class="s2">&quot;_remove_token&quot;</span><span class="p">,</span>
</span><span id="1-1623">        <span class="s2">&quot;_bulk_replace_token&quot;</span><span class="p">,</span>
</span><span id="1-1624">        <span class="s2">&quot;_duck_typed_as&quot;</span><span class="p">,</span>
</span><span id="1-1625">    <span class="p">)</span>
</span><span id="1-1626">
</span><span id="1-1627">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-1628">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1629">        <span class="n">class_</span><span class="p">,</span>
</span><span id="1-1630">        <span class="n">key</span><span class="p">,</span>
</span><span id="1-1631">        <span class="n">callable_</span><span class="p">,</span>
</span><span id="1-1632">        <span class="n">dispatch</span><span class="p">,</span>
</span><span id="1-1633">        <span class="n">typecallable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="1-1634">        <span class="n">trackparent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="1-1635">        <span class="n">copy_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="1-1636">        <span class="n">compare_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="1-1637">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="1-1638">    <span class="p">):</span>
</span><span id="1-1639">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-1640">            <span class="n">class_</span><span class="p">,</span>
</span><span id="1-1641">            <span class="n">key</span><span class="p">,</span>
</span><span id="1-1642">            <span class="n">callable_</span><span class="p">,</span>
</span><span id="1-1643">            <span class="n">dispatch</span><span class="p">,</span>
</span><span id="1-1644">            <span class="n">trackparent</span><span class="o">=</span><span class="n">trackparent</span><span class="p">,</span>
</span><span id="1-1645">            <span class="n">compare_function</span><span class="o">=</span><span class="n">compare_function</span><span class="p">,</span>
</span><span id="1-1646">            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="1-1647">        <span class="p">)</span>
</span><span id="1-1648">
</span><span id="1-1649">        <span class="k">if</span> <span class="n">copy_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1650">            <span class="n">copy_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__copy</span>
</span><span id="1-1651">        <span class="bp">self</span><span class="o">.</span><span class="n">copy</span> <span class="o">=</span> <span class="n">copy_function</span>
</span><span id="1-1652">        <span class="bp">self</span><span class="o">.</span><span class="n">collection_factory</span> <span class="o">=</span> <span class="n">typecallable</span>
</span><span id="1-1653">        <span class="bp">self</span><span class="o">.</span><span class="n">_append_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_APPEND</span><span class="p">)</span>
</span><span id="1-1654">        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_REMOVE</span><span class="p">)</span>
</span><span id="1-1655">        <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_replace_token</span> <span class="o">=</span> <span class="n">AttributeEventToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_BULK_REPLACE</span><span class="p">)</span>
</span><span id="1-1656">        <span class="bp">self</span><span class="o">.</span><span class="n">_duck_typed_as</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">duck_type_collection</span><span class="p">(</span>
</span><span id="1-1657">            <span class="bp">self</span><span class="o">.</span><span class="n">collection_factory</span><span class="p">()</span>
</span><span id="1-1658">        <span class="p">)</span>
</span><span id="1-1659">
</span><span id="1-1660">        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_factory</span><span class="p">,</span> <span class="s2">&quot;_sa_linker&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="1-1661">
</span><span id="1-1662">            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;init_collection&quot;</span><span class="p">)</span>
</span><span id="1-1663">            <span class="k">def</span><span class="w"> </span><span class="nf">link</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">collection_adapter</span><span class="p">):</span>
</span><span id="1-1664">                <span class="n">collection</span><span class="o">.</span><span class="n">_sa_linker</span><span class="p">(</span><span class="n">collection_adapter</span><span class="p">)</span>
</span><span id="1-1665">
</span><span id="1-1666">            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dispose_collection&quot;</span><span class="p">)</span>
</span><span id="1-1667">            <span class="k">def</span><span class="w"> </span><span class="nf">unlink</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">collection_adapter</span><span class="p">):</span>
</span><span id="1-1668">                <span class="n">collection</span><span class="o">.</span><span class="n">_sa_linker</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="1-1669">
</span><span id="1-1670">    <span class="k">def</span><span class="w"> </span><span class="nf">__copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span><span id="1-1671">        <span class="k">return</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">collections</span><span class="o">.</span><span class="n">collection_adapter</span><span class="p">(</span><span class="n">item</span><span class="p">)]</span>
</span><span id="1-1672">
</span><span id="1-1673">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span id="1-1674">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1675">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1676">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1677">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1678">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-1679">        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span id="1-1680">
</span><span id="1-1681">        <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span id="1-1682">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1683">                <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">INCLUDE_PENDING_MUTATIONS</span>
</span><span id="1-1684">                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">_pending_mutations</span>
</span><span id="1-1685">            <span class="p">):</span>
</span><span id="1-1686">                <span class="n">pending</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">_pending_mutations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1687">                <span class="k">return</span> <span class="n">pending</span><span class="o">.</span><span class="n">merge_with_history</span><span class="p">(</span><span class="n">HISTORY_BLANK</span><span class="p">)</span>
</span><span id="1-1688">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1689">                <span class="k">return</span> <span class="n">HISTORY_BLANK</span>
</span><span id="1-1690">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1691">            <span class="k">if</span> <span class="n">passive</span> <span class="o">&amp;</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">INCLUDE_PENDING_MUTATIONS</span><span class="p">:</span>
</span><span id="1-1692">                <span class="c1"># this collection is loaded / present.  should not be any</span>
</span><span id="1-1693">                <span class="c1"># pending mutations</span>
</span><span id="1-1694">                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">_pending_mutations</span>
</span><span id="1-1695">
</span><span id="1-1696">            <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">from_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
</span><span id="1-1697">
</span><span id="1-1698">    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_pending</span><span class="p">(</span>
</span><span id="1-1699">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1700">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1701">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1702">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">,</span>
</span><span id="1-1703">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AllPendingType</span><span class="p">:</span>
</span><span id="1-1704">        <span class="c1"># NOTE: passive is ignored here at the moment</span>
</span><span id="1-1705">
</span><span id="1-1706">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span id="1-1707">            <span class="k">return</span> <span class="p">[]</span>
</span><span id="1-1708">
</span><span id="1-1709">        <span class="n">current</span> <span class="o">=</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1710">        <span class="n">current</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s2">&quot;_sa_adapter&quot;</span><span class="p">)</span>
</span><span id="1-1711">
</span><span id="1-1712">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">:</span>
</span><span id="1-1713">            <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1714">            <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span id="1-1715">                <span class="n">current_states</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-1716">                    <span class="p">((</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span id="1-1717">                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">current</span>
</span><span id="1-1718">                <span class="p">]</span>
</span><span id="1-1719">                <span class="n">original_states</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-1720">                    <span class="p">((</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span id="1-1721">                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">original</span>
</span><span id="1-1722">                <span class="p">]</span>
</span><span id="1-1723">
</span><span id="1-1724">                <span class="n">current_set</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">current_states</span><span class="p">)</span>
</span><span id="1-1725">                <span class="n">original_set</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">original_states</span><span class="p">)</span>
</span><span id="1-1726">
</span><span id="1-1727">                <span class="k">return</span> <span class="p">(</span>
</span><span id="1-1728">                    <span class="p">[</span>
</span><span id="1-1729">                        <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
</span><span id="1-1730">                        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">current_states</span>
</span><span id="1-1731">                        <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_set</span>
</span><span id="1-1732">                    <span class="p">]</span>
</span><span id="1-1733">                    <span class="o">+</span> <span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">current_states</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">original_set</span><span class="p">]</span>
</span><span id="1-1734">                    <span class="o">+</span> <span class="p">[</span>
</span><span id="1-1735">                        <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
</span><span id="1-1736">                        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">original_states</span>
</span><span id="1-1737">                        <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_set</span>
</span><span id="1-1738">                    <span class="p">]</span>
</span><span id="1-1739">                <span class="p">)</span>
</span><span id="1-1740">
</span><span id="1-1741">        <span class="k">return</span> <span class="p">[(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">current</span><span class="p">]</span>
</span><span id="1-1742">
</span><span id="1-1743">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_append_event</span><span class="p">(</span>
</span><span id="1-1744">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1745">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1746">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1747">        <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span>
</span><span id="1-1748">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1749">        <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1750">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span id="1-1751">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">append</span><span class="p">:</span>
</span><span id="1-1752">            <span class="n">value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-1753">
</span><span id="1-1754">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="1-1755">
</span><span id="1-1756">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1757">            <span class="bp">self</span><span class="o">.</span><span class="n">sethasparent</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="1-1758">
</span><span id="1-1759">        <span class="k">return</span> <span class="n">value</span>
</span><span id="1-1760">
</span><span id="1-1761">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_append_wo_mutation_event</span><span class="p">(</span>
</span><span id="1-1762">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1763">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1764">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1765">        <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span>
</span><span id="1-1766">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1767">        <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1768">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span id="1-1769">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">append_wo_mutation</span><span class="p">:</span>
</span><span id="1-1770">            <span class="n">value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-1771">
</span><span id="1-1772">        <span class="k">return</span> <span class="n">value</span>
</span><span id="1-1773">
</span><span id="1-1774">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_pre_remove_event</span><span class="p">(</span>
</span><span id="1-1775">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1776">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1777">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1778">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1779">        <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1780">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1781"><span class="w">        </span><span class="sd">&quot;&quot;&quot;A special event used for pop() operations.</span>
</span><span id="1-1782">
</span><span id="1-1783"><span class="sd">        The &quot;remove&quot; event needs to have the item to be removed passed to</span>
</span><span id="1-1784"><span class="sd">        it, which in the case of pop from a set, we don&#39;t have a way to access</span>
</span><span id="1-1785"><span class="sd">        the item before the operation.   the event is used for all pop()</span>
</span><span id="1-1786"><span class="sd">        operations (even though set.pop is the one where it is really needed).</span>
</span><span id="1-1787">
</span><span id="1-1788"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1789">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="1-1790">
</span><span id="1-1791">    <span class="k">def</span><span class="w"> </span><span class="nf">fire_remove_event</span><span class="p">(</span>
</span><span id="1-1792">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1793">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1794">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1795">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1796">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1797">        <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1798">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1799">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackparent</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1800">            <span class="bp">self</span><span class="o">.</span><span class="n">sethasparent</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="1-1801">
</span><span id="1-1802">        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
</span><span id="1-1803">            <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-1804">
</span><span id="1-1805">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="1-1806">
</span><span id="1-1807">    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1808">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
</span><span id="1-1809">            <span class="k">return</span>
</span><span id="1-1810">
</span><span id="1-1811">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="1-1812">
</span><span id="1-1813">        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span>
</span><span id="1-1814">        <span class="n">collection</span><span class="o">.</span><span class="n">clear_with_event</span><span class="p">()</span>
</span><span id="1-1815">
</span><span id="1-1816">        <span class="c1"># key is always present because we checked above.  e.g.</span>
</span><span id="1-1817">        <span class="c1"># del is a no-op if collection not present.</span>
</span><span id="1-1818">        <span class="k">del</span> <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1819">
</span><span id="1-1820">    <span class="k">def</span><span class="w"> </span><span class="nf">_default_value</span><span class="p">(</span>
</span><span id="1-1821">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span>
</span><span id="1-1822">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AdaptedCollectionProtocol</span><span class="p">:</span>
</span><span id="1-1823"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce an empty collection for an un-initialized attribute&quot;&quot;&quot;</span>
</span><span id="1-1824">
</span><span id="1-1825">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">,</span> <span class="p">(</span>
</span><span id="1-1826">            <span class="s2">&quot;_default_value should only be invoked for an &quot;</span>
</span><span id="1-1827">            <span class="s2">&quot;uninitialized or expired attribute&quot;</span>
</span><span id="1-1828">        <span class="p">)</span>
</span><span id="1-1829">
</span><span id="1-1830">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">_empty_collections</span><span class="p">:</span>
</span><span id="1-1831">            <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">_empty_collections</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1832">
</span><span id="1-1833">        <span class="n">adapter</span><span class="p">,</span> <span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_collection</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-1834">        <span class="n">adapter</span><span class="o">.</span><span class="n">_set_empty</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
</span><span id="1-1835">        <span class="k">return</span> <span class="n">user_data</span>
</span><span id="1-1836">
</span><span id="1-1837">    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_collection</span><span class="p">(</span>
</span><span id="1-1838">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-1839">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">CollectionAdapter</span><span class="p">,</span> <span class="n">_AdaptedCollectionProtocol</span><span class="p">]:</span>
</span><span id="1-1840">        <span class="n">adapter</span><span class="p">,</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">initialize_collection</span><span class="p">(</span>
</span><span id="1-1841">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_factory</span>
</span><span id="1-1842">        <span class="p">)</span>
</span><span id="1-1843">
</span><span id="1-1844">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">init_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">adapter</span><span class="p">)</span>
</span><span id="1-1845">
</span><span id="1-1846">        <span class="k">return</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">collection</span>
</span><span id="1-1847">
</span><span id="1-1848">    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span>
</span><span id="1-1849">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1850">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1851">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1852">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1853">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1854">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1855">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1856">        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span>
</span><span id="1-1857">            <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span>
</span><span id="1-1858">        <span class="p">)</span>
</span><span id="1-1859">        <span class="k">if</span> <span class="n">collection</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span id="1-1860">            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fire_append_event</span><span class="p">(</span>
</span><span id="1-1861">                <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">NO_KEY</span>
</span><span id="1-1862">            <span class="p">)</span>
</span><span id="1-1863">            <span class="k">assert</span> <span class="p">(</span>
</span><span id="1-1864">                <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span>
</span><span id="1-1865">            <span class="p">),</span> <span class="s2">&quot;Collection was loaded during event handling.&quot;</span>
</span><span id="1-1866">            <span class="n">state</span><span class="o">.</span><span class="n">_get_pending_mutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="1-1867">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1868">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-1869">                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">CollectionAdapter</span><span class="p">)</span>
</span><span id="1-1870">            <span class="n">collection</span><span class="o">.</span><span class="n">append_with_event</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">)</span>
</span><span id="1-1871">
</span><span id="1-1872">    <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span>
</span><span id="1-1873">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1874">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1875">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1876">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1877">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1878">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1879">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1880">        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span>
</span><span id="1-1881">            <span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span>
</span><span id="1-1882">        <span class="p">)</span>
</span><span id="1-1883">        <span class="k">if</span> <span class="n">collection</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span id="1-1884">            <span class="bp">self</span><span class="o">.</span><span class="n">fire_remove_event</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">NO_KEY</span><span class="p">)</span>
</span><span id="1-1885">            <span class="k">assert</span> <span class="p">(</span>
</span><span id="1-1886">                <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span>
</span><span id="1-1887">            <span class="p">),</span> <span class="s2">&quot;Collection was loaded during event handling.&quot;</span>
</span><span id="1-1888">            <span class="n">state</span><span class="o">.</span><span class="n">_get_pending_mutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="1-1889">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1890">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-1891">                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">CollectionAdapter</span><span class="p">)</span>
</span><span id="1-1892">            <span class="n">collection</span><span class="o">.</span><span class="n">remove_with_event</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">)</span>
</span><span id="1-1893">
</span><span id="1-1894">    <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span>
</span><span id="1-1895">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1896">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1897">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1898">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1899">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">],</span>
</span><span id="1-1900">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1901">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1902">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-1903">            <span class="c1"># TODO: better solution here would be to add</span>
</span><span id="1-1904">            <span class="c1"># a &quot;popper&quot; role to collections.py to complement</span>
</span><span id="1-1905">            <span class="c1"># &quot;remover&quot;.</span>
</span><span id="1-1906">            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span id="1-1907">        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
</span><span id="1-1908">            <span class="k">pass</span>
</span><span id="1-1909">
</span><span id="1-1910">    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
</span><span id="1-1911">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1912">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1913">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-1914">        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1915">        <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1916">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-1917">        <span class="n">check_old</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1918">        <span class="n">pop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-1919">        <span class="n">_adapt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-1920">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1921">        <span class="n">iterable</span> <span class="o">=</span> <span class="n">orig_iterable</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="1-1922">        <span class="n">new_keys</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1923">
</span><span id="1-1924">        <span class="c1"># pulling a new collection first so that an adaptation exception does</span>
</span><span id="1-1925">        <span class="c1"># not trigger a lazy load of the old collection.</span>
</span><span id="1-1926">        <span class="n">new_collection</span><span class="p">,</span> <span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_collection</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-1927">        <span class="k">if</span> <span class="n">_adapt</span><span class="p">:</span>
</span><span id="1-1928">            <span class="k">if</span> <span class="n">new_collection</span><span class="o">.</span><span class="n">_converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1929">                <span class="n">iterable</span> <span class="o">=</span> <span class="n">new_collection</span><span class="o">.</span><span class="n">_converter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span><span id="1-1930">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1931">                <span class="n">setting_type</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">duck_type_collection</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span><span id="1-1932">                <span class="n">receiving_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duck_typed_as</span>
</span><span id="1-1933">
</span><span id="1-1934">                <span class="k">if</span> <span class="n">setting_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">receiving_type</span><span class="p">:</span>
</span><span id="1-1935">                    <span class="n">given</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1936">                        <span class="n">iterable</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-1937">                        <span class="ow">and</span> <span class="s2">&quot;None&quot;</span>
</span><span id="1-1938">                        <span class="ow">or</span> <span class="n">iterable</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="1-1939">                    <span class="p">)</span>
</span><span id="1-1940">                    <span class="n">wanted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duck_typed_as</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="1-1941">                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="1-1942">                        <span class="s2">&quot;Incompatible collection type: </span><span class="si">%s</span><span class="s2"> is not </span><span class="si">%s</span><span class="s2">-like&quot;</span>
</span><span id="1-1943">                        <span class="o">%</span> <span class="p">(</span><span class="n">given</span><span class="p">,</span> <span class="n">wanted</span><span class="p">)</span>
</span><span id="1-1944">                    <span class="p">)</span>
</span><span id="1-1945">
</span><span id="1-1946">                <span class="c1"># If the object is an adapted collection, return the (iterable)</span>
</span><span id="1-1947">                <span class="c1"># adapter.</span>
</span><span id="1-1948">                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="s2">&quot;_sa_iterator&quot;</span><span class="p">):</span>
</span><span id="1-1949">                    <span class="n">iterable</span> <span class="o">=</span> <span class="n">iterable</span><span class="o">.</span><span class="n">_sa_iterator</span><span class="p">()</span>
</span><span id="1-1950">                <span class="k">elif</span> <span class="n">setting_type</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="1-1951">                    <span class="n">new_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span><span id="1-1952">                    <span class="n">iterable</span> <span class="o">=</span> <span class="n">iterable</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="1-1953">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-1954">                    <span class="n">iterable</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span><span id="1-1955">        <span class="k">elif</span> <span class="n">util</span><span class="o">.</span><span class="n">duck_type_collection</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="1-1956">            <span class="n">new_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="1-1957">
</span><span id="1-1958">        <span class="n">new_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</span><span id="1-1959">
</span><span id="1-1960">        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_replace_token</span>
</span><span id="1-1961">
</span><span id="1-1962">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">bulk_replace</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">new_values</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">new_keys</span><span class="p">)</span>
</span><span id="1-1963">
</span><span id="1-1964">        <span class="c1"># propagate NO_RAISE in passive through to the get() for the</span>
</span><span id="1-1965">        <span class="c1"># existing object (ticket #8862)</span>
</span><span id="1-1966">        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-1967">            <span class="n">state</span><span class="p">,</span>
</span><span id="1-1968">            <span class="n">dict_</span><span class="p">,</span>
</span><span id="1-1969">            <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_ONLY_PERSISTENT</span> <span class="o">^</span> <span class="p">(</span><span class="n">passive</span> <span class="o">&amp;</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">NO_RAISE</span><span class="p">),</span>
</span><span id="1-1970">        <span class="p">)</span>
</span><span id="1-1971">        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span id="1-1972">            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span id="1-1973">        <span class="k">elif</span> <span class="n">old</span> <span class="ow">is</span> <span class="n">orig_iterable</span><span class="p">:</span>
</span><span id="1-1974">            <span class="c1"># ignore re-assignment of the current collection, as happens</span>
</span><span id="1-1975">            <span class="c1"># implicitly with in-place operators (foo.collection |= other)</span>
</span><span id="1-1976">            <span class="k">return</span>
</span><span id="1-1977">
</span><span id="1-1978">        <span class="c1"># place a copy of &quot;old&quot; in state.committed_state</span>
</span><span id="1-1979">        <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="1-1980">
</span><span id="1-1981">        <span class="n">old_collection</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">_sa_adapter</span>
</span><span id="1-1982">
</span><span id="1-1983">        <span class="n">dict_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_data</span>
</span><span id="1-1984">
</span><span id="1-1985">        <span class="n">collections</span><span class="o">.</span><span class="n">bulk_replace</span><span class="p">(</span>
</span><span id="1-1986">            <span class="n">new_values</span><span class="p">,</span> <span class="n">old_collection</span><span class="p">,</span> <span class="n">new_collection</span><span class="p">,</span> <span class="n">initiator</span><span class="o">=</span><span class="n">evt</span>
</span><span id="1-1987">        <span class="p">)</span>
</span><span id="1-1988">
</span><span id="1-1989">        <span class="bp">self</span><span class="o">.</span><span class="n">_dispose_previous_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">old_collection</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="1-1990">
</span><span id="1-1991">    <span class="k">def</span><span class="w"> </span><span class="nf">_dispose_previous_collection</span><span class="p">(</span>
</span><span id="1-1992">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1993">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1994">        <span class="n">collection</span><span class="p">:</span> <span class="n">_AdaptedCollectionProtocol</span><span class="p">,</span>
</span><span id="1-1995">        <span class="n">adapter</span><span class="p">:</span> <span class="n">CollectionAdapter</span><span class="p">,</span>
</span><span id="1-1996">        <span class="n">fire_event</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="1-1997">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1998">        <span class="k">del</span> <span class="n">collection</span><span class="o">.</span><span class="n">_sa_adapter</span>
</span><span id="1-1999">
</span><span id="1-2000">        <span class="c1"># discarding old collection make sure it is not referenced in empty</span>
</span><span id="1-2001">        <span class="c1"># collections.</span>
</span><span id="1-2002">        <span class="n">state</span><span class="o">.</span><span class="n">_empty_collections</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-2003">        <span class="k">if</span> <span class="n">fire_event</span><span class="p">:</span>
</span><span id="1-2004">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">dispose_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">adapter</span><span class="p">)</span>
</span><span id="1-2005">
</span><span id="1-2006">    <span class="k">def</span><span class="w"> </span><span class="nf">_invalidate_collection</span><span class="p">(</span>
</span><span id="1-2007">        <span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="n">_AdaptedCollectionProtocol</span>
</span><span id="1-2008">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2009">        <span class="n">adapter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;_sa_adapter&quot;</span><span class="p">)</span>
</span><span id="1-2010">        <span class="n">adapter</span><span class="o">.</span><span class="n">invalidated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-2011">
</span><span id="1-2012">    <span class="k">def</span><span class="w"> </span><span class="nf">set_committed_value</span><span class="p">(</span>
</span><span id="1-2013">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-2014">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AdaptedCollectionProtocol</span><span class="p">:</span>
</span><span id="1-2015"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set an attribute value on the given instance and &#39;commit&#39; it.&quot;&quot;&quot;</span>
</span><span id="1-2016">
</span><span id="1-2017">        <span class="n">collection</span><span class="p">,</span> <span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_collection</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-2018">
</span><span id="1-2019">        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
</span><span id="1-2020">            <span class="n">collection</span><span class="o">.</span><span class="n">append_multiple_without_event</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="1-2021">
</span><span id="1-2022">        <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_data</span>
</span><span id="1-2023">
</span><span id="1-2024">        <span class="n">state</span><span class="o">.</span><span class="n">_commit</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">])</span>
</span><span id="1-2025">
</span><span id="1-2026">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">_pending_mutations</span><span class="p">:</span>
</span><span id="1-2027">            <span class="c1"># pending items exist.  issue a modified event,</span>
</span><span id="1-2028">            <span class="c1"># add/remove new items.</span>
</span><span id="1-2029">            <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="1-2030">
</span><span id="1-2031">            <span class="n">pending</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">_pending_mutations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-2032">            <span class="n">added</span> <span class="o">=</span> <span class="n">pending</span><span class="o">.</span><span class="n">added_items</span>
</span><span id="1-2033">            <span class="n">removed</span> <span class="o">=</span> <span class="n">pending</span><span class="o">.</span><span class="n">deleted_items</span>
</span><span id="1-2034">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">added</span><span class="p">:</span>
</span><span id="1-2035">                <span class="n">collection</span><span class="o">.</span><span class="n">append_without_event</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="1-2036">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">removed</span><span class="p">:</span>
</span><span id="1-2037">                <span class="n">collection</span><span class="o">.</span><span class="n">remove_without_event</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="1-2038">
</span><span id="1-2039">        <span class="k">return</span> <span class="n">user_data</span>
</span><span id="1-2040">
</span><span id="1-2041">    <span class="nd">@overload</span>
</span><span id="1-2042">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span id="1-2043">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2044">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-2045">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-2046">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-2047">        <span class="n">passive</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-2048">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span> <span class="o">...</span>
</span><span id="1-2049">
</span><span id="1-2050">    <span class="nd">@overload</span>
</span><span id="1-2051">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span id="1-2052">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2053">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-2054">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-2055">        <span class="n">user_data</span><span class="p">:</span> <span class="n">_AdaptedCollectionProtocol</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-2056">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-2057">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span> <span class="o">...</span>
</span><span id="1-2058">
</span><span id="1-2059">    <span class="nd">@overload</span>
</span><span id="1-2060">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span id="1-2061">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2062">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-2063">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-2064">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AdaptedCollectionProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-2065">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-2066">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="1-2067">        <span class="n">Literal</span><span class="p">[</span><span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">],</span> <span class="n">CollectionAdapter</span>
</span><span id="1-2068">    <span class="p">]:</span> <span class="o">...</span>
</span><span id="1-2069">
</span><span id="1-2070">    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span>
</span><span id="1-2071">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2072">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-2073">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-2074">        <span class="n">user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AdaptedCollectionProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2075">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-2076">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="1-2077">        <span class="n">Literal</span><span class="p">[</span><span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">],</span> <span class="n">CollectionAdapter</span>
</span><span id="1-2078">    <span class="p">]:</span>
</span><span id="1-2079"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the CollectionAdapter associated with the given state.</span>
</span><span id="1-2080">
</span><span id="1-2081"><span class="sd">        if user_data is None, retrieves it from the state using normal</span>
</span><span id="1-2082"><span class="sd">        &quot;get()&quot; rules, which will fire lazy callables or return the &quot;empty&quot;</span>
</span><span id="1-2083"><span class="sd">        collection value.</span>
</span><span id="1-2084">
</span><span id="1-2085"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2086">        <span class="k">if</span> <span class="n">user_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2087">            <span class="n">fetch_user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>
</span><span id="1-2088">            <span class="k">if</span> <span class="n">fetch_user_data</span> <span class="ow">is</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">:</span>
</span><span id="1-2089">                <span class="k">return</span> <span class="n">fetch_user_data</span>
</span><span id="1-2090">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2091">                <span class="n">user_data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;_AdaptedCollectionProtocol&quot;</span><span class="p">,</span> <span class="n">fetch_user_data</span><span class="p">)</span>
</span><span id="1-2092">
</span><span id="1-2093">        <span class="k">return</span> <span class="n">user_data</span><span class="o">.</span><span class="n">_sa_adapter</span>
</span><span id="1-2094">
</span><span id="1-2095">
</span><span id="1-2096"><span class="k">def</span><span class="w"> </span><span class="nf">backref_listeners</span><span class="p">(</span>
</span><span id="1-2097">    <span class="n">attribute</span><span class="p">:</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">uselist</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-2098"><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2099"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply listeners to synchronize a two-way relationship.&quot;&quot;&quot;</span>
</span><span id="1-2100">
</span><span id="1-2101">    <span class="c1"># use easily recognizable names for stack traces.</span>
</span><span id="1-2102">
</span><span id="1-2103">    <span class="c1"># in the sections marked &quot;tokens to test for a recursive loop&quot;,</span>
</span><span id="1-2104">    <span class="c1"># this is somewhat brittle and very performance-sensitive logic</span>
</span><span id="1-2105">    <span class="c1"># that is specific to how we might arrive at each event.  a marker</span>
</span><span id="1-2106">    <span class="c1"># that can target us directly to arguments being invoked against</span>
</span><span id="1-2107">    <span class="c1"># the impl might be simpler, but could interfere with other systems.</span>
</span><span id="1-2108">
</span><span id="1-2109">    <span class="n">parent_token</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">parent_token</span>
</span><span id="1-2110">    <span class="n">parent_impl</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">impl</span>
</span><span id="1-2111">
</span><span id="1-2112">    <span class="k">def</span><span class="w"> </span><span class="nf">_acceptable_key_err</span><span class="p">(</span><span class="n">child_state</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">child_impl</span><span class="p">):</span>
</span><span id="1-2113">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="1-2114">            <span class="s2">&quot;Bidirectional attribute conflict detected: &quot;</span>
</span><span id="1-2115">            <span class="s1">&#39;Passing object </span><span class="si">%s</span><span class="s1"> to attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; &#39;</span>
</span><span id="1-2116">            <span class="s1">&#39;triggers a modify event on attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; &#39;</span>
</span><span id="1-2117">            <span class="s1">&#39;via the backref &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span>
</span><span id="1-2118">            <span class="o">%</span> <span class="p">(</span>
</span><span id="1-2119">                <span class="n">state_str</span><span class="p">(</span><span class="n">child_state</span><span class="p">),</span>
</span><span id="1-2120">                <span class="n">initiator</span><span class="o">.</span><span class="n">parent_token</span><span class="p">,</span>
</span><span id="1-2121">                <span class="n">child_impl</span><span class="o">.</span><span class="n">parent_token</span><span class="p">,</span>
</span><span id="1-2122">                <span class="n">attribute</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">parent_token</span><span class="p">,</span>
</span><span id="1-2123">            <span class="p">)</span>
</span><span id="1-2124">        <span class="p">)</span>
</span><span id="1-2125">
</span><span id="1-2126">    <span class="k">def</span><span class="w"> </span><span class="nf">emit_backref_from_scalar_set_event</span><span class="p">(</span>
</span><span id="1-2127">        <span class="n">state</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">oldchild</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span id="1-2128">    <span class="p">):</span>
</span><span id="1-2129">        <span class="k">if</span> <span class="n">oldchild</span> <span class="ow">is</span> <span class="n">child</span><span class="p">:</span>
</span><span id="1-2130">            <span class="k">return</span> <span class="n">child</span>
</span><span id="1-2131">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-2132">            <span class="n">oldchild</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-2133">            <span class="ow">and</span> <span class="n">oldchild</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span id="1-2134">            <span class="ow">and</span> <span class="n">oldchild</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span>
</span><span id="1-2135">        <span class="p">):</span>
</span><span id="1-2136">            <span class="c1"># With lazy=None, there&#39;s no guarantee that the full collection is</span>
</span><span id="1-2137">            <span class="c1"># present when updating via a backref.</span>
</span><span id="1-2138">            <span class="n">old_state</span><span class="p">,</span> <span class="n">old_dict</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-2139">                <span class="n">instance_state</span><span class="p">(</span><span class="n">oldchild</span><span class="p">),</span>
</span><span id="1-2140">                <span class="n">instance_dict</span><span class="p">(</span><span class="n">oldchild</span><span class="p">),</span>
</span><span id="1-2141">            <span class="p">)</span>
</span><span id="1-2142">            <span class="n">impl</span> <span class="o">=</span> <span class="n">old_state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span id="1-2143">
</span><span id="1-2144">            <span class="c1"># tokens to test for a recursive loop.</span>
</span><span id="1-2145">            <span class="k">if</span> <span class="ow">not</span> <span class="n">impl</span><span class="o">.</span><span class="n">collection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">impl</span><span class="o">.</span><span class="n">dynamic</span><span class="p">:</span>
</span><span id="1-2146">                <span class="n">check_recursive_token</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">_replace_token</span>
</span><span id="1-2147">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2148">                <span class="n">check_recursive_token</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">_remove_token</span>
</span><span id="1-2149">
</span><span id="1-2150">            <span class="k">if</span> <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_recursive_token</span><span class="p">:</span>
</span><span id="1-2151">                <span class="n">impl</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
</span><span id="1-2152">                    <span class="n">old_state</span><span class="p">,</span>
</span><span id="1-2153">                    <span class="n">old_dict</span><span class="p">,</span>
</span><span id="1-2154">                    <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">(),</span>
</span><span id="1-2155">                    <span class="n">parent_impl</span><span class="o">.</span><span class="n">_append_token</span><span class="p">,</span>
</span><span id="1-2156">                    <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span><span class="p">,</span>
</span><span id="1-2157">                <span class="p">)</span>
</span><span id="1-2158">
</span><span id="1-2159">        <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2160">            <span class="n">child_state</span><span class="p">,</span> <span class="n">child_dict</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-2161">                <span class="n">instance_state</span><span class="p">(</span><span class="n">child</span><span class="p">),</span>
</span><span id="1-2162">                <span class="n">instance_dict</span><span class="p">(</span><span class="n">child</span><span class="p">),</span>
</span><span id="1-2163">            <span class="p">)</span>
</span><span id="1-2164">            <span class="n">child_impl</span> <span class="o">=</span> <span class="n">child_state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span id="1-2165">
</span><span id="1-2166">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-2167">                <span class="n">initiator</span><span class="o">.</span><span class="n">parent_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">parent_token</span>
</span><span id="1-2168">                <span class="ow">and</span> <span class="n">initiator</span><span class="o">.</span><span class="n">parent_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">parent_token</span>
</span><span id="1-2169">            <span class="p">):</span>
</span><span id="1-2170">                <span class="n">_acceptable_key_err</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">child_impl</span><span class="p">)</span>
</span><span id="1-2171">
</span><span id="1-2172">            <span class="c1"># tokens to test for a recursive loop.</span>
</span><span id="1-2173">            <span class="n">check_append_token</span> <span class="o">=</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">_append_token</span>
</span><span id="1-2174">            <span class="n">check_bulk_replace_token</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-2175">                <span class="n">child_impl</span><span class="o">.</span><span class="n">_bulk_replace_token</span>
</span><span id="1-2176">                <span class="k">if</span> <span class="n">_is_collection_attribute_impl</span><span class="p">(</span><span class="n">child_impl</span><span class="p">)</span>
</span><span id="1-2177">                <span class="k">else</span> <span class="kc">None</span>
</span><span id="1-2178">            <span class="p">)</span>
</span><span id="1-2179">
</span><span id="1-2180">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-2181">                <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_append_token</span>
</span><span id="1-2182">                <span class="ow">and</span> <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_bulk_replace_token</span>
</span><span id="1-2183">            <span class="p">):</span>
</span><span id="1-2184">                <span class="n">child_impl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="1-2185">                    <span class="n">child_state</span><span class="p">,</span>
</span><span id="1-2186">                    <span class="n">child_dict</span><span class="p">,</span>
</span><span id="1-2187">                    <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">(),</span>
</span><span id="1-2188">                    <span class="n">initiator</span><span class="p">,</span>
</span><span id="1-2189">                    <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span><span class="p">,</span>
</span><span id="1-2190">                <span class="p">)</span>
</span><span id="1-2191">        <span class="k">return</span> <span class="n">child</span>
</span><span id="1-2192">
</span><span id="1-2193">    <span class="k">def</span><span class="w"> </span><span class="nf">emit_backref_from_collection_append_event</span><span class="p">(</span>
</span><span id="1-2194">        <span class="n">state</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span id="1-2195">    <span class="p">):</span>
</span><span id="1-2196">        <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2197">            <span class="k">return</span>
</span><span id="1-2198">
</span><span id="1-2199">        <span class="n">child_state</span><span class="p">,</span> <span class="n">child_dict</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">child</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
</span><span id="1-2200">        <span class="n">child_impl</span> <span class="o">=</span> <span class="n">child_state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span id="1-2201">
</span><span id="1-2202">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-2203">            <span class="n">initiator</span><span class="o">.</span><span class="n">parent_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">parent_token</span>
</span><span id="1-2204">            <span class="ow">and</span> <span class="n">initiator</span><span class="o">.</span><span class="n">parent_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">parent_token</span>
</span><span id="1-2205">        <span class="p">):</span>
</span><span id="1-2206">            <span class="n">_acceptable_key_err</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="n">child_impl</span><span class="p">)</span>
</span><span id="1-2207">
</span><span id="1-2208">        <span class="c1"># tokens to test for a recursive loop.</span>
</span><span id="1-2209">        <span class="n">check_append_token</span> <span class="o">=</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">_append_token</span>
</span><span id="1-2210">        <span class="n">check_bulk_replace_token</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-2211">            <span class="n">child_impl</span><span class="o">.</span><span class="n">_bulk_replace_token</span>
</span><span id="1-2212">            <span class="k">if</span> <span class="n">_is_collection_attribute_impl</span><span class="p">(</span><span class="n">child_impl</span><span class="p">)</span>
</span><span id="1-2213">            <span class="k">else</span> <span class="kc">None</span>
</span><span id="1-2214">        <span class="p">)</span>
</span><span id="1-2215">
</span><span id="1-2216">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-2217">            <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_append_token</span>
</span><span id="1-2218">            <span class="ow">and</span> <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_bulk_replace_token</span>
</span><span id="1-2219">        <span class="p">):</span>
</span><span id="1-2220">            <span class="n">child_impl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="1-2221">                <span class="n">child_state</span><span class="p">,</span>
</span><span id="1-2222">                <span class="n">child_dict</span><span class="p">,</span>
</span><span id="1-2223">                <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">(),</span>
</span><span id="1-2224">                <span class="n">initiator</span><span class="p">,</span>
</span><span id="1-2225">                <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span><span class="p">,</span>
</span><span id="1-2226">            <span class="p">)</span>
</span><span id="1-2227">        <span class="k">return</span> <span class="n">child</span>
</span><span id="1-2228">
</span><span id="1-2229">    <span class="k">def</span><span class="w"> </span><span class="nf">emit_backref_from_collection_remove_event</span><span class="p">(</span>
</span><span id="1-2230">        <span class="n">state</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span id="1-2231">    <span class="p">):</span>
</span><span id="1-2232">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-2233">            <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-2234">            <span class="ow">and</span> <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PASSIVE_NO_RESULT</span>
</span><span id="1-2235">            <span class="ow">and</span> <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span>
</span><span id="1-2236">        <span class="p">):</span>
</span><span id="1-2237">            <span class="n">child_state</span><span class="p">,</span> <span class="n">child_dict</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-2238">                <span class="n">instance_state</span><span class="p">(</span><span class="n">child</span><span class="p">),</span>
</span><span id="1-2239">                <span class="n">instance_dict</span><span class="p">(</span><span class="n">child</span><span class="p">),</span>
</span><span id="1-2240">            <span class="p">)</span>
</span><span id="1-2241">            <span class="n">child_impl</span> <span class="o">=</span> <span class="n">child_state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span id="1-2242">
</span><span id="1-2243">            <span class="n">check_replace_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span>
</span><span id="1-2244">
</span><span id="1-2245">            <span class="c1"># tokens to test for a recursive loop.</span>
</span><span id="1-2246">            <span class="k">if</span> <span class="ow">not</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">collection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">dynamic</span><span class="p">:</span>
</span><span id="1-2247">                <span class="n">check_remove_token</span> <span class="o">=</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">_remove_token</span>
</span><span id="1-2248">                <span class="n">check_replace_token</span> <span class="o">=</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">_replace_token</span>
</span><span id="1-2249">                <span class="n">check_for_dupes_on_remove</span> <span class="o">=</span> <span class="n">uselist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parent_impl</span><span class="o">.</span><span class="n">dynamic</span>
</span><span id="1-2250">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2251">                <span class="n">check_remove_token</span> <span class="o">=</span> <span class="n">child_impl</span><span class="o">.</span><span class="n">_remove_token</span>
</span><span id="1-2252">                <span class="n">check_replace_token</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-2253">                    <span class="n">child_impl</span><span class="o">.</span><span class="n">_bulk_replace_token</span>
</span><span id="1-2254">                    <span class="k">if</span> <span class="n">_is_collection_attribute_impl</span><span class="p">(</span><span class="n">child_impl</span><span class="p">)</span>
</span><span id="1-2255">                    <span class="k">else</span> <span class="kc">None</span>
</span><span id="1-2256">                <span class="p">)</span>
</span><span id="1-2257">                <span class="n">check_for_dupes_on_remove</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-2258">
</span><span id="1-2259">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-2260">                <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_remove_token</span>
</span><span id="1-2261">                <span class="ow">and</span> <span class="n">initiator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">check_replace_token</span>
</span><span id="1-2262">            <span class="p">):</span>
</span><span id="1-2263">                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_for_dupes_on_remove</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">has_dupes</span><span class="p">(</span>
</span><span id="1-2264">                    <span class="c1"># when this event is called, the item is usually</span>
</span><span id="1-2265">                    <span class="c1"># present in the list, except for a pop() operation.</span>
</span><span id="1-2266">                    <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">parent_impl</span><span class="o">.</span><span class="n">key</span><span class="p">],</span>
</span><span id="1-2267">                    <span class="n">child</span><span class="p">,</span>
</span><span id="1-2268">                <span class="p">):</span>
</span><span id="1-2269">                    <span class="n">child_impl</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
</span><span id="1-2270">                        <span class="n">child_state</span><span class="p">,</span>
</span><span id="1-2271">                        <span class="n">child_dict</span><span class="p">,</span>
</span><span id="1-2272">                        <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">(),</span>
</span><span id="1-2273">                        <span class="n">initiator</span><span class="p">,</span>
</span><span id="1-2274">                        <span class="n">passive</span><span class="o">=</span><span class="n">PASSIVE_NO_FETCH</span><span class="p">,</span>
</span><span id="1-2275">                    <span class="p">)</span>
</span><span id="1-2276">
</span><span id="1-2277">    <span class="k">if</span> <span class="n">uselist</span><span class="p">:</span>
</span><span id="1-2278">        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
</span><span id="1-2279">            <span class="n">attribute</span><span class="p">,</span>
</span><span id="1-2280">            <span class="s2">&quot;append&quot;</span><span class="p">,</span>
</span><span id="1-2281">            <span class="n">emit_backref_from_collection_append_event</span><span class="p">,</span>
</span><span id="1-2282">            <span class="n">retval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-2283">            <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-2284">            <span class="n">include_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-2285">        <span class="p">)</span>
</span><span id="1-2286">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-2287">        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
</span><span id="1-2288">            <span class="n">attribute</span><span class="p">,</span>
</span><span id="1-2289">            <span class="s2">&quot;set&quot;</span><span class="p">,</span>
</span><span id="1-2290">            <span class="n">emit_backref_from_scalar_set_event</span><span class="p">,</span>
</span><span id="1-2291">            <span class="n">retval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-2292">            <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-2293">            <span class="n">include_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-2294">        <span class="p">)</span>
</span><span id="1-2295">    <span class="c1"># TODO: need coverage in test/orm/ of remove event</span>
</span><span id="1-2296">    <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
</span><span id="1-2297">        <span class="n">attribute</span><span class="p">,</span>
</span><span id="1-2298">        <span class="s2">&quot;remove&quot;</span><span class="p">,</span>
</span><span id="1-2299">        <span class="n">emit_backref_from_collection_remove_event</span><span class="p">,</span>
</span><span id="1-2300">        <span class="n">retval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-2301">        <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-2302">        <span class="n">include_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-2303">    <span class="p">)</span>
</span><span id="1-2304">
</span><span id="1-2305">
</span><span id="1-2306"><span class="n">_NO_HISTORY</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;NO_HISTORY&quot;</span><span class="p">)</span>
</span><span id="1-2307"><span class="n">_NO_STATE_SYMBOLS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="nb">id</span><span class="p">(</span><span class="n">PASSIVE_NO_RESULT</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="n">NO_VALUE</span><span class="p">)])</span>
</span><span id="1-2308">
</span><span id="1-2309">
</span><span id="1-2310"><span class="k">class</span><span class="w"> </span><span class="nc">History</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
</span><span id="1-2311"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A 3-tuple of added, unchanged and deleted values,</span>
</span><span id="1-2312"><span class="sd">    representing the changes which have occurred on an instrumented</span>
</span><span id="1-2313"><span class="sd">    attribute.</span>
</span><span id="1-2314">
</span><span id="1-2315"><span class="sd">    The easiest way to get a :class:`.History` object for a particular</span>
</span><span id="1-2316"><span class="sd">    attribute on an object is to use the :func:`_sa.inspect` function::</span>
</span><span id="1-2317">
</span><span id="1-2318"><span class="sd">        from sqlalchemy import inspect</span>
</span><span id="1-2319">
</span><span id="1-2320"><span class="sd">        hist = inspect(myobject).attrs.myattribute.history</span>
</span><span id="1-2321">
</span><span id="1-2322"><span class="sd">    Each tuple member is an iterable sequence:</span>
</span><span id="1-2323">
</span><span id="1-2324"><span class="sd">    * ``added`` - the collection of items added to the attribute (the first</span>
</span><span id="1-2325"><span class="sd">      tuple element).</span>
</span><span id="1-2326">
</span><span id="1-2327"><span class="sd">    * ``unchanged`` - the collection of items that have not changed on the</span>
</span><span id="1-2328"><span class="sd">      attribute (the second tuple element).</span>
</span><span id="1-2329">
</span><span id="1-2330"><span class="sd">    * ``deleted`` - the collection of items that have been removed from the</span>
</span><span id="1-2331"><span class="sd">      attribute (the third tuple element).</span>
</span><span id="1-2332">
</span><span id="1-2333"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2334">
</span><span id="1-2335">    <span class="n">added</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-2336">    <span class="n">unchanged</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-2337">    <span class="n">deleted</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-2338">
</span><span id="1-2339">    <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-2340">        <span class="k">return</span> <span class="bp">self</span> <span class="o">!=</span> <span class="n">HISTORY_BLANK</span>
</span><span id="1-2341">
</span><span id="1-2342">    <span class="k">def</span><span class="w"> </span><span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-2343"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this :class:`.History` has no changes</span>
</span><span id="1-2344"><span class="sd">        and no existing, unchanged state.</span>
</span><span id="1-2345">
</span><span id="1-2346"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2347">
</span><span id="1-2348">        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">added</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleted</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span><span class="p">)</span>
</span><span id="1-2349">
</span><span id="1-2350">    <span class="k">def</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2351"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a collection of added + unchanged + deleted.&quot;&quot;&quot;</span>
</span><span id="1-2352">
</span><span id="1-2353">        <span class="k">return</span> <span class="p">(</span>
</span><span id="1-2354">            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">added</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deleted</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="1-2355">        <span class="p">)</span>
</span><span id="1-2356">
</span><span id="1-2357">    <span class="k">def</span><span class="w"> </span><span class="nf">non_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2358"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a collection of added + unchanged.&quot;&quot;&quot;</span>
</span><span id="1-2359">
</span><span id="1-2360">        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">added</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="1-2361">
</span><span id="1-2362">    <span class="k">def</span><span class="w"> </span><span class="nf">non_added</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2363"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a collection of unchanged + deleted.&quot;&quot;&quot;</span>
</span><span id="1-2364">
</span><span id="1-2365">        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deleted</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="1-2366">
</span><span id="1-2367">    <span class="k">def</span><span class="w"> </span><span class="nf">has_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-2368"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this :class:`.History` has changes.&quot;&quot;&quot;</span>
</span><span id="1-2369">
</span><span id="1-2370">        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">added</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleted</span><span class="p">)</span>
</span><span id="1-2371">
</span><span id="1-2372">    <span class="k">def</span><span class="w"> </span><span class="nf">_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">added</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">deleted</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-2373">        <span class="k">return</span> <span class="n">History</span><span class="p">(</span>
</span><span id="1-2374">            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">added</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">added</span><span class="p">),</span>
</span><span id="1-2375">            <span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span><span class="p">,</span>
</span><span id="1-2376">            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deleted</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">deleted</span><span class="p">),</span>
</span><span id="1-2377">        <span class="p">)</span>
</span><span id="1-2378">
</span><span id="1-2379">    <span class="k">def</span><span class="w"> </span><span class="nf">as_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-2380">        <span class="k">return</span> <span class="n">History</span><span class="p">(</span>
</span><span id="1-2381">            <span class="p">[</span>
</span><span id="1-2382">                <span class="p">(</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="1-2383">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">added</span>
</span><span id="1-2384">            <span class="p">],</span>
</span><span id="1-2385">            <span class="p">[</span>
</span><span id="1-2386">                <span class="p">(</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="1-2387">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unchanged</span>
</span><span id="1-2388">            <span class="p">],</span>
</span><span id="1-2389">            <span class="p">[</span>
</span><span id="1-2390">                <span class="p">(</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="1-2391">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleted</span>
</span><span id="1-2392">            <span class="p">],</span>
</span><span id="1-2393">        <span class="p">)</span>
</span><span id="1-2394">
</span><span id="1-2395">    <span class="nd">@classmethod</span>
</span><span id="1-2396">    <span class="k">def</span><span class="w"> </span><span class="nf">from_scalar_attribute</span><span class="p">(</span>
</span><span id="1-2397">        <span class="bp">cls</span><span class="p">,</span>
</span><span id="1-2398">        <span class="n">attribute</span><span class="p">:</span> <span class="n">ScalarAttributeImpl</span><span class="p">,</span>
</span><span id="1-2399">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-2400">        <span class="n">current</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2401">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-2402">        <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">_NO_HISTORY</span><span class="p">)</span>
</span><span id="1-2403">
</span><span id="1-2404">        <span class="n">deleted</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-2405">
</span><span id="1-2406">        <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">_NO_HISTORY</span><span class="p">:</span>
</span><span id="1-2407">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span id="1-2408">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">(),</span> <span class="p">())</span>
</span><span id="1-2409">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2410">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">[</span><span class="n">current</span><span class="p">],</span> <span class="p">())</span>
</span><span id="1-2411">        <span class="c1"># don&#39;t let ClauseElement expressions here trip things up</span>
</span><span id="1-2412">        <span class="k">elif</span> <span class="p">(</span>
</span><span id="1-2413">            <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span>
</span><span id="1-2414">            <span class="ow">and</span> <span class="n">attribute</span><span class="o">.</span><span class="n">is_equal</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
</span><span id="1-2415">        <span class="p">):</span>
</span><span id="1-2416">            <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">[</span><span class="n">current</span><span class="p">],</span> <span class="p">())</span>
</span><span id="1-2417">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2418">            <span class="c1"># current convention on native scalars is to not</span>
</span><span id="1-2419">            <span class="c1"># include information</span>
</span><span id="1-2420">            <span class="c1"># about missing previous value in &quot;deleted&quot;, but</span>
</span><span id="1-2421">            <span class="c1"># we do include None, which helps in some primary</span>
</span><span id="1-2422">            <span class="c1"># key situations</span>
</span><span id="1-2423">            <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">original</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_NO_STATE_SYMBOLS</span><span class="p">:</span>
</span><span id="1-2424">                <span class="n">deleted</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="1-2425">                <span class="c1"># indicate a &quot;del&quot; operation occurred when we don&#39;t have</span>
</span><span id="1-2426">                <span class="c1"># the previous value as: ([None], (), ())</span>
</span><span id="1-2427">                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_NO_STATE_SYMBOLS</span><span class="p">:</span>
</span><span id="1-2428">                    <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-2429">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2430">                <span class="n">deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">original</span><span class="p">]</span>
</span><span id="1-2431">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span id="1-2432">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">(),</span> <span class="n">deleted</span><span class="p">)</span>
</span><span id="1-2433">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2434">                <span class="k">return</span> <span class="bp">cls</span><span class="p">([</span><span class="n">current</span><span class="p">],</span> <span class="p">(),</span> <span class="n">deleted</span><span class="p">)</span>
</span><span id="1-2435">
</span><span id="1-2436">    <span class="nd">@classmethod</span>
</span><span id="1-2437">    <span class="k">def</span><span class="w"> </span><span class="nf">from_object_attribute</span><span class="p">(</span>
</span><span id="1-2438">        <span class="bp">cls</span><span class="p">,</span>
</span><span id="1-2439">        <span class="n">attribute</span><span class="p">:</span> <span class="n">ScalarObjectAttributeImpl</span><span class="p">,</span>
</span><span id="1-2440">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-2441">        <span class="n">current</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2442">        <span class="n">original</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">_NO_HISTORY</span><span class="p">,</span>
</span><span id="1-2443">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-2444">        <span class="n">deleted</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[()],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-2445">
</span><span id="1-2446">        <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">_NO_HISTORY</span><span class="p">:</span>
</span><span id="1-2447">            <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">_NO_HISTORY</span><span class="p">)</span>
</span><span id="1-2448">
</span><span id="1-2449">        <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">_NO_HISTORY</span><span class="p">:</span>
</span><span id="1-2450">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span id="1-2451">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">(),</span> <span class="p">())</span>
</span><span id="1-2452">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2453">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">[</span><span class="n">current</span><span class="p">],</span> <span class="p">())</span>
</span><span id="1-2454">        <span class="k">elif</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">original</span> <span class="ow">and</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span id="1-2455">            <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">[</span><span class="n">current</span><span class="p">],</span> <span class="p">())</span>
</span><span id="1-2456">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2457">            <span class="c1"># current convention on related objects is to not</span>
</span><span id="1-2458">            <span class="c1"># include information</span>
</span><span id="1-2459">            <span class="c1"># about missing previous value in &quot;deleted&quot;, and</span>
</span><span id="1-2460">            <span class="c1"># to also not include None - the dependency.py rules</span>
</span><span id="1-2461">            <span class="c1"># ignore the None in any case.</span>
</span><span id="1-2462">            <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">original</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_NO_STATE_SYMBOLS</span> <span class="ow">or</span> <span class="n">original</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2463">                <span class="n">deleted</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="1-2464">                <span class="c1"># indicate a &quot;del&quot; operation occurred when we don&#39;t have</span>
</span><span id="1-2465">                <span class="c1"># the previous value as: ([None], (), ())</span>
</span><span id="1-2466">                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_NO_STATE_SYMBOLS</span><span class="p">:</span>
</span><span id="1-2467">                    <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-2468">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2469">                <span class="n">deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">original</span><span class="p">]</span>
</span><span id="1-2470">            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span id="1-2471">                <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">(),</span> <span class="n">deleted</span><span class="p">)</span>
</span><span id="1-2472">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2473">                <span class="k">return</span> <span class="bp">cls</span><span class="p">([</span><span class="n">current</span><span class="p">],</span> <span class="p">(),</span> <span class="n">deleted</span><span class="p">)</span>
</span><span id="1-2474">
</span><span id="1-2475">    <span class="nd">@classmethod</span>
</span><span id="1-2476">    <span class="k">def</span><span class="w"> </span><span class="nf">from_collection</span><span class="p">(</span>
</span><span id="1-2477">        <span class="bp">cls</span><span class="p">,</span>
</span><span id="1-2478">        <span class="n">attribute</span><span class="p">:</span> <span class="n">CollectionAttributeImpl</span><span class="p">,</span>
</span><span id="1-2479">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-2480">        <span class="n">current</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2481">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-2482">        <span class="n">original</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">_NO_HISTORY</span><span class="p">)</span>
</span><span id="1-2483">        <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span id="1-2484">            <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="p">(),</span> <span class="p">())</span>
</span><span id="1-2485">
</span><span id="1-2486">        <span class="n">current</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s2">&quot;_sa_adapter&quot;</span><span class="p">)</span>
</span><span id="1-2487">        <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">NO_VALUE</span><span class="p">:</span>
</span><span id="1-2488">            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="p">(),</span> <span class="p">())</span>
</span><span id="1-2489">        <span class="k">elif</span> <span class="n">original</span> <span class="ow">is</span> <span class="n">_NO_HISTORY</span><span class="p">:</span>
</span><span id="1-2490">            <span class="k">return</span> <span class="bp">cls</span><span class="p">((),</span> <span class="nb">list</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="p">())</span>
</span><span id="1-2491">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2492">            <span class="n">current_states</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-2493">                <span class="p">((</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span id="1-2494">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">current</span>
</span><span id="1-2495">            <span class="p">]</span>
</span><span id="1-2496">            <span class="n">original_states</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-2497">                <span class="p">((</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span id="1-2498">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">original</span>
</span><span id="1-2499">            <span class="p">]</span>
</span><span id="1-2500">
</span><span id="1-2501">            <span class="n">current_set</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">current_states</span><span class="p">)</span>
</span><span id="1-2502">            <span class="n">original_set</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">original_states</span><span class="p">)</span>
</span><span id="1-2503">
</span><span id="1-2504">            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="1-2505">                <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">current_states</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_set</span><span class="p">],</span>
</span><span id="1-2506">                <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">current_states</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">original_set</span><span class="p">],</span>
</span><span id="1-2507">                <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">original_states</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_set</span><span class="p">],</span>
</span><span id="1-2508">            <span class="p">)</span>
</span><span id="1-2509">
</span><span id="1-2510">
</span><span id="1-2511"><span class="n">HISTORY_BLANK</span> <span class="o">=</span> <span class="n">History</span><span class="p">((),</span> <span class="p">(),</span> <span class="p">())</span>
</span><span id="1-2512">
</span><span id="1-2513">
</span><span id="1-2514"><span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span>
</span><span id="1-2515">    <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span>
</span><span id="1-2516"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-2517"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a :class:`.History` record for the given object</span>
</span><span id="1-2518"><span class="sd">    and attribute key.</span>
</span><span id="1-2519">
</span><span id="1-2520"><span class="sd">    This is the **pre-flush** history for a given attribute, which is</span>
</span><span id="1-2521"><span class="sd">    reset each time the :class:`.Session` flushes changes to the</span>
</span><span id="1-2522"><span class="sd">    current database transaction.</span>
</span><span id="1-2523">
</span><span id="1-2524"><span class="sd">    .. note::</span>
</span><span id="1-2525">
</span><span id="1-2526"><span class="sd">        Prefer to use the :attr:`.AttributeState.history` and</span>
</span><span id="1-2527"><span class="sd">        :meth:`.AttributeState.load_history` accessors to retrieve the</span>
</span><span id="1-2528"><span class="sd">        :class:`.History` for instance attributes.</span>
</span><span id="1-2529">
</span><span id="1-2530">
</span><span id="1-2531"><span class="sd">    :param obj: an object whose class is instrumented by the</span>
</span><span id="1-2532"><span class="sd">      attributes package.</span>
</span><span id="1-2533">
</span><span id="1-2534"><span class="sd">    :param key: string attribute name.</span>
</span><span id="1-2535">
</span><span id="1-2536"><span class="sd">    :param passive: indicates loading behavior for the attribute</span>
</span><span id="1-2537"><span class="sd">       if the value is not already present.   This is a</span>
</span><span id="1-2538"><span class="sd">       bitflag attribute, which defaults to the symbol</span>
</span><span id="1-2539"><span class="sd">       :attr:`.PASSIVE_OFF` indicating all necessary SQL</span>
</span><span id="1-2540"><span class="sd">       should be emitted.</span>
</span><span id="1-2541">
</span><span id="1-2542"><span class="sd">    .. seealso::</span>
</span><span id="1-2543">
</span><span id="1-2544"><span class="sd">        :attr:`.AttributeState.history`</span>
</span><span id="1-2545">
</span><span id="1-2546"><span class="sd">        :meth:`.AttributeState.load_history` - retrieve history</span>
</span><span id="1-2547"><span class="sd">        using loader callables if the value is not locally present.</span>
</span><span id="1-2548">
</span><span id="1-2549"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2550">
</span><span id="1-2551">    <span class="k">return</span> <span class="n">get_state_history</span><span class="p">(</span><span class="n">instance_state</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span id="1-2552">
</span><span id="1-2553">
</span><span id="1-2554"><span class="k">def</span><span class="w"> </span><span class="nf">get_state_history</span><span class="p">(</span>
</span><span id="1-2555">    <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PASSIVE_OFF</span>
</span><span id="1-2556"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
</span><span id="1-2557">    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">get_history</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span id="1-2558">
</span><span id="1-2559">
</span><span id="1-2560"><span class="k">def</span><span class="w"> </span><span class="nf">has_parent</span><span class="p">(</span>
</span><span id="1-2561">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">obj</span><span class="p">:</span> <span class="n">_O</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">optimistic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-2562"><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-2563"><span class="w">    </span><span class="sd">&quot;&quot;&quot;TODO&quot;&quot;&quot;</span>
</span><span id="1-2564">    <span class="n">manager</span> <span class="o">=</span> <span class="n">manager_of_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-2565">    <span class="n">state</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="1-2566">    <span class="k">return</span> <span class="n">manager</span><span class="o">.</span><span class="n">has_parent</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">optimistic</span><span class="p">)</span>
</span><span id="1-2567">
</span><span id="1-2568">
</span><span id="1-2569"><span class="k">def</span><span class="w"> </span><span class="nf">register_attribute</span><span class="p">(</span>
</span><span id="1-2570">    <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-2571">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="1-2572">    <span class="o">*</span><span class="p">,</span>
</span><span id="1-2573">    <span class="n">comparator</span><span class="p">:</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">PropComparator</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span id="1-2574">    <span class="n">parententity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-2575">    <span class="n">doc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2576">    <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2577"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-2578">    <span class="n">desc</span> <span class="o">=</span> <span class="n">register_descriptor</span><span class="p">(</span>
</span><span id="1-2579">        <span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">comparator</span><span class="o">=</span><span class="n">comparator</span><span class="p">,</span> <span class="n">parententity</span><span class="o">=</span><span class="n">parententity</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span>
</span><span id="1-2580">    <span class="p">)</span>
</span><span id="1-2581">    <span class="n">register_attribute_impl</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="1-2582">    <span class="k">return</span> <span class="n">desc</span>
</span><span id="1-2583">
</span><span id="1-2584">
</span><span id="1-2585"><span class="k">def</span><span class="w"> </span><span class="nf">register_attribute_impl</span><span class="p">(</span>
</span><span id="1-2586">    <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-2587">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="1-2588">    <span class="n">uselist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-2589">    <span class="n">callable_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_LoaderCallable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2590">    <span class="n">useobject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-2591">    <span class="n">impl_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">AttributeImpl</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2592">    <span class="n">backref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2593">    <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2594"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryableAttribute</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2595">    <span class="n">manager</span> <span class="o">=</span> <span class="n">manager_of_class</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
</span><span id="1-2596">    <span class="k">if</span> <span class="n">uselist</span><span class="p">:</span>
</span><span id="1-2597">        <span class="n">factory</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;typecallable&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-2598">        <span class="n">typecallable</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">instrument_collection_class</span><span class="p">(</span>
</span><span id="1-2599">            <span class="n">key</span><span class="p">,</span> <span class="n">factory</span> <span class="ow">or</span> <span class="nb">list</span>
</span><span id="1-2600">        <span class="p">)</span>
</span><span id="1-2601">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-2602">        <span class="n">typecallable</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;typecallable&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-2603">
</span><span id="1-2604">    <span class="n">dispatch</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span id="1-2605">        <span class="s2">&quot;_Dispatch[QueryableAttribute[Any]]&quot;</span><span class="p">,</span> <span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dispatch</span>
</span><span id="1-2606">    <span class="p">)</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-2607">
</span><span id="1-2608">    <span class="n">impl</span><span class="p">:</span> <span class="n">AttributeImpl</span>
</span><span id="1-2609">
</span><span id="1-2610">    <span class="k">if</span> <span class="n">impl_class</span><span class="p">:</span>
</span><span id="1-2611">        <span class="c1"># TODO: this appears to be the WriteOnlyAttributeImpl /</span>
</span><span id="1-2612">        <span class="c1"># DynamicAttributeImpl constructor which is hardcoded</span>
</span><span id="1-2613">        <span class="n">impl</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Type[WriteOnlyAttributeImpl]&quot;</span><span class="p">,</span> <span class="n">impl_class</span><span class="p">)(</span>
</span><span id="1-2614">            <span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span id="1-2615">        <span class="p">)</span>
</span><span id="1-2616">    <span class="k">elif</span> <span class="n">uselist</span><span class="p">:</span>
</span><span id="1-2617">        <span class="n">impl</span> <span class="o">=</span> <span class="n">CollectionAttributeImpl</span><span class="p">(</span>
</span><span id="1-2618">            <span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">callable_</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">,</span> <span class="n">typecallable</span><span class="o">=</span><span class="n">typecallable</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span id="1-2619">        <span class="p">)</span>
</span><span id="1-2620">    <span class="k">elif</span> <span class="n">useobject</span><span class="p">:</span>
</span><span id="1-2621">        <span class="n">impl</span> <span class="o">=</span> <span class="n">ScalarObjectAttributeImpl</span><span class="p">(</span>
</span><span id="1-2622">            <span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">callable_</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span id="1-2623">        <span class="p">)</span>
</span><span id="1-2624">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-2625">        <span class="n">impl</span> <span class="o">=</span> <span class="n">ScalarAttributeImpl</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">callable_</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="1-2626">
</span><span id="1-2627">    <span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span> <span class="o">=</span> <span class="n">impl</span>
</span><span id="1-2628">
</span><span id="1-2629">    <span class="k">if</span> <span class="n">backref</span><span class="p">:</span>
</span><span id="1-2630">        <span class="n">backref_listeners</span><span class="p">(</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">backref</span><span class="p">,</span> <span class="n">uselist</span><span class="p">)</span>
</span><span id="1-2631">
</span><span id="1-2632">    <span class="n">manager</span><span class="o">.</span><span class="n">post_configure_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-2633">    <span class="k">return</span> <span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-2634">
</span><span id="1-2635">
</span><span id="1-2636"><span class="k">def</span><span class="w"> </span><span class="nf">register_descriptor</span><span class="p">(</span>
</span><span id="1-2637">    <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-2638">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="1-2639">    <span class="o">*</span><span class="p">,</span>
</span><span id="1-2640">    <span class="n">comparator</span><span class="p">:</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">PropComparator</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span id="1-2641">    <span class="n">parententity</span><span class="p">:</span> <span class="n">_InternalEntityType</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-2642">    <span class="n">doc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2643"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-2644">    <span class="n">manager</span> <span class="o">=</span> <span class="n">manager_of_class</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
</span><span id="1-2645">
</span><span id="1-2646">    <span class="n">descriptor</span> <span class="o">=</span> <span class="n">InstrumentedAttribute</span><span class="p">(</span>
</span><span id="1-2647">        <span class="n">class_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">comparator</span><span class="o">=</span><span class="n">comparator</span><span class="p">,</span> <span class="n">parententity</span><span class="o">=</span><span class="n">parententity</span>
</span><span id="1-2648">    <span class="p">)</span>
</span><span id="1-2649">
</span><span id="1-2650">    <span class="n">descriptor</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>  <span class="c1"># type: ignore</span>
</span><span id="1-2651">
</span><span id="1-2652">    <span class="n">manager</span><span class="o">.</span><span class="n">instrument_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">)</span>
</span><span id="1-2653">    <span class="k">return</span> <span class="n">descriptor</span>
</span><span id="1-2654">
</span><span id="1-2655">
</span><span id="1-2656"><span class="k">def</span><span class="w"> </span><span class="nf">unregister_attribute</span><span class="p">(</span><span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2657">    <span class="n">manager_of_class</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span><span class="o">.</span><span class="n">uninstrument_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-2658">
</span><span id="1-2659">
</span><span id="1-2660"><span class="k">def</span><span class="w"> </span><span class="nf">init_collection</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span>
</span><span id="1-2661"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a collection attribute and return the collection adapter.</span>
</span><span id="1-2662">
</span><span id="1-2663"><span class="sd">    This function is used to provide direct access to collection internals</span>
</span><span id="1-2664"><span class="sd">    for a previously unloaded attribute.  e.g.::</span>
</span><span id="1-2665">
</span><span id="1-2666"><span class="sd">        collection_adapter = init_collection(someobject, &quot;elements&quot;)</span>
</span><span id="1-2667"><span class="sd">        for elem in values:</span>
</span><span id="1-2668"><span class="sd">            collection_adapter.append_without_event(elem)</span>
</span><span id="1-2669">
</span><span id="1-2670"><span class="sd">    For an easier way to do the above, see</span>
</span><span id="1-2671"><span class="sd">    :func:`~sqlalchemy.orm.attributes.set_committed_value`.</span>
</span><span id="1-2672">
</span><span id="1-2673"><span class="sd">    :param obj: a mapped object</span>
</span><span id="1-2674">
</span><span id="1-2675"><span class="sd">    :param key: string attribute name where the collection is located.</span>
</span><span id="1-2676">
</span><span id="1-2677"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2678">    <span class="n">state</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="1-2679">    <span class="n">dict_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span>
</span><span id="1-2680">    <span class="k">return</span> <span class="n">init_state_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span id="1-2681">
</span><span id="1-2682">
</span><span id="1-2683"><span class="k">def</span><span class="w"> </span><span class="nf">init_state_collection</span><span class="p">(</span>
</span><span id="1-2684">    <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="1-2685"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionAdapter</span><span class="p">:</span>
</span><span id="1-2686"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a collection attribute and return the collection adapter.</span>
</span><span id="1-2687">
</span><span id="1-2688"><span class="sd">    Discards any existing collection which may be there.</span>
</span><span id="1-2689">
</span><span id="1-2690"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2691">    <span class="n">attr</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span id="1-2692">
</span><span id="1-2693">    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-2694">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">HasCollectionAdapter</span><span class="p">)</span>
</span><span id="1-2695">
</span><span id="1-2696">    <span class="n">old</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># discard old collection</span>
</span><span id="1-2697">    <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2698">        <span class="n">old_collection</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">_sa_adapter</span>
</span><span id="1-2699">        <span class="n">attr</span><span class="o">.</span><span class="n">_dispose_previous_collection</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">old_collection</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="1-2700">
</span><span id="1-2701">    <span class="n">user_data</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">_default_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span id="1-2702">    <span class="n">adapter</span><span class="p">:</span> <span class="n">CollectionAdapter</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span>
</span><span id="1-2703">        <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_NO_FETCH</span>
</span><span id="1-2704">    <span class="p">)</span>
</span><span id="1-2705">    <span class="n">adapter</span><span class="o">.</span><span class="n">_reset_empty</span><span class="p">()</span>
</span><span id="1-2706">
</span><span id="1-2707">    <span class="k">return</span> <span class="n">adapter</span>
</span><span id="1-2708">
</span><span id="1-2709">
</span><span id="1-2710"><span class="k">def</span><span class="w"> </span><span class="nf">set_committed_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="1-2711"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the value of an attribute with no history events.</span>
</span><span id="1-2712">
</span><span id="1-2713"><span class="sd">    Cancels any previous history present.  The value should be</span>
</span><span id="1-2714"><span class="sd">    a scalar value for scalar-holding attributes, or</span>
</span><span id="1-2715"><span class="sd">    an iterable for any collection-holding attribute.</span>
</span><span id="1-2716">
</span><span id="1-2717"><span class="sd">    This is the same underlying method used when a lazy loader</span>
</span><span id="1-2718"><span class="sd">    fires off and loads additional data from the database.</span>
</span><span id="1-2719"><span class="sd">    In particular, this method can be used by application code</span>
</span><span id="1-2720"><span class="sd">    which has loaded additional attributes or collections through</span>
</span><span id="1-2721"><span class="sd">    separate queries, which can then be attached to an instance</span>
</span><span id="1-2722"><span class="sd">    as though it were part of its original loaded state.</span>
</span><span id="1-2723">
</span><span id="1-2724"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2725">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-2726">    <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">set_committed_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-2727">
</span><span id="1-2728">
</span><span id="1-2729"><span class="k">def</span><span class="w"> </span><span class="nf">set_attribute</span><span class="p">(</span>
</span><span id="1-2730">    <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
</span><span id="1-2731">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="1-2732">    <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2733">    <span class="n">initiator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttributeEventToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2734"><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2735"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the value of an attribute, firing history events.</span>
</span><span id="1-2736">
</span><span id="1-2737"><span class="sd">    This function may be used regardless of instrumentation</span>
</span><span id="1-2738"><span class="sd">    applied directly to the class, i.e. no descriptors are required.</span>
</span><span id="1-2739"><span class="sd">    Custom attribute management schemes will need to make usage</span>
</span><span id="1-2740"><span class="sd">    of this method to establish attribute state as understood</span>
</span><span id="1-2741"><span class="sd">    by SQLAlchemy.</span>
</span><span id="1-2742">
</span><span id="1-2743"><span class="sd">    :param instance: the object that will be modified</span>
</span><span id="1-2744">
</span><span id="1-2745"><span class="sd">    :param key: string name of the attribute</span>
</span><span id="1-2746">
</span><span id="1-2747"><span class="sd">    :param value: value to assign</span>
</span><span id="1-2748">
</span><span id="1-2749"><span class="sd">    :param initiator: an instance of :class:`.Event` that would have</span>
</span><span id="1-2750"><span class="sd">     been propagated from a previous event listener.  This argument</span>
</span><span id="1-2751"><span class="sd">     is used when the :func:`.set_attribute` function is being used within</span>
</span><span id="1-2752"><span class="sd">     an existing event listening function where an :class:`.Event` object</span>
</span><span id="1-2753"><span class="sd">     is being supplied; the object may be used to track the origin of the</span>
</span><span id="1-2754"><span class="sd">     chain of events.</span>
</span><span id="1-2755">
</span><span id="1-2756"><span class="sd">     .. versionadded:: 1.2.3</span>
</span><span id="1-2757">
</span><span id="1-2758"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2759">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-2760">    <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">)</span>
</span><span id="1-2761">
</span><span id="1-2762">
</span><span id="1-2763"><span class="k">def</span><span class="w"> </span><span class="nf">get_attribute</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-2764"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the value of an attribute, firing any callables required.</span>
</span><span id="1-2765">
</span><span id="1-2766"><span class="sd">    This function may be used regardless of instrumentation</span>
</span><span id="1-2767"><span class="sd">    applied directly to the class, i.e. no descriptors are required.</span>
</span><span id="1-2768"><span class="sd">    Custom attribute management schemes will need to make usage</span>
</span><span id="1-2769"><span class="sd">    of this method to make usage of attribute state as understood</span>
</span><span id="1-2770"><span class="sd">    by SQLAlchemy.</span>
</span><span id="1-2771">
</span><span id="1-2772"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2773">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-2774">    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span id="1-2775">
</span><span id="1-2776">
</span><span id="1-2777"><span class="k">def</span><span class="w"> </span><span class="nf">del_attribute</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2778"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete the value of an attribute, firing history events.</span>
</span><span id="1-2779">
</span><span id="1-2780"><span class="sd">    This function may be used regardless of instrumentation</span>
</span><span id="1-2781"><span class="sd">    applied directly to the class, i.e. no descriptors are required.</span>
</span><span id="1-2782"><span class="sd">    Custom attribute management schemes will need to make usage</span>
</span><span id="1-2783"><span class="sd">    of this method to establish attribute state as understood</span>
</span><span id="1-2784"><span class="sd">    by SQLAlchemy.</span>
</span><span id="1-2785">
</span><span id="1-2786"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2787">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-2788">    <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span id="1-2789">
</span><span id="1-2790">
</span><span id="1-2791"><span class="k">def</span><span class="w"> </span><span class="nf">flag_modified</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2792"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mark an attribute on an instance as &#39;modified&#39;.</span>
</span><span id="1-2793">
</span><span id="1-2794"><span class="sd">    This sets the &#39;modified&#39; flag on the instance and</span>
</span><span id="1-2795"><span class="sd">    establishes an unconditional change event for the given attribute.</span>
</span><span id="1-2796"><span class="sd">    The attribute must have a value present, else an</span>
</span><span id="1-2797"><span class="sd">    :class:`.InvalidRequestError` is raised.</span>
</span><span id="1-2798">
</span><span id="1-2799"><span class="sd">    To mark an object &quot;dirty&quot; without referring to any specific attribute</span>
</span><span id="1-2800"><span class="sd">    so that it is considered within a flush, use the</span>
</span><span id="1-2801"><span class="sd">    :func:`.attributes.flag_dirty` call.</span>
</span><span id="1-2802">
</span><span id="1-2803"><span class="sd">    .. seealso::</span>
</span><span id="1-2804">
</span><span id="1-2805"><span class="sd">        :func:`.attributes.flag_dirty`</span>
</span><span id="1-2806">
</span><span id="1-2807"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2808">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-2809">    <span class="n">impl</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span>
</span><span id="1-2810">    <span class="n">impl</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">impl</span><span class="o">.</span><span class="n">_modified_token</span><span class="p">)</span>
</span><span id="1-2811">    <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">impl</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="n">is_userland</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-2812">
</span><span id="1-2813">
</span><span id="1-2814"><span class="k">def</span><span class="w"> </span><span class="nf">flag_dirty</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2815"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mark an instance as &#39;dirty&#39; without any specific attribute mentioned.</span>
</span><span id="1-2816">
</span><span id="1-2817"><span class="sd">    This is a special operation that will allow the object to travel through</span>
</span><span id="1-2818"><span class="sd">    the flush process for interception by events such as</span>
</span><span id="1-2819"><span class="sd">    :meth:`.SessionEvents.before_flush`.   Note that no SQL will be emitted in</span>
</span><span id="1-2820"><span class="sd">    the flush process for an object that has no changes, even if marked dirty</span>
</span><span id="1-2821"><span class="sd">    via this method.  However, a :meth:`.SessionEvents.before_flush` handler</span>
</span><span id="1-2822"><span class="sd">    will be able to see the object in the :attr:`.Session.dirty` collection and</span>
</span><span id="1-2823"><span class="sd">    may establish changes on it, which will then be included in the SQL</span>
</span><span id="1-2824"><span class="sd">    emitted.</span>
</span><span id="1-2825">
</span><span id="1-2826"><span class="sd">    .. versionadded:: 1.2</span>
</span><span id="1-2827">
</span><span id="1-2828"><span class="sd">    .. seealso::</span>
</span><span id="1-2829">
</span><span id="1-2830"><span class="sd">        :func:`.attributes.flag_modified`</span>
</span><span id="1-2831">
</span><span id="1-2832"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2833">
</span><span id="1-2834">    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span> <span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-2835">    <span class="n">state</span><span class="o">.</span><span class="n">_modified_event</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">NO_VALUE</span><span class="p">,</span> <span class="n">is_userland</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></pre></div>
        </article>
        
        <div class="navigation flex print:hidden">
  
  
</div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2023, Jacob Coffee</p>
        
        <p>
          Made with
          
          <a href="https://www.sphinx-doc.org/">Sphinx</a> and
          
          <a href="https://shibuya.lepture.com">Shibuya theme</a>.
        </p>
      </div>
      <div class="sy-foot-socials">
          <a href="https://github.com/JacobCoffee/byte-bot" aria-label="GitHub"><i class="i-icon github"></i></a>
          <a href="https://twitter.com/_scriptr" aria-label="X (Twitter)"><i class="i-icon x-twitter"></i></a>
          <a href="https://discord.gg/ZVG8hN6RrJ/" aria-label="Discord"><i class="i-icon discord"></i></a>
          <a href="https://youtube.com/@monorepo" aria-label="YouTube"><i class="i-icon youtube"></i></a>
      </div>
    </div>
  </div>
</footer></div>
      <script src="../../../_static/documentation_options.js?v=8dde47fa"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../../_static/shibuya.js?v=3e5c8598"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    
</body>
</html>