<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>sqlalchemy.ext.asyncio.session - Docs</title>
    <link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" />
  <script>
    const isDarkTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const sessionTheme = sessionStorage['_theme']
    if (sessionTheme) {
      document.documentElement.classList.add(sessionTheme)
    } else if (isDarkTheme) {
      document.documentElement.classList.add('dark')
    }
  </script><link rel="shortcut icon" href="../../../../_static/badge.svg"/><link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=aecf457f" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/shibuya.css?v=28c32440" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../../_static/print.css?v=ee381b95" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=80d31e7b" />
    <style>
:root {
  --sy-f-sys:-apple-system, BlinkMacSystemFont, Segoe UI, Oxygen, Ubuntu, Droid Sans, Helvetica Neue;--sy-f-cjk:PingFang SC, Hiragino Sans GB, Droid Sans Fallback, Microsoft YaHei;--sy-f-heading:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-text:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-mono:Menlo, Monaco, Consolas, "Courier New", monospace;--sy-c-divider:rgba(var(--sy-rc-text), 0.1);--sy-c-divider-weak:rgba(var(--sy-rc-text), 0.05);--sy-c-border:rgba(var(--sy-rc-text), 0.14);--sy-s-banner-height:0rem;--sy-s-navbar-height:56px;--sy-s-offset-top:calc(var(--sy-s-navbar-height) + var(--sy-s-banner-height));--sy-c-link:rgb(var(--sy-rc-theme));--sy-c-link-weak:rgba(var(--sy-rc-theme), 0.86);
  --sy-rc-theme:66, 177, 168;--sy-rc-bg:255, 255, 255;--sy-rc-invert:66, 177, 168;--sy-rc-text:66, 177, 168;--sy-c-bg:#fff;--sy-c-bg-weak:12, 12, 12;--sy-c-text:#0C0C0C;--sy-c-text-weak:#42B1A8;--sy-c-heading:#42B1A8;--sy-c-bold:#42B1A8;--sy-c-foot-text:#0C0C0C;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#42B1A8;
}
@media (prefers-color-scheme: light) {
  :root {
    --sy-rc-theme:66, 177, 168;--sy-rc-bg:255, 255, 255;--sy-rc-invert:66, 177, 168;--sy-rc-text:66, 177, 168;--sy-c-bg:#fff;--sy-c-bg-weak:12, 12, 12;--sy-c-text:#0C0C0C;--sy-c-text-weak:#42B1A8;--sy-c-heading:#42B1A8;--sy-c-bold:#42B1A8;--sy-c-foot-text:#0C0C0C;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#42B1A8;
  }
}
@media (prefers-color-scheme: dark) {
  :root {
    --sy-rc-theme:66, 177, 168;--sy-rc-bg:12, 12, 12;--sy-rc-invert:66, 177, 168;--sy-rc-text:66, 177, 168;--sy-c-bg:#42B1A8;--sy-c-bg-weak:#0C0C0C;--sy-c-text:#EBEBE9;--sy-c-text-weak:#42B1A8;--sy-c-heading:#42B1A8;--sy-c-bold:#42B1A8;--sy-c-foot-text:#EBEBE9;--sy-c-foot-bg:#0C0C0C;--sy-c-foot-divider:#42B1A8;
  }
}
html.light {
  --sy-rc-theme:66, 177, 168;--sy-rc-bg:255, 255, 255;--sy-rc-invert:66, 177, 168;--sy-rc-text:66, 177, 168;--sy-c-bg:#fff;--sy-c-bg-weak:12, 12, 12;--sy-c-text:#0C0C0C;--sy-c-text-weak:#42B1A8;--sy-c-heading:#42B1A8;--sy-c-bold:#42B1A8;--sy-c-foot-text:#0C0C0C;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#42B1A8;
}
html.dark {
  --sy-rc-theme:66, 177, 168;--sy-rc-bg:12, 12, 12;--sy-rc-invert:66, 177, 168;--sy-rc-text:66, 177, 168;--sy-c-bg:#42B1A8;--sy-c-bg-weak:#0C0C0C;--sy-c-text:#EBEBE9;--sy-c-text-weak:#42B1A8;--sy-c-heading:#42B1A8;--sy-c-bold:#42B1A8;--sy-c-foot-text:#EBEBE9;--sy-c-foot-bg:#0C0C0C;--sy-c-foot-divider:#42B1A8;
}
</style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-heading: Inter, var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sqlalchemy.ext.asyncio.session"/>
<meta name="twitter:card" content="summary"/></head>
<body><div class="document"><div class="announcement">
    <div class="announcement-inner">
      <p>This documentation is currently under development.</p>
      <button class="announcement-close" aria-label="Close announcement">
        <i class="i-icon close"></i>
      </button>
    </div>
  </div><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand mr-4" href="/">
      <img class="light-logo" src="../../../../_static/badge.svg" alt="byte-bot" height="28" />
      <img class="dark-logo" src="../../../../_static/badge.svg" alt="byte-bot" height="28" />
      <strong>byte-bot</strong>
    </a>
    <div class="sy-head-links" id="NavLinks">
      <nav class="sy-head-nav">

<ul><li class="link">
          <a href="https://byte-bot.app/"><span>Dashboard</span><i class="i-icon external-link"></i></a>
        </li><li class="link">
          <a href="https://github.com/sponsors/JacobCoffee"><span>Sponsor me</span><i class="i-icon external-link"></i></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form>
        
        
        <div class="sy-head-social flex items-center">
            <a class="flex items-center" href="https://github.com/JacobCoffee/byte-bot" aria-label="GitHub">
              <i class="i-icon github"></i>
            </a>
            <a class="flex items-center" href="https://discord.gg/ZVG8hN6RrJ/" aria-label="Discord">
              <i class="i-icon discord"></i>
            </a>
        </div>
      </div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden">
      <button class="js-theme theme-switch flex items-center" data-aria-light="Switch to dark mode" data-aria-dark="Switch to light mode">
        <i class="i-icon theme-icon"></i>
      </button>
      <button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="NavLinks" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading"><span class="caption-text">Byte Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../byte/usage/index.html">Usage</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../byte/api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../byte/api/bot.html">bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../byte/api/plugins/index.html">plugins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/plugins/admin.html">admin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/plugins/astral.html">astral</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/plugins/events.html">events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/plugins/general.html">general</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/plugins/github.html">github</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/plugins/guild.html">guild</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/plugins/testing.html">testing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../byte/api/views/index.html">views</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/views/forums.html">forums</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../byte/api/lib/index.html">lib</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/lib/common.html">common</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/lib/logging.html">logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/lib/settings.html">settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../byte/api/lib/utils.html">utils</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Web Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../web/usage/index.html">Usage</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../web/api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../web/api/app.html">app</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../web/api/cli.html">cli</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../web/api/metadata.html">metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../web/api/utils.html">utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../web/api/domain/index.html">domain</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/domain/init.html">Domain Initializer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/domain/urls.html">urls</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/domain/system/index.html">system</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../web/api/domain/system/controllers.html">controllers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/domain/web/index.html">web</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../web/api/domain/web/controllers.html">controllers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/domain/db/index.html">Database</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../web/api/domain/db/models.html">models</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../web/api/lib/index.html">lib</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/lib/cors.html">cors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/lib/exceptions.html">exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/lib/openapi.html">openapi</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/lib/schema.html">schema</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/lib/serialization.html">serialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/lib/settings.html">settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/lib/static_files.html">static files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/lib/template.html">template</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/lib/log/index.html">logging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../web/api/lib/log/controller.html">controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../web/api/lib/log/init.html">init</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../web/api/lib/log/utils.html">utils</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../web/api/lib/db/index.html">Database Library</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../web/api/lib/db/base.html">base</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../web/api/lib/db/orm.html">orm</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribution-guide.html">Contribution guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
      
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-icon close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/JacobCoffee/byte"
  data-type="github" data-user="JacobCoffee" data-repo="byte">
  <span class="w-8 flex items-center justify-around shrink-0 text-2xl">
    <i class="i-icon github"></i>
  </span>
  <span class="flex-grow px-2">
    <span>JacobCoffee/byte</span>
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <i class="i-icon star"></i>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <i class="i-icon git-fork"></i>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
    <div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-icon menu"></i>
      </button>
    </div>
    <ul class="flex-1">
      
      
      <li><a href="../../../../index.html">byte-bot</a><span>/</span></li>
      
      <li><a href="../../../index.html">Module code</a><span>/</span></li>
      
      <li><strong>sqlalchemy.ext.asyncio.session</strong></li>
      
      
    </ul>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-icon outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sqlalchemy.ext.asyncio.session</h1><div class="highlight"><pre>
<span></span><span id="1-1"><span class="c1"># ext/asyncio/session.py</span>
</span><span id="1-2"><span class="c1"># Copyright (C) 2020-2025 the SQLAlchemy authors and contributors</span>
</span><span id="1-3"><span class="c1"># &lt;see AUTHORS file&gt;</span>
</span><span id="1-4"><span class="c1">#</span>
</span><span id="1-5"><span class="c1"># This module is part of SQLAlchemy and is released under</span>
</span><span id="1-6"><span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
</span><span id="1-7"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span id="1-8">
</span><span id="1-9"><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="1-10"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span id="1-11"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Awaitable</span>
</span><span id="1-12"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
</span><span id="1-13"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span>
</span><span id="1-14"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
</span><span id="1-15"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generic</span>
</span><span id="1-16"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
</span><span id="1-17"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterator</span>
</span><span id="1-18"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NoReturn</span>
</span><span id="1-19"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="1-20"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">overload</span>
</span><span id="1-21"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
</span><span id="1-22"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span>
</span><span id="1-23"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Type</span>
</span><span id="1-24"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span id="1-25"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeVar</span>
</span><span id="1-26"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span id="1-27">
</span><span id="1-28"><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">engine</span>
</span><span id="1-29"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReversibleProxy</span>
</span><span id="1-30"><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">StartableContext</span>
</span><span id="1-31"><span class="kn">from</span><span class="w"> </span><span class="nn">.result</span><span class="w"> </span><span class="kn">import</span> <span class="n">_ensure_sync_result</span>
</span><span id="1-32"><span class="kn">from</span><span class="w"> </span><span class="nn">.result</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncResult</span>
</span><span id="1-33"><span class="kn">from</span><span class="w"> </span><span class="nn">.result</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncScalarResult</span>
</span><span id="1-34"><span class="kn">from</span><span class="w"> </span><span class="nn">...</span><span class="w"> </span><span class="kn">import</span> <span class="n">util</span>
</span><span id="1-35"><span class="kn">from</span><span class="w"> </span><span class="nn">...orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">close_all_sessions</span> <span class="k">as</span> <span class="n">_sync_close_all_sessions</span>
</span><span id="1-36"><span class="kn">from</span><span class="w"> </span><span class="nn">...orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">object_session</span>
</span><span id="1-37"><span class="kn">from</span><span class="w"> </span><span class="nn">...orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>
</span><span id="1-38"><span class="kn">from</span><span class="w"> </span><span class="nn">...orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SessionTransaction</span>
</span><span id="1-39"><span class="kn">from</span><span class="w"> </span><span class="nn">...orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">state</span> <span class="k">as</span> <span class="n">_instance_state</span>
</span><span id="1-40"><span class="kn">from</span><span class="w"> </span><span class="nn">...util.concurrency</span><span class="w"> </span><span class="kn">import</span> <span class="n">greenlet_spawn</span>
</span><span id="1-41"><span class="kn">from</span><span class="w"> </span><span class="nn">...util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Concatenate</span>
</span><span id="1-42"><span class="kn">from</span><span class="w"> </span><span class="nn">...util.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParamSpec</span>
</span><span id="1-43">
</span><span id="1-44">
</span><span id="1-45"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-46">    <span class="kn">from</span><span class="w"> </span><span class="nn">.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncConnection</span>
</span><span id="1-47">    <span class="kn">from</span><span class="w"> </span><span class="nn">.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncEngine</span>
</span><span id="1-48">    <span class="kn">from</span><span class="w"> </span><span class="nn">...engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Connection</span>
</span><span id="1-49">    <span class="kn">from</span><span class="w"> </span><span class="nn">...engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">CursorResult</span>
</span><span id="1-50">    <span class="kn">from</span><span class="w"> </span><span class="nn">...engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Engine</span>
</span><span id="1-51">    <span class="kn">from</span><span class="w"> </span><span class="nn">...engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Result</span>
</span><span id="1-52">    <span class="kn">from</span><span class="w"> </span><span class="nn">...engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Row</span>
</span><span id="1-53">    <span class="kn">from</span><span class="w"> </span><span class="nn">...engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">RowMapping</span>
</span><span id="1-54">    <span class="kn">from</span><span class="w"> </span><span class="nn">...engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScalarResult</span>
</span><span id="1-55">    <span class="kn">from</span><span class="w"> </span><span class="nn">...engine.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">_CoreAnyExecuteParams</span>
</span><span id="1-56">    <span class="kn">from</span><span class="w"> </span><span class="nn">...engine.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">CoreExecuteOptionsParameter</span>
</span><span id="1-57">    <span class="kn">from</span><span class="w"> </span><span class="nn">...event</span><span class="w"> </span><span class="kn">import</span> <span class="n">dispatcher</span>
</span><span id="1-58">    <span class="kn">from</span><span class="w"> </span><span class="nn">...orm._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_IdentityKeyType</span>
</span><span id="1-59">    <span class="kn">from</span><span class="w"> </span><span class="nn">...orm._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_O</span>
</span><span id="1-60">    <span class="kn">from</span><span class="w"> </span><span class="nn">...orm._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrmExecuteOptionsParameter</span>
</span><span id="1-61">    <span class="kn">from</span><span class="w"> </span><span class="nn">...orm.identity</span><span class="w"> </span><span class="kn">import</span> <span class="n">IdentityMap</span>
</span><span id="1-62">    <span class="kn">from</span><span class="w"> </span><span class="nn">...orm.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">ORMOption</span>
</span><span id="1-63">    <span class="kn">from</span><span class="w"> </span><span class="nn">...orm.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">_BindArguments</span>
</span><span id="1-64">    <span class="kn">from</span><span class="w"> </span><span class="nn">...orm.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">_EntityBindKey</span>
</span><span id="1-65">    <span class="kn">from</span><span class="w"> </span><span class="nn">...orm.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">_PKIdentityArgument</span>
</span><span id="1-66">    <span class="kn">from</span><span class="w"> </span><span class="nn">...orm.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">_SessionBind</span>
</span><span id="1-67">    <span class="kn">from</span><span class="w"> </span><span class="nn">...orm.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">_SessionBindKey</span>
</span><span id="1-68">    <span class="kn">from</span><span class="w"> </span><span class="nn">...sql._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">_InfoType</span>
</span><span id="1-69">    <span class="kn">from</span><span class="w"> </span><span class="nn">...sql.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Executable</span>
</span><span id="1-70">    <span class="kn">from</span><span class="w"> </span><span class="nn">...sql.dml</span><span class="w"> </span><span class="kn">import</span> <span class="n">UpdateBase</span>
</span><span id="1-71">    <span class="kn">from</span><span class="w"> </span><span class="nn">...sql.elements</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClauseElement</span>
</span><span id="1-72">    <span class="kn">from</span><span class="w"> </span><span class="nn">...sql.selectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">ForUpdateParameter</span>
</span><span id="1-73">    <span class="kn">from</span><span class="w"> </span><span class="nn">...sql.selectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedReturnsRows</span>
</span><span id="1-74">
</span><span id="1-75"><span class="n">_AsyncSessionBind</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;AsyncEngine&quot;</span><span class="p">,</span> <span class="s2">&quot;AsyncConnection&quot;</span><span class="p">]</span>
</span><span id="1-76">
</span><span id="1-77"><span class="n">_P</span> <span class="o">=</span> <span class="n">ParamSpec</span><span class="p">(</span><span class="s2">&quot;_P&quot;</span><span class="p">)</span>
</span><span id="1-78"><span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span id="1-79">
</span><span id="1-80">
</span><span id="1-81"><span class="n">_EXECUTE_OPTIONS</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">({</span><span class="s2">&quot;prebuffer_rows&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span id="1-82"><span class="n">_STREAM_OPTIONS</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">({</span><span class="s2">&quot;stream_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span id="1-83">
</span><span id="1-84">
</span><span id="1-85"><span class="k">class</span><span class="w"> </span><span class="nc">AsyncAttrs</span><span class="p">:</span>
</span><span id="1-86"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mixin class which provides an awaitable accessor for all attributes.</span>
</span><span id="1-87">
</span><span id="1-88"><span class="sd">    E.g.::</span>
</span><span id="1-89">
</span><span id="1-90"><span class="sd">        from __future__ import annotations</span>
</span><span id="1-91">
</span><span id="1-92"><span class="sd">        from typing import List</span>
</span><span id="1-93">
</span><span id="1-94"><span class="sd">        from sqlalchemy import ForeignKey</span>
</span><span id="1-95"><span class="sd">        from sqlalchemy import func</span>
</span><span id="1-96"><span class="sd">        from sqlalchemy.ext.asyncio import AsyncAttrs</span>
</span><span id="1-97"><span class="sd">        from sqlalchemy.orm import DeclarativeBase</span>
</span><span id="1-98"><span class="sd">        from sqlalchemy.orm import Mapped</span>
</span><span id="1-99"><span class="sd">        from sqlalchemy.orm import mapped_column</span>
</span><span id="1-100"><span class="sd">        from sqlalchemy.orm import relationship</span>
</span><span id="1-101">
</span><span id="1-102">
</span><span id="1-103"><span class="sd">        class Base(AsyncAttrs, DeclarativeBase):</span>
</span><span id="1-104"><span class="sd">            pass</span>
</span><span id="1-105">
</span><span id="1-106">
</span><span id="1-107"><span class="sd">        class A(Base):</span>
</span><span id="1-108"><span class="sd">            __tablename__ = &quot;a&quot;</span>
</span><span id="1-109">
</span><span id="1-110"><span class="sd">            id: Mapped[int] = mapped_column(primary_key=True)</span>
</span><span id="1-111"><span class="sd">            data: Mapped[str]</span>
</span><span id="1-112"><span class="sd">            bs: Mapped[List[B]] = relationship()</span>
</span><span id="1-113">
</span><span id="1-114">
</span><span id="1-115"><span class="sd">        class B(Base):</span>
</span><span id="1-116"><span class="sd">            __tablename__ = &quot;b&quot;</span>
</span><span id="1-117"><span class="sd">            id: Mapped[int] = mapped_column(primary_key=True)</span>
</span><span id="1-118"><span class="sd">            a_id: Mapped[int] = mapped_column(ForeignKey(&quot;a.id&quot;))</span>
</span><span id="1-119"><span class="sd">            data: Mapped[str]</span>
</span><span id="1-120">
</span><span id="1-121"><span class="sd">    In the above example, the :class:`_asyncio.AsyncAttrs` mixin is applied to</span>
</span><span id="1-122"><span class="sd">    the declarative ``Base`` class where it takes effect for all subclasses.</span>
</span><span id="1-123"><span class="sd">    This mixin adds a single new attribute</span>
</span><span id="1-124"><span class="sd">    :attr:`_asyncio.AsyncAttrs.awaitable_attrs` to all classes, which will</span>
</span><span id="1-125"><span class="sd">    yield the value of any attribute as an awaitable. This allows attributes</span>
</span><span id="1-126"><span class="sd">    which may be subject to lazy loading or deferred / unexpiry loading to be</span>
</span><span id="1-127"><span class="sd">    accessed such that IO can still be emitted::</span>
</span><span id="1-128">
</span><span id="1-129"><span class="sd">        a1 = (await async_session.scalars(select(A).where(A.id == 5))).one()</span>
</span><span id="1-130">
</span><span id="1-131"><span class="sd">        # use the lazy loader on ``a1.bs`` via the ``.awaitable_attrs``</span>
</span><span id="1-132"><span class="sd">        # interface, so that it may be awaited</span>
</span><span id="1-133"><span class="sd">        for b1 in await a1.awaitable_attrs.bs:</span>
</span><span id="1-134"><span class="sd">            print(b1)</span>
</span><span id="1-135">
</span><span id="1-136"><span class="sd">    The :attr:`_asyncio.AsyncAttrs.awaitable_attrs` performs a call against the</span>
</span><span id="1-137"><span class="sd">    attribute that is approximately equivalent to using the</span>
</span><span id="1-138"><span class="sd">    :meth:`_asyncio.AsyncSession.run_sync` method, e.g.::</span>
</span><span id="1-139">
</span><span id="1-140"><span class="sd">        for b1 in await async_session.run_sync(lambda sess: a1.bs):</span>
</span><span id="1-141"><span class="sd">            print(b1)</span>
</span><span id="1-142">
</span><span id="1-143"><span class="sd">    .. versionadded:: 2.0.13</span>
</span><span id="1-144">
</span><span id="1-145"><span class="sd">    .. seealso::</span>
</span><span id="1-146">
</span><span id="1-147"><span class="sd">        :ref:`asyncio_orm_avoid_lazyloads`</span>
</span><span id="1-148">
</span><span id="1-149"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-150">
</span><span id="1-151">    <span class="k">class</span><span class="w"> </span><span class="nc">_AsyncAttrGetitem</span><span class="p">:</span>
</span><span id="1-152">        <span class="vm">__slots__</span> <span class="o">=</span> <span class="s2">&quot;_instance&quot;</span>
</span><span id="1-153">
</span><span id="1-154">        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span id="1-155">            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="n">_instance</span>
</span><span id="1-156">
</span><span id="1-157">        <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-158">            <span class="k">return</span> <span class="n">greenlet_spawn</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="1-159">
</span><span id="1-160">    <span class="nd">@property</span>
</span><span id="1-161">    <span class="k">def</span><span class="w"> </span><span class="nf">awaitable_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncAttrs</span><span class="o">.</span><span class="n">_AsyncAttrGetitem</span><span class="p">:</span>
</span><span id="1-162"><span class="w">        </span><span class="sd">&quot;&quot;&quot;provide a namespace of all attributes on this object wrapped</span>
</span><span id="1-163"><span class="sd">        as awaitables.</span>
</span><span id="1-164">
</span><span id="1-165"><span class="sd">        e.g.::</span>
</span><span id="1-166">
</span><span id="1-167">
</span><span id="1-168"><span class="sd">            a1 = (await async_session.scalars(select(A).where(A.id == 5))).one()</span>
</span><span id="1-169">
</span><span id="1-170"><span class="sd">            some_attribute = await a1.awaitable_attrs.some_deferred_attribute</span>
</span><span id="1-171"><span class="sd">            some_collection = await a1.awaitable_attrs.some_collection</span>
</span><span id="1-172">
</span><span id="1-173"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-174">
</span><span id="1-175">        <span class="k">return</span> <span class="n">AsyncAttrs</span><span class="o">.</span><span class="n">_AsyncAttrGetitem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="1-176">
</span><span id="1-177">
</span><span id="1-178"><span class="nd">@util</span><span class="o">.</span><span class="n">create_proxy_methods</span><span class="p">(</span>
</span><span id="1-179">    <span class="n">Session</span><span class="p">,</span>
</span><span id="1-180">    <span class="s2">&quot;:class:`_orm.Session`&quot;</span><span class="p">,</span>
</span><span id="1-181">    <span class="s2">&quot;:class:`_asyncio.AsyncSession`&quot;</span><span class="p">,</span>
</span><span id="1-182">    <span class="n">classmethods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;object_session&quot;</span><span class="p">,</span> <span class="s2">&quot;identity_key&quot;</span><span class="p">],</span>
</span><span id="1-183">    <span class="n">methods</span><span class="o">=</span><span class="p">[</span>
</span><span id="1-184">        <span class="s2">&quot;__contains__&quot;</span><span class="p">,</span>
</span><span id="1-185">        <span class="s2">&quot;__iter__&quot;</span><span class="p">,</span>
</span><span id="1-186">        <span class="s2">&quot;add&quot;</span><span class="p">,</span>
</span><span id="1-187">        <span class="s2">&quot;add_all&quot;</span><span class="p">,</span>
</span><span id="1-188">        <span class="s2">&quot;expire&quot;</span><span class="p">,</span>
</span><span id="1-189">        <span class="s2">&quot;expire_all&quot;</span><span class="p">,</span>
</span><span id="1-190">        <span class="s2">&quot;expunge&quot;</span><span class="p">,</span>
</span><span id="1-191">        <span class="s2">&quot;expunge_all&quot;</span><span class="p">,</span>
</span><span id="1-192">        <span class="s2">&quot;is_modified&quot;</span><span class="p">,</span>
</span><span id="1-193">        <span class="s2">&quot;in_transaction&quot;</span><span class="p">,</span>
</span><span id="1-194">        <span class="s2">&quot;in_nested_transaction&quot;</span><span class="p">,</span>
</span><span id="1-195">    <span class="p">],</span>
</span><span id="1-196">    <span class="n">attributes</span><span class="o">=</span><span class="p">[</span>
</span><span id="1-197">        <span class="s2">&quot;dirty&quot;</span><span class="p">,</span>
</span><span id="1-198">        <span class="s2">&quot;deleted&quot;</span><span class="p">,</span>
</span><span id="1-199">        <span class="s2">&quot;new&quot;</span><span class="p">,</span>
</span><span id="1-200">        <span class="s2">&quot;identity_map&quot;</span><span class="p">,</span>
</span><span id="1-201">        <span class="s2">&quot;is_active&quot;</span><span class="p">,</span>
</span><span id="1-202">        <span class="s2">&quot;autoflush&quot;</span><span class="p">,</span>
</span><span id="1-203">        <span class="s2">&quot;no_autoflush&quot;</span><span class="p">,</span>
</span><span id="1-204">        <span class="s2">&quot;info&quot;</span><span class="p">,</span>
</span><span id="1-205">    <span class="p">],</span>
</span><span id="1-206"><span class="p">)</span>
</span><span id="1-207"><span class="k">class</span><span class="w"> </span><span class="nc">AsyncSession</span><span class="p">(</span><span class="n">ReversibleProxy</span><span class="p">[</span><span class="n">Session</span><span class="p">]):</span>
</span><span id="1-208"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Asyncio version of :class:`_orm.Session`.</span>
</span><span id="1-209">
</span><span id="1-210"><span class="sd">    The :class:`_asyncio.AsyncSession` is a proxy for a traditional</span>
</span><span id="1-211"><span class="sd">    :class:`_orm.Session` instance.</span>
</span><span id="1-212">
</span><span id="1-213"><span class="sd">    The :class:`_asyncio.AsyncSession` is **not safe for use in concurrent</span>
</span><span id="1-214"><span class="sd">    tasks.**.  See :ref:`session_faq_threadsafe` for background.</span>
</span><span id="1-215">
</span><span id="1-216"><span class="sd">    .. versionadded:: 1.4</span>
</span><span id="1-217">
</span><span id="1-218"><span class="sd">    To use an :class:`_asyncio.AsyncSession` with custom :class:`_orm.Session`</span>
</span><span id="1-219"><span class="sd">    implementations, see the</span>
</span><span id="1-220"><span class="sd">    :paramref:`_asyncio.AsyncSession.sync_session_class` parameter.</span>
</span><span id="1-221">
</span><span id="1-222">
</span><span id="1-223"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-224">
</span><span id="1-225">    <span class="n">_is_asyncio</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-226">
</span><span id="1-227">    <span class="n">dispatch</span><span class="p">:</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span>
</span><span id="1-228">
</span><span id="1-229">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-230">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-231">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AsyncSessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-232">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-233">        <span class="n">binds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">_SessionBindKey</span><span class="p">,</span> <span class="n">_AsyncSessionBind</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-234">        <span class="n">sync_session_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Session</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-235">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-236">    <span class="p">):</span>
</span><span id="1-237"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a new :class:`_asyncio.AsyncSession`.</span>
</span><span id="1-238">
</span><span id="1-239"><span class="sd">        All parameters other than ``sync_session_class`` are passed to the</span>
</span><span id="1-240"><span class="sd">        ``sync_session_class`` callable directly to instantiate a new</span>
</span><span id="1-241"><span class="sd">        :class:`_orm.Session`. Refer to :meth:`_orm.Session.__init__` for</span>
</span><span id="1-242"><span class="sd">        parameter documentation.</span>
</span><span id="1-243">
</span><span id="1-244"><span class="sd">        :param sync_session_class:</span>
</span><span id="1-245"><span class="sd">          A :class:`_orm.Session` subclass or other callable which will be used</span>
</span><span id="1-246"><span class="sd">          to construct the :class:`_orm.Session` which will be proxied. This</span>
</span><span id="1-247"><span class="sd">          parameter may be used to provide custom :class:`_orm.Session`</span>
</span><span id="1-248"><span class="sd">          subclasses. Defaults to the</span>
</span><span id="1-249"><span class="sd">          :attr:`_asyncio.AsyncSession.sync_session_class` class-level</span>
</span><span id="1-250"><span class="sd">          attribute.</span>
</span><span id="1-251">
</span><span id="1-252"><span class="sd">          .. versionadded:: 1.4.24</span>
</span><span id="1-253">
</span><span id="1-254"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-255">        <span class="n">sync_bind</span> <span class="o">=</span> <span class="n">sync_binds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-256">
</span><span id="1-257">        <span class="k">if</span> <span class="n">bind</span><span class="p">:</span>
</span><span id="1-258">            <span class="bp">self</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">bind</span>
</span><span id="1-259">            <span class="n">sync_bind</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">_get_sync_engine_or_connection</span><span class="p">(</span><span class="n">bind</span><span class="p">)</span>
</span><span id="1-260">
</span><span id="1-261">        <span class="k">if</span> <span class="n">binds</span><span class="p">:</span>
</span><span id="1-262">            <span class="bp">self</span><span class="o">.</span><span class="n">binds</span> <span class="o">=</span> <span class="n">binds</span>
</span><span id="1-263">            <span class="n">sync_binds</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-264">                <span class="n">key</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">_get_sync_engine_or_connection</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="1-265">                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">binds</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="1-266">            <span class="p">}</span>
</span><span id="1-267">
</span><span id="1-268">        <span class="k">if</span> <span class="n">sync_session_class</span><span class="p">:</span>
</span><span id="1-269">            <span class="bp">self</span><span class="o">.</span><span class="n">sync_session_class</span> <span class="o">=</span> <span class="n">sync_session_class</span>
</span><span id="1-270">
</span><span id="1-271">        <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_proxied</span><span class="p">(</span>
</span><span id="1-272">            <span class="bp">self</span><span class="o">.</span><span class="n">sync_session_class</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">sync_bind</span><span class="p">,</span> <span class="n">binds</span><span class="o">=</span><span class="n">sync_binds</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="1-273">        <span class="p">)</span>
</span><span id="1-274">
</span><span id="1-275">    <span class="n">sync_session_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="n">Session</span>
</span><span id="1-276"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The class or callable that provides the</span>
</span><span id="1-277"><span class="sd">    underlying :class:`_orm.Session` instance for a particular</span>
</span><span id="1-278"><span class="sd">    :class:`_asyncio.AsyncSession`.</span>
</span><span id="1-279">
</span><span id="1-280"><span class="sd">    At the class level, this attribute is the default value for the</span>
</span><span id="1-281"><span class="sd">    :paramref:`_asyncio.AsyncSession.sync_session_class` parameter. Custom</span>
</span><span id="1-282"><span class="sd">    subclasses of :class:`_asyncio.AsyncSession` can override this.</span>
</span><span id="1-283">
</span><span id="1-284"><span class="sd">    At the instance level, this attribute indicates the current class or</span>
</span><span id="1-285"><span class="sd">    callable that was used to provide the :class:`_orm.Session` instance for</span>
</span><span id="1-286"><span class="sd">    this :class:`_asyncio.AsyncSession` instance.</span>
</span><span id="1-287">
</span><span id="1-288"><span class="sd">    .. versionadded:: 1.4.24</span>
</span><span id="1-289">
</span><span id="1-290"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-291">
</span><span id="1-292">    <span class="n">sync_session</span><span class="p">:</span> <span class="n">Session</span>
</span><span id="1-293"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Reference to the underlying :class:`_orm.Session` this</span>
</span><span id="1-294"><span class="sd">    :class:`_asyncio.AsyncSession` proxies requests towards.</span>
</span><span id="1-295">
</span><span id="1-296"><span class="sd">    This instance can be used as an event target.</span>
</span><span id="1-297">
</span><span id="1-298"><span class="sd">    .. seealso::</span>
</span><span id="1-299">
</span><span id="1-300"><span class="sd">        :ref:`asyncio_events`</span>
</span><span id="1-301">
</span><span id="1-302"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-303">
</span><span id="1-304">    <span class="nd">@classmethod</span>
</span><span id="1-305">    <span class="k">def</span><span class="w"> </span><span class="nf">_no_async_engine_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span id="1-306">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="1-307">            <span class="s2">&quot;asynchronous events are not implemented at this time.  Apply &quot;</span>
</span><span id="1-308">            <span class="s2">&quot;synchronous listeners to the AsyncSession.sync_session.&quot;</span>
</span><span id="1-309">        <span class="p">)</span>
</span><span id="1-310">
</span><span id="1-311">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refresh</span><span class="p">(</span>
</span><span id="1-312">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-313">        <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
</span><span id="1-314">        <span class="n">attribute_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-315">        <span class="n">with_for_update</span><span class="p">:</span> <span class="n">ForUpdateParameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-316">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-317"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Expire and refresh the attributes on the given instance.</span>
</span><span id="1-318">
</span><span id="1-319"><span class="sd">        A query will be issued to the database and all attributes will be</span>
</span><span id="1-320"><span class="sd">        refreshed with their current database value.</span>
</span><span id="1-321">
</span><span id="1-322"><span class="sd">        This is the async version of the :meth:`_orm.Session.refresh` method.</span>
</span><span id="1-323"><span class="sd">        See that method for a complete description of all options.</span>
</span><span id="1-324">
</span><span id="1-325"><span class="sd">        .. seealso::</span>
</span><span id="1-326">
</span><span id="1-327"><span class="sd">            :meth:`_orm.Session.refresh` - main documentation for refresh</span>
</span><span id="1-328">
</span><span id="1-329"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-330">
</span><span id="1-331">        <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span>
</span><span id="1-332">            <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">refresh</span><span class="p">,</span>
</span><span id="1-333">            <span class="n">instance</span><span class="p">,</span>
</span><span id="1-334">            <span class="n">attribute_names</span><span class="o">=</span><span class="n">attribute_names</span><span class="p">,</span>
</span><span id="1-335">            <span class="n">with_for_update</span><span class="o">=</span><span class="n">with_for_update</span><span class="p">,</span>
</span><span id="1-336">        <span class="p">)</span>
</span><span id="1-337">
</span><span id="1-338">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_sync</span><span class="p">(</span>
</span><span id="1-339">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-340">        <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n">Session</span><span class="p">,</span> <span class="n">_P</span><span class="p">],</span> <span class="n">_T</span><span class="p">],</span>
</span><span id="1-341">        <span class="o">*</span><span class="n">arg</span><span class="p">:</span> <span class="n">_P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
</span><span id="1-342">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">_P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="1-343">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span id="1-344"><span class="w">        </span><span class="sd">&#39;&#39;&#39;Invoke the given synchronous (i.e. not async) callable,</span>
</span><span id="1-345"><span class="sd">        passing a synchronous-style :class:`_orm.Session` as the first</span>
</span><span id="1-346"><span class="sd">        argument.</span>
</span><span id="1-347">
</span><span id="1-348"><span class="sd">        This method allows traditional synchronous SQLAlchemy functions to</span>
</span><span id="1-349"><span class="sd">        run within the context of an asyncio application.</span>
</span><span id="1-350">
</span><span id="1-351"><span class="sd">        E.g.::</span>
</span><span id="1-352">
</span><span id="1-353"><span class="sd">            def some_business_method(session: Session, param: str) -&gt; str:</span>
</span><span id="1-354"><span class="sd">                &quot;&quot;&quot;A synchronous function that does not require awaiting</span>
</span><span id="1-355">
</span><span id="1-356"><span class="sd">                :param session: a SQLAlchemy Session, used synchronously</span>
</span><span id="1-357">
</span><span id="1-358"><span class="sd">                :return: an optional return value is supported</span>
</span><span id="1-359">
</span><span id="1-360"><span class="sd">                &quot;&quot;&quot;</span>
</span><span id="1-361"><span class="sd">                session.add(MyObject(param=param))</span>
</span><span id="1-362"><span class="sd">                session.flush()</span>
</span><span id="1-363"><span class="sd">                return &quot;success&quot;</span>
</span><span id="1-364">
</span><span id="1-365">
</span><span id="1-366"><span class="sd">            async def do_something_async(async_engine: AsyncEngine) -&gt; None:</span>
</span><span id="1-367"><span class="sd">                &quot;&quot;&quot;an async function that uses awaiting&quot;&quot;&quot;</span>
</span><span id="1-368">
</span><span id="1-369"><span class="sd">                with AsyncSession(async_engine) as async_session:</span>
</span><span id="1-370"><span class="sd">                    # run some_business_method() with a sync-style</span>
</span><span id="1-371"><span class="sd">                    # Session, proxied into an awaitable</span>
</span><span id="1-372"><span class="sd">                    return_code = await async_session.run_sync(</span>
</span><span id="1-373"><span class="sd">                        some_business_method, param=&quot;param1&quot;</span>
</span><span id="1-374"><span class="sd">                    )</span>
</span><span id="1-375"><span class="sd">                    print(return_code)</span>
</span><span id="1-376">
</span><span id="1-377"><span class="sd">        This method maintains the asyncio event loop all the way through</span>
</span><span id="1-378"><span class="sd">        to the database connection by running the given callable in a</span>
</span><span id="1-379"><span class="sd">        specially instrumented greenlet.</span>
</span><span id="1-380">
</span><span id="1-381"><span class="sd">        .. tip::</span>
</span><span id="1-382">
</span><span id="1-383"><span class="sd">            The provided callable is invoked inline within the asyncio event</span>
</span><span id="1-384"><span class="sd">            loop, and will block on traditional IO calls.  IO within this</span>
</span><span id="1-385"><span class="sd">            callable should only call into SQLAlchemy&#39;s asyncio database</span>
</span><span id="1-386"><span class="sd">            APIs which will be properly adapted to the greenlet context.</span>
</span><span id="1-387">
</span><span id="1-388"><span class="sd">        .. seealso::</span>
</span><span id="1-389">
</span><span id="1-390"><span class="sd">            :class:`.AsyncAttrs`  - a mixin for ORM mapped classes that provides</span>
</span><span id="1-391"><span class="sd">            a similar feature more succinctly on a per-attribute basis</span>
</span><span id="1-392">
</span><span id="1-393"><span class="sd">            :meth:`.AsyncConnection.run_sync`</span>
</span><span id="1-394">
</span><span id="1-395"><span class="sd">            :ref:`session_run_sync`</span>
</span><span id="1-396"><span class="sd">        &#39;&#39;&#39;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-397">
</span><span id="1-398">        <span class="k">return</span> <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span>
</span><span id="1-399">            <span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">_require_await</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span id="1-400">        <span class="p">)</span>
</span><span id="1-401">
</span><span id="1-402">    <span class="nd">@overload</span>
</span><span id="1-403">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
</span><span id="1-404">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-405">        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span id="1-406">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-407">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-408">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-409">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-410">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-411">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-412">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-413">
</span><span id="1-414">    <span class="nd">@overload</span>
</span><span id="1-415">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
</span><span id="1-416">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-417">        <span class="n">statement</span><span class="p">:</span> <span class="n">UpdateBase</span><span class="p">,</span>
</span><span id="1-418">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-419">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-420">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-421">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-422">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-423">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-424">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-425">
</span><span id="1-426">    <span class="nd">@overload</span>
</span><span id="1-427">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
</span><span id="1-428">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-429">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-430">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-431">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-432">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-433">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-434">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-435">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-436">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-437">
</span><span id="1-438">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
</span><span id="1-439">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-440">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-441">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-442">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-443">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-444">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-445">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-446">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-447"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a statement and return a buffered</span>
</span><span id="1-448"><span class="sd">        :class:`_engine.Result` object.</span>
</span><span id="1-449">
</span><span id="1-450"><span class="sd">        .. seealso::</span>
</span><span id="1-451">
</span><span id="1-452"><span class="sd">            :meth:`_orm.Session.execute` - main documentation for execute</span>
</span><span id="1-453">
</span><span id="1-454"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-455">
</span><span id="1-456">        <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
</span><span id="1-457">            <span class="n">execution_options</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">(</span><span class="n">execution_options</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
</span><span id="1-458">                <span class="n">_EXECUTE_OPTIONS</span>
</span><span id="1-459">            <span class="p">)</span>
</span><span id="1-460">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-461">            <span class="n">execution_options</span> <span class="o">=</span> <span class="n">_EXECUTE_OPTIONS</span>
</span><span id="1-462">
</span><span id="1-463">        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span>
</span><span id="1-464">            <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">execute</span><span class="p">,</span>
</span><span id="1-465">            <span class="n">statement</span><span class="p">,</span>
</span><span id="1-466">            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="1-467">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-468">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-469">            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="1-470">        <span class="p">)</span>
</span><span id="1-471">        <span class="k">return</span> <span class="k">await</span> <span class="n">_ensure_sync_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">)</span>
</span><span id="1-472">
</span><span id="1-473">    <span class="nd">@overload</span>
</span><span id="1-474">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">scalar</span><span class="p">(</span>
</span><span id="1-475">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-476">        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
</span><span id="1-477">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-478">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-479">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-480">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-481">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-482">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-483">
</span><span id="1-484">    <span class="nd">@overload</span>
</span><span id="1-485">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">scalar</span><span class="p">(</span>
</span><span id="1-486">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-487">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-488">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-489">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-490">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-491">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-492">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-493">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="o">...</span>
</span><span id="1-494">
</span><span id="1-495">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">scalar</span><span class="p">(</span>
</span><span id="1-496">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-497">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-498">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-499">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-500">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-501">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-502">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-503">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-504"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a statement and return a scalar result.</span>
</span><span id="1-505">
</span><span id="1-506"><span class="sd">        .. seealso::</span>
</span><span id="1-507">
</span><span id="1-508"><span class="sd">            :meth:`_orm.Session.scalar` - main documentation for scalar</span>
</span><span id="1-509">
</span><span id="1-510"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-511">
</span><span id="1-512">        <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
</span><span id="1-513">            <span class="n">execution_options</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">(</span><span class="n">execution_options</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
</span><span id="1-514">                <span class="n">_EXECUTE_OPTIONS</span>
</span><span id="1-515">            <span class="p">)</span>
</span><span id="1-516">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-517">            <span class="n">execution_options</span> <span class="o">=</span> <span class="n">_EXECUTE_OPTIONS</span>
</span><span id="1-518">
</span><span id="1-519">        <span class="k">return</span> <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span>
</span><span id="1-520">            <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">scalar</span><span class="p">,</span>
</span><span id="1-521">            <span class="n">statement</span><span class="p">,</span>
</span><span id="1-522">            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="1-523">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-524">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-525">            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="1-526">        <span class="p">)</span>
</span><span id="1-527">
</span><span id="1-528">    <span class="nd">@overload</span>
</span><span id="1-529">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">scalars</span><span class="p">(</span>
</span><span id="1-530">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-531">        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
</span><span id="1-532">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-533">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-534">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-535">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-536">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-537">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-538">
</span><span id="1-539">    <span class="nd">@overload</span>
</span><span id="1-540">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">scalars</span><span class="p">(</span>
</span><span id="1-541">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-542">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-543">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-544">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-545">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-546">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-547">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-548">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-549">
</span><span id="1-550">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">scalars</span><span class="p">(</span>
</span><span id="1-551">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-552">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-553">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-554">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-555">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-556">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-557">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-558">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-559"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a statement and return scalar results.</span>
</span><span id="1-560">
</span><span id="1-561"><span class="sd">        :return: a :class:`_result.ScalarResult` object</span>
</span><span id="1-562">
</span><span id="1-563"><span class="sd">        .. versionadded:: 1.4.24 Added :meth:`_asyncio.AsyncSession.scalars`</span>
</span><span id="1-564">
</span><span id="1-565"><span class="sd">        .. versionadded:: 1.4.26 Added</span>
</span><span id="1-566"><span class="sd">           :meth:`_asyncio.async_scoped_session.scalars`</span>
</span><span id="1-567">
</span><span id="1-568"><span class="sd">        .. seealso::</span>
</span><span id="1-569">
</span><span id="1-570"><span class="sd">            :meth:`_orm.Session.scalars` - main documentation for scalars</span>
</span><span id="1-571">
</span><span id="1-572"><span class="sd">            :meth:`_asyncio.AsyncSession.stream_scalars` - streaming version</span>
</span><span id="1-573">
</span><span id="1-574"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-575">
</span><span id="1-576">        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="1-577">            <span class="n">statement</span><span class="p">,</span>
</span><span id="1-578">            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="1-579">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-580">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-581">            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="1-582">        <span class="p">)</span>
</span><span id="1-583">        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span>
</span><span id="1-584">
</span><span id="1-585">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
</span><span id="1-586">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-587">        <span class="n">entity</span><span class="p">:</span> <span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-588">        <span class="n">ident</span><span class="p">:</span> <span class="n">_PKIdentityArgument</span><span class="p">,</span>
</span><span id="1-589">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-590">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-591">        <span class="n">populate_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-592">        <span class="n">with_for_update</span><span class="p">:</span> <span class="n">ForUpdateParameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-593">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-594">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-595">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">_O</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="1-596"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an instance based on the given primary key identifier,</span>
</span><span id="1-597"><span class="sd">        or ``None`` if not found.</span>
</span><span id="1-598">
</span><span id="1-599"><span class="sd">        .. seealso::</span>
</span><span id="1-600">
</span><span id="1-601"><span class="sd">            :meth:`_orm.Session.get` - main documentation for get</span>
</span><span id="1-602">
</span><span id="1-603">
</span><span id="1-604"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-605">
</span><span id="1-606">        <span class="k">return</span> <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span>
</span><span id="1-607">            <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Callable[..., _O]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">get</span><span class="p">),</span>
</span><span id="1-608">            <span class="n">entity</span><span class="p">,</span>
</span><span id="1-609">            <span class="n">ident</span><span class="p">,</span>
</span><span id="1-610">            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span><span id="1-611">            <span class="n">populate_existing</span><span class="o">=</span><span class="n">populate_existing</span><span class="p">,</span>
</span><span id="1-612">            <span class="n">with_for_update</span><span class="o">=</span><span class="n">with_for_update</span><span class="p">,</span>
</span><span id="1-613">            <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span id="1-614">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-615">        <span class="p">)</span>
</span><span id="1-616">
</span><span id="1-617">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_one</span><span class="p">(</span>
</span><span id="1-618">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-619">        <span class="n">entity</span><span class="p">:</span> <span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-620">        <span class="n">ident</span><span class="p">:</span> <span class="n">_PKIdentityArgument</span><span class="p">,</span>
</span><span id="1-621">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-622">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-623">        <span class="n">populate_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-624">        <span class="n">with_for_update</span><span class="p">:</span> <span class="n">ForUpdateParameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-625">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-626">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-627">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_O</span><span class="p">:</span>
</span><span id="1-628"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an instance based on the given primary key identifier,</span>
</span><span id="1-629"><span class="sd">        or raise an exception if not found.</span>
</span><span id="1-630">
</span><span id="1-631"><span class="sd">        Raises :class:`_exc.NoResultFound` if the query selects no rows.</span>
</span><span id="1-632">
</span><span id="1-633"><span class="sd">        ..versionadded: 2.0.22</span>
</span><span id="1-634">
</span><span id="1-635"><span class="sd">        .. seealso::</span>
</span><span id="1-636">
</span><span id="1-637"><span class="sd">            :meth:`_orm.Session.get_one` - main documentation for get_one</span>
</span><span id="1-638">
</span><span id="1-639"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-640">
</span><span id="1-641">        <span class="k">return</span> <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span>
</span><span id="1-642">            <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Callable[..., _O]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">get_one</span><span class="p">),</span>
</span><span id="1-643">            <span class="n">entity</span><span class="p">,</span>
</span><span id="1-644">            <span class="n">ident</span><span class="p">,</span>
</span><span id="1-645">            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span><span id="1-646">            <span class="n">populate_existing</span><span class="o">=</span><span class="n">populate_existing</span><span class="p">,</span>
</span><span id="1-647">            <span class="n">with_for_update</span><span class="o">=</span><span class="n">with_for_update</span><span class="p">,</span>
</span><span id="1-648">            <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span id="1-649">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-650">        <span class="p">)</span>
</span><span id="1-651">
</span><span id="1-652">    <span class="nd">@overload</span>
</span><span id="1-653">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
</span><span id="1-654">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-655">        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span id="1-656">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-657">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-658">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-659">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-660">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-661">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncResult</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-662">
</span><span id="1-663">    <span class="nd">@overload</span>
</span><span id="1-664">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
</span><span id="1-665">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-666">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-667">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-668">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-669">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-670">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-671">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-672">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-673">
</span><span id="1-674">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
</span><span id="1-675">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-676">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-677">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-678">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-679">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-680">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-681">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-682">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-683"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a statement and return a streaming</span>
</span><span id="1-684"><span class="sd">        :class:`_asyncio.AsyncResult` object.</span>
</span><span id="1-685">
</span><span id="1-686"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-687">
</span><span id="1-688">        <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
</span><span id="1-689">            <span class="n">execution_options</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">(</span><span class="n">execution_options</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
</span><span id="1-690">                <span class="n">_STREAM_OPTIONS</span>
</span><span id="1-691">            <span class="p">)</span>
</span><span id="1-692">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-693">            <span class="n">execution_options</span> <span class="o">=</span> <span class="n">_STREAM_OPTIONS</span>
</span><span id="1-694">
</span><span id="1-695">        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span>
</span><span id="1-696">            <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">execute</span><span class="p">,</span>
</span><span id="1-697">            <span class="n">statement</span><span class="p">,</span>
</span><span id="1-698">            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="1-699">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-700">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-701">            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="1-702">        <span class="p">)</span>
</span><span id="1-703">        <span class="k">return</span> <span class="n">AsyncResult</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="1-704">
</span><span id="1-705">    <span class="nd">@overload</span>
</span><span id="1-706">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_scalars</span><span class="p">(</span>
</span><span id="1-707">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-708">        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
</span><span id="1-709">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-710">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-711">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-712">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-713">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-714">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncScalarResult</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-715">
</span><span id="1-716">    <span class="nd">@overload</span>
</span><span id="1-717">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_scalars</span><span class="p">(</span>
</span><span id="1-718">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-719">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-720">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-721">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-722">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-723">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-724">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-725">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncScalarResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="1-726">
</span><span id="1-727">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_scalars</span><span class="p">(</span>
</span><span id="1-728">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-729">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-730">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-731">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-732">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-733">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-734">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-735">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncScalarResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-736"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a statement and return a stream of scalar results.</span>
</span><span id="1-737">
</span><span id="1-738"><span class="sd">        :return: an :class:`_asyncio.AsyncScalarResult` object</span>
</span><span id="1-739">
</span><span id="1-740"><span class="sd">        .. versionadded:: 1.4.24</span>
</span><span id="1-741">
</span><span id="1-742"><span class="sd">        .. seealso::</span>
</span><span id="1-743">
</span><span id="1-744"><span class="sd">            :meth:`_orm.Session.scalars` - main documentation for scalars</span>
</span><span id="1-745">
</span><span id="1-746"><span class="sd">            :meth:`_asyncio.AsyncSession.scalars` - non streaming version</span>
</span><span id="1-747">
</span><span id="1-748"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-749">
</span><span id="1-750">        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="1-751">            <span class="n">statement</span><span class="p">,</span>
</span><span id="1-752">            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="1-753">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-754">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-755">            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="1-756">        <span class="p">)</span>
</span><span id="1-757">        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span>
</span><span id="1-758">
</span><span id="1-759">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-760"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark an instance as deleted.</span>
</span><span id="1-761">
</span><span id="1-762"><span class="sd">        The database delete operation occurs upon ``flush()``.</span>
</span><span id="1-763">
</span><span id="1-764"><span class="sd">        As this operation may need to cascade along unloaded relationships,</span>
</span><span id="1-765"><span class="sd">        it is awaitable to allow for those queries to take place.</span>
</span><span id="1-766">
</span><span id="1-767"><span class="sd">        .. seealso::</span>
</span><span id="1-768">
</span><span id="1-769"><span class="sd">            :meth:`_orm.Session.delete` - main documentation for delete</span>
</span><span id="1-770">
</span><span id="1-771"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-772">        <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">delete</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="1-773">
</span><span id="1-774">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span>
</span><span id="1-775">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-776">        <span class="n">instance</span><span class="p">:</span> <span class="n">_O</span><span class="p">,</span>
</span><span id="1-777">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-778">        <span class="n">load</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-779">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-780">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_O</span><span class="p">:</span>
</span><span id="1-781"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy the state of a given instance into a corresponding instance</span>
</span><span id="1-782"><span class="sd">        within this :class:`_asyncio.AsyncSession`.</span>
</span><span id="1-783">
</span><span id="1-784"><span class="sd">        .. seealso::</span>
</span><span id="1-785">
</span><span id="1-786"><span class="sd">            :meth:`_orm.Session.merge` - main documentation for merge</span>
</span><span id="1-787">
</span><span id="1-788"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-789">        <span class="k">return</span> <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span>
</span><span id="1-790">            <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span>
</span><span id="1-791">        <span class="p">)</span>
</span><span id="1-792">
</span><span id="1-793">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-794"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush all the object changes to the database.</span>
</span><span id="1-795">
</span><span id="1-796"><span class="sd">        .. seealso::</span>
</span><span id="1-797">
</span><span id="1-798"><span class="sd">            :meth:`_orm.Session.flush` - main documentation for flush</span>
</span><span id="1-799">
</span><span id="1-800"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-801">        <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">flush</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="n">objects</span><span class="p">)</span>
</span><span id="1-802">
</span><span id="1-803">    <span class="k">def</span><span class="w"> </span><span class="nf">get_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncSessionTransaction</span><span class="p">]:</span>
</span><span id="1-804"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current root transaction in progress, if any.</span>
</span><span id="1-805">
</span><span id="1-806"><span class="sd">        :return: an :class:`_asyncio.AsyncSessionTransaction` object, or</span>
</span><span id="1-807"><span class="sd">         ``None``.</span>
</span><span id="1-808">
</span><span id="1-809"><span class="sd">        .. versionadded:: 1.4.18</span>
</span><span id="1-810">
</span><span id="1-811"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-812">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">get_transaction</span><span class="p">()</span>
</span><span id="1-813">        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-814">            <span class="k">return</span> <span class="n">AsyncSessionTransaction</span><span class="o">.</span><span class="n">_retrieve_proxy_for_target</span><span class="p">(</span>
</span><span id="1-815">                <span class="n">trans</span><span class="p">,</span> <span class="n">async_session</span><span class="o">=</span><span class="bp">self</span>
</span><span id="1-816">            <span class="p">)</span>
</span><span id="1-817">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-818">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-819">
</span><span id="1-820">    <span class="k">def</span><span class="w"> </span><span class="nf">get_nested_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncSessionTransaction</span><span class="p">]:</span>
</span><span id="1-821"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current nested transaction in progress, if any.</span>
</span><span id="1-822">
</span><span id="1-823"><span class="sd">        :return: an :class:`_asyncio.AsyncSessionTransaction` object, or</span>
</span><span id="1-824"><span class="sd">         ``None``.</span>
</span><span id="1-825">
</span><span id="1-826"><span class="sd">        .. versionadded:: 1.4.18</span>
</span><span id="1-827">
</span><span id="1-828"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-829">
</span><span id="1-830">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">get_nested_transaction</span><span class="p">()</span>
</span><span id="1-831">        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-832">            <span class="k">return</span> <span class="n">AsyncSessionTransaction</span><span class="o">.</span><span class="n">_retrieve_proxy_for_target</span><span class="p">(</span>
</span><span id="1-833">                <span class="n">trans</span><span class="p">,</span> <span class="n">async_session</span><span class="o">=</span><span class="bp">self</span>
</span><span id="1-834">            <span class="p">)</span>
</span><span id="1-835">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-836">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-837">
</span><span id="1-838">    <span class="k">def</span><span class="w"> </span><span class="nf">get_bind</span><span class="p">(</span>
</span><span id="1-839">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-840">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-841">        <span class="n">clause</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ClauseElement</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-842">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_SessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-843">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-844">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Engine</span><span class="p">,</span> <span class="n">Connection</span><span class="p">]:</span>
</span><span id="1-845"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a &quot;bind&quot; to which the synchronous proxied :class:`_orm.Session`</span>
</span><span id="1-846"><span class="sd">        is bound.</span>
</span><span id="1-847">
</span><span id="1-848"><span class="sd">        Unlike the :meth:`_orm.Session.get_bind` method, this method is</span>
</span><span id="1-849"><span class="sd">        currently **not** used by this :class:`.AsyncSession` in any way</span>
</span><span id="1-850"><span class="sd">        in order to resolve engines for requests.</span>
</span><span id="1-851">
</span><span id="1-852"><span class="sd">        .. note::</span>
</span><span id="1-853">
</span><span id="1-854"><span class="sd">            This method proxies directly to the :meth:`_orm.Session.get_bind`</span>
</span><span id="1-855"><span class="sd">            method, however is currently **not** useful as an override target,</span>
</span><span id="1-856"><span class="sd">            in contrast to that of the :meth:`_orm.Session.get_bind` method.</span>
</span><span id="1-857"><span class="sd">            The example below illustrates how to implement custom</span>
</span><span id="1-858"><span class="sd">            :meth:`_orm.Session.get_bind` schemes that work with</span>
</span><span id="1-859"><span class="sd">            :class:`.AsyncSession` and :class:`.AsyncEngine`.</span>
</span><span id="1-860">
</span><span id="1-861"><span class="sd">        The pattern introduced at :ref:`session_custom_partitioning`</span>
</span><span id="1-862"><span class="sd">        illustrates how to apply a custom bind-lookup scheme to a</span>
</span><span id="1-863"><span class="sd">        :class:`_orm.Session` given a set of :class:`_engine.Engine` objects.</span>
</span><span id="1-864"><span class="sd">        To apply a corresponding :meth:`_orm.Session.get_bind` implementation</span>
</span><span id="1-865"><span class="sd">        for use with a :class:`.AsyncSession` and :class:`.AsyncEngine`</span>
</span><span id="1-866"><span class="sd">        objects, continue to subclass :class:`_orm.Session` and apply it to</span>
</span><span id="1-867"><span class="sd">        :class:`.AsyncSession` using</span>
</span><span id="1-868"><span class="sd">        :paramref:`.AsyncSession.sync_session_class`. The inner method must</span>
</span><span id="1-869"><span class="sd">        continue to return :class:`_engine.Engine` instances, which can be</span>
</span><span id="1-870"><span class="sd">        acquired from a :class:`_asyncio.AsyncEngine` using the</span>
</span><span id="1-871"><span class="sd">        :attr:`_asyncio.AsyncEngine.sync_engine` attribute::</span>
</span><span id="1-872">
</span><span id="1-873"><span class="sd">            # using example from &quot;Custom Vertical Partitioning&quot;</span>
</span><span id="1-874">
</span><span id="1-875">
</span><span id="1-876"><span class="sd">            import random</span>
</span><span id="1-877">
</span><span id="1-878"><span class="sd">            from sqlalchemy.ext.asyncio import AsyncSession</span>
</span><span id="1-879"><span class="sd">            from sqlalchemy.ext.asyncio import create_async_engine</span>
</span><span id="1-880"><span class="sd">            from sqlalchemy.ext.asyncio import async_sessionmaker</span>
</span><span id="1-881"><span class="sd">            from sqlalchemy.orm import Session</span>
</span><span id="1-882">
</span><span id="1-883"><span class="sd">            # construct async engines w/ async drivers</span>
</span><span id="1-884"><span class="sd">            engines = {</span>
</span><span id="1-885"><span class="sd">                &quot;leader&quot;: create_async_engine(&quot;sqlite+aiosqlite:///leader.db&quot;),</span>
</span><span id="1-886"><span class="sd">                &quot;other&quot;: create_async_engine(&quot;sqlite+aiosqlite:///other.db&quot;),</span>
</span><span id="1-887"><span class="sd">                &quot;follower1&quot;: create_async_engine(&quot;sqlite+aiosqlite:///follower1.db&quot;),</span>
</span><span id="1-888"><span class="sd">                &quot;follower2&quot;: create_async_engine(&quot;sqlite+aiosqlite:///follower2.db&quot;),</span>
</span><span id="1-889"><span class="sd">            }</span>
</span><span id="1-890">
</span><span id="1-891">
</span><span id="1-892"><span class="sd">            class RoutingSession(Session):</span>
</span><span id="1-893"><span class="sd">                def get_bind(self, mapper=None, clause=None, **kw):</span>
</span><span id="1-894"><span class="sd">                    # within get_bind(), return sync engines</span>
</span><span id="1-895"><span class="sd">                    if mapper and issubclass(mapper.class_, MyOtherClass):</span>
</span><span id="1-896"><span class="sd">                        return engines[&quot;other&quot;].sync_engine</span>
</span><span id="1-897"><span class="sd">                    elif self._flushing or isinstance(clause, (Update, Delete)):</span>
</span><span id="1-898"><span class="sd">                        return engines[&quot;leader&quot;].sync_engine</span>
</span><span id="1-899"><span class="sd">                    else:</span>
</span><span id="1-900"><span class="sd">                        return engines[</span>
</span><span id="1-901"><span class="sd">                            random.choice([&quot;follower1&quot;, &quot;follower2&quot;])</span>
</span><span id="1-902"><span class="sd">                        ].sync_engine</span>
</span><span id="1-903">
</span><span id="1-904">
</span><span id="1-905"><span class="sd">            # apply to AsyncSession using sync_session_class</span>
</span><span id="1-906"><span class="sd">            AsyncSessionMaker = async_sessionmaker(sync_session_class=RoutingSession)</span>
</span><span id="1-907">
</span><span id="1-908"><span class="sd">        The :meth:`_orm.Session.get_bind` method is called in a non-asyncio,</span>
</span><span id="1-909"><span class="sd">        implicitly non-blocking context in the same manner as ORM event hooks</span>
</span><span id="1-910"><span class="sd">        and functions that are invoked via :meth:`.AsyncSession.run_sync`, so</span>
</span><span id="1-911"><span class="sd">        routines that wish to run SQL commands inside of</span>
</span><span id="1-912"><span class="sd">        :meth:`_orm.Session.get_bind` can continue to do so using</span>
</span><span id="1-913"><span class="sd">        blocking-style code, which will be translated to implicitly async calls</span>
</span><span id="1-914"><span class="sd">        at the point of invoking IO on the database drivers.</span>
</span><span id="1-915">
</span><span id="1-916"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-917">
</span><span id="1-918">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">get_bind</span><span class="p">(</span>
</span><span id="1-919">            <span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span> <span class="n">clause</span><span class="o">=</span><span class="n">clause</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
</span><span id="1-920">        <span class="p">)</span>
</span><span id="1-921">
</span><span id="1-922">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connection</span><span class="p">(</span>
</span><span id="1-923">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-924">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-925">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-926">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-927">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncConnection</span><span class="p">:</span>
</span><span id="1-928"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return a :class:`_asyncio.AsyncConnection` object corresponding to</span>
</span><span id="1-929"><span class="sd">        this :class:`.Session` object&#39;s transactional state.</span>
</span><span id="1-930">
</span><span id="1-931"><span class="sd">        This method may also be used to establish execution options for the</span>
</span><span id="1-932"><span class="sd">        database connection used by the current transaction.</span>
</span><span id="1-933">
</span><span id="1-934"><span class="sd">        .. versionadded:: 1.4.24  Added \**kw arguments which are passed</span>
</span><span id="1-935"><span class="sd">           through to the underlying :meth:`_orm.Session.connection` method.</span>
</span><span id="1-936">
</span><span id="1-937"><span class="sd">        .. seealso::</span>
</span><span id="1-938">
</span><span id="1-939"><span class="sd">            :meth:`_orm.Session.connection` - main documentation for</span>
</span><span id="1-940"><span class="sd">            &quot;connection&quot;</span>
</span><span id="1-941">
</span><span id="1-942"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-943">
</span><span id="1-944">        <span class="n">sync_connection</span> <span class="o">=</span> <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span>
</span><span id="1-945">            <span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span>
</span><span id="1-946">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-947">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-948">            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="1-949">        <span class="p">)</span>
</span><span id="1-950">        <span class="k">return</span> <span class="n">engine</span><span class="o">.</span><span class="n">AsyncConnection</span><span class="o">.</span><span class="n">_retrieve_proxy_for_target</span><span class="p">(</span>
</span><span id="1-951">            <span class="n">sync_connection</span>
</span><span id="1-952">        <span class="p">)</span>
</span><span id="1-953">
</span><span id="1-954">    <span class="k">def</span><span class="w"> </span><span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncSessionTransaction</span><span class="p">:</span>
</span><span id="1-955"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an :class:`_asyncio.AsyncSessionTransaction` object.</span>
</span><span id="1-956">
</span><span id="1-957"><span class="sd">        The underlying :class:`_orm.Session` will perform the</span>
</span><span id="1-958"><span class="sd">        &quot;begin&quot; action when the :class:`_asyncio.AsyncSessionTransaction`</span>
</span><span id="1-959"><span class="sd">        object is entered::</span>
</span><span id="1-960">
</span><span id="1-961"><span class="sd">            async with async_session.begin():</span>
</span><span id="1-962"><span class="sd">                ...  # ORM transaction is begun</span>
</span><span id="1-963">
</span><span id="1-964"><span class="sd">        Note that database IO will not normally occur when the session-level</span>
</span><span id="1-965"><span class="sd">        transaction is begun, as database transactions begin on an</span>
</span><span id="1-966"><span class="sd">        on-demand basis.  However, the begin block is async to accommodate</span>
</span><span id="1-967"><span class="sd">        for a :meth:`_orm.SessionEvents.after_transaction_create`</span>
</span><span id="1-968"><span class="sd">        event hook that may perform IO.</span>
</span><span id="1-969">
</span><span id="1-970"><span class="sd">        For a general description of ORM begin, see</span>
</span><span id="1-971"><span class="sd">        :meth:`_orm.Session.begin`.</span>
</span><span id="1-972">
</span><span id="1-973"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-974">
</span><span id="1-975">        <span class="k">return</span> <span class="n">AsyncSessionTransaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="1-976">
</span><span id="1-977">    <span class="k">def</span><span class="w"> </span><span class="nf">begin_nested</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncSessionTransaction</span><span class="p">:</span>
</span><span id="1-978"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an :class:`_asyncio.AsyncSessionTransaction` object</span>
</span><span id="1-979"><span class="sd">        which will begin a &quot;nested&quot; transaction, e.g. SAVEPOINT.</span>
</span><span id="1-980">
</span><span id="1-981"><span class="sd">        Behavior is the same as that of :meth:`_asyncio.AsyncSession.begin`.</span>
</span><span id="1-982">
</span><span id="1-983"><span class="sd">        For a general description of ORM begin nested, see</span>
</span><span id="1-984"><span class="sd">        :meth:`_orm.Session.begin_nested`.</span>
</span><span id="1-985">
</span><span id="1-986"><span class="sd">        .. seealso::</span>
</span><span id="1-987">
</span><span id="1-988"><span class="sd">            :ref:`aiosqlite_serializable` - special workarounds required</span>
</span><span id="1-989"><span class="sd">            with the SQLite asyncio driver in order for SAVEPOINT to work</span>
</span><span id="1-990"><span class="sd">            correctly.</span>
</span><span id="1-991">
</span><span id="1-992"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-993">
</span><span id="1-994">        <span class="k">return</span> <span class="n">AsyncSessionTransaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-995">
</span><span id="1-996">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-997"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Rollback the current transaction in progress.</span>
</span><span id="1-998">
</span><span id="1-999"><span class="sd">        .. seealso::</span>
</span><span id="1-1000">
</span><span id="1-1001"><span class="sd">            :meth:`_orm.Session.rollback` - main documentation for</span>
</span><span id="1-1002"><span class="sd">            &quot;rollback&quot;</span>
</span><span id="1-1003"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1004">        <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">rollback</span><span class="p">)</span>
</span><span id="1-1005">
</span><span id="1-1006">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1007"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Commit the current transaction in progress.</span>
</span><span id="1-1008">
</span><span id="1-1009"><span class="sd">        .. seealso::</span>
</span><span id="1-1010">
</span><span id="1-1011"><span class="sd">            :meth:`_orm.Session.commit` - main documentation for</span>
</span><span id="1-1012"><span class="sd">            &quot;commit&quot;</span>
</span><span id="1-1013"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1014">        <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>
</span><span id="1-1015">
</span><span id="1-1016">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1017"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close out the transactional resources and ORM objects used by this</span>
</span><span id="1-1018"><span class="sd">        :class:`_asyncio.AsyncSession`.</span>
</span><span id="1-1019">
</span><span id="1-1020"><span class="sd">        .. seealso::</span>
</span><span id="1-1021">
</span><span id="1-1022"><span class="sd">            :meth:`_orm.Session.close` - main documentation for</span>
</span><span id="1-1023"><span class="sd">            &quot;close&quot;</span>
</span><span id="1-1024">
</span><span id="1-1025"><span class="sd">            :ref:`session_closing` - detail on the semantics of</span>
</span><span id="1-1026"><span class="sd">            :meth:`_asyncio.AsyncSession.close` and</span>
</span><span id="1-1027"><span class="sd">            :meth:`_asyncio.AsyncSession.reset`.</span>
</span><span id="1-1028">
</span><span id="1-1029"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1030">        <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
</span><span id="1-1031">
</span><span id="1-1032">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1033"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close out the transactional resources and ORM objects used by this</span>
</span><span id="1-1034"><span class="sd">        :class:`_orm.Session`, resetting the session to its initial state.</span>
</span><span id="1-1035">
</span><span id="1-1036"><span class="sd">        .. versionadded:: 2.0.22</span>
</span><span id="1-1037">
</span><span id="1-1038"><span class="sd">        .. seealso::</span>
</span><span id="1-1039">
</span><span id="1-1040"><span class="sd">            :meth:`_orm.Session.reset` - main documentation for</span>
</span><span id="1-1041"><span class="sd">            &quot;reset&quot;</span>
</span><span id="1-1042">
</span><span id="1-1043"><span class="sd">            :ref:`session_closing` - detail on the semantics of</span>
</span><span id="1-1044"><span class="sd">            :meth:`_asyncio.AsyncSession.close` and</span>
</span><span id="1-1045"><span class="sd">            :meth:`_asyncio.AsyncSession.reset`.</span>
</span><span id="1-1046">
</span><span id="1-1047"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1048">        <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">reset</span><span class="p">)</span>
</span><span id="1-1049">
</span><span id="1-1050">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aclose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1051"><span class="w">        </span><span class="sd">&quot;&quot;&quot;A synonym for :meth:`_asyncio.AsyncSession.close`.</span>
</span><span id="1-1052">
</span><span id="1-1053"><span class="sd">        The :meth:`_asyncio.AsyncSession.aclose` name is specifically</span>
</span><span id="1-1054"><span class="sd">        to support the Python standard library ``@contextlib.aclosing``</span>
</span><span id="1-1055"><span class="sd">        context manager function.</span>
</span><span id="1-1056">
</span><span id="1-1057"><span class="sd">        .. versionadded:: 2.0.20</span>
</span><span id="1-1058">
</span><span id="1-1059"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1060">        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="1-1061">
</span><span id="1-1062">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1063"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close this Session, using connection invalidation.</span>
</span><span id="1-1064">
</span><span id="1-1065"><span class="sd">        For a complete description, see :meth:`_orm.Session.invalidate`.</span>
</span><span id="1-1066"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1067">        <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">invalidate</span><span class="p">)</span>
</span><span id="1-1068">
</span><span id="1-1069">    <span class="nd">@classmethod</span>
</span><span id="1-1070">    <span class="nd">@util</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
</span><span id="1-1071">        <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
</span><span id="1-1072">        <span class="s2">&quot;The :meth:`.AsyncSession.close_all` method is deprecated and will be &quot;</span>
</span><span id="1-1073">        <span class="s2">&quot;removed in a future release.  Please refer to &quot;</span>
</span><span id="1-1074">        <span class="s2">&quot;:func:`_asyncio.close_all_sessions`.&quot;</span><span class="p">,</span>
</span><span id="1-1075">    <span class="p">)</span>
</span><span id="1-1076">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close_all</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1077"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close all :class:`_asyncio.AsyncSession` sessions.&quot;&quot;&quot;</span>
</span><span id="1-1078">        <span class="k">await</span> <span class="n">close_all_sessions</span><span class="p">()</span>
</span><span id="1-1079">
</span><span id="1-1080">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">_AS</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AS</span><span class="p">:</span>
</span><span id="1-1081">        <span class="k">return</span> <span class="bp">self</span>
</span><span id="1-1082">
</span><span id="1-1083">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">traceback</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1084">        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">())</span>
</span><span id="1-1085">        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">shield</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span id="1-1086">
</span><span id="1-1087">    <span class="k">def</span><span class="w"> </span><span class="nf">_maker_context_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">_AS</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AsyncSessionContextManager</span><span class="p">[</span><span class="n">_AS</span><span class="p">]:</span>
</span><span id="1-1088">        <span class="k">return</span> <span class="n">_AsyncSessionContextManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="1-1089">
</span><span id="1-1090">    <span class="c1"># START PROXY METHODS AsyncSession</span>
</span><span id="1-1091">
</span><span id="1-1092">    <span class="c1"># code within this block is **programmatically,</span>
</span><span id="1-1093">    <span class="c1"># statically generated** by tools/generate_proxy_methods.py</span>
</span><span id="1-1094">
</span><span id="1-1095">    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1096"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return True if the instance is associated with this session.</span>
</span><span id="1-1097">
</span><span id="1-1098"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1099">
</span><span id="1-1100"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1101"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1102">
</span><span id="1-1103"><span class="sd">        The instance may be pending or persistent within the Session for a</span>
</span><span id="1-1104"><span class="sd">        result of True.</span>
</span><span id="1-1105">
</span><span id="1-1106">
</span><span id="1-1107"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1108">
</span><span id="1-1109">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-1110">
</span><span id="1-1111">    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">object</span><span class="p">]:</span>
</span><span id="1-1112"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Iterate over all pending or persistent instances within this</span>
</span><span id="1-1113"><span class="sd">        Session.</span>
</span><span id="1-1114">
</span><span id="1-1115"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1116">
</span><span id="1-1117"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1118"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1119">
</span><span id="1-1120">
</span><span id="1-1121"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1122">
</span><span id="1-1123">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
</span><span id="1-1124">
</span><span id="1-1125">    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">_warn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1126"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Place an object into this :class:`_orm.Session`.</span>
</span><span id="1-1127">
</span><span id="1-1128"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1129">
</span><span id="1-1130"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1131"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1132">
</span><span id="1-1133"><span class="sd">        Objects that are in the :term:`transient` state when passed to the</span>
</span><span id="1-1134"><span class="sd">        :meth:`_orm.Session.add` method will move to the</span>
</span><span id="1-1135"><span class="sd">        :term:`pending` state, until the next flush, at which point they</span>
</span><span id="1-1136"><span class="sd">        will move to the :term:`persistent` state.</span>
</span><span id="1-1137">
</span><span id="1-1138"><span class="sd">        Objects that are in the :term:`detached` state when passed to the</span>
</span><span id="1-1139"><span class="sd">        :meth:`_orm.Session.add` method will move to the :term:`persistent`</span>
</span><span id="1-1140"><span class="sd">        state directly.</span>
</span><span id="1-1141">
</span><span id="1-1142"><span class="sd">        If the transaction used by the :class:`_orm.Session` is rolled back,</span>
</span><span id="1-1143"><span class="sd">        objects which were transient when they were passed to</span>
</span><span id="1-1144"><span class="sd">        :meth:`_orm.Session.add` will be moved back to the</span>
</span><span id="1-1145"><span class="sd">        :term:`transient` state, and will no longer be present within this</span>
</span><span id="1-1146"><span class="sd">        :class:`_orm.Session`.</span>
</span><span id="1-1147">
</span><span id="1-1148"><span class="sd">        .. seealso::</span>
</span><span id="1-1149">
</span><span id="1-1150"><span class="sd">            :meth:`_orm.Session.add_all`</span>
</span><span id="1-1151">
</span><span id="1-1152"><span class="sd">            :ref:`session_adding` - at :ref:`session_basics`</span>
</span><span id="1-1153">
</span><span id="1-1154">
</span><span id="1-1155"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1156">
</span><span id="1-1157">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">_warn</span><span class="o">=</span><span class="n">_warn</span><span class="p">)</span>
</span><span id="1-1158">
</span><span id="1-1159">    <span class="k">def</span><span class="w"> </span><span class="nf">add_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1160"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Add the given collection of instances to this :class:`_orm.Session`.</span>
</span><span id="1-1161">
</span><span id="1-1162"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1163">
</span><span id="1-1164"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1165"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1166">
</span><span id="1-1167"><span class="sd">        See the documentation for :meth:`_orm.Session.add` for a general</span>
</span><span id="1-1168"><span class="sd">        behavioral description.</span>
</span><span id="1-1169">
</span><span id="1-1170"><span class="sd">        .. seealso::</span>
</span><span id="1-1171">
</span><span id="1-1172"><span class="sd">            :meth:`_orm.Session.add`</span>
</span><span id="1-1173">
</span><span id="1-1174"><span class="sd">            :ref:`session_adding` - at :ref:`session_basics`</span>
</span><span id="1-1175">
</span><span id="1-1176">
</span><span id="1-1177"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1178">
</span><span id="1-1179">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
</span><span id="1-1180">
</span><span id="1-1181">    <span class="k">def</span><span class="w"> </span><span class="nf">expire</span><span class="p">(</span>
</span><span id="1-1182">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1183">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1184"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Expire the attributes on an instance.</span>
</span><span id="1-1185">
</span><span id="1-1186"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1187">
</span><span id="1-1188"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1189"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1190">
</span><span id="1-1191"><span class="sd">        Marks the attributes of an instance as out of date. When an expired</span>
</span><span id="1-1192"><span class="sd">        attribute is next accessed, a query will be issued to the</span>
</span><span id="1-1193"><span class="sd">        :class:`.Session` object&#39;s current transactional context in order to</span>
</span><span id="1-1194"><span class="sd">        load all expired attributes for the given instance.   Note that</span>
</span><span id="1-1195"><span class="sd">        a highly isolated transaction will return the same values as were</span>
</span><span id="1-1196"><span class="sd">        previously read in that same transaction, regardless of changes</span>
</span><span id="1-1197"><span class="sd">        in database state outside of that transaction.</span>
</span><span id="1-1198">
</span><span id="1-1199"><span class="sd">        To expire all objects in the :class:`.Session` simultaneously,</span>
</span><span id="1-1200"><span class="sd">        use :meth:`Session.expire_all`.</span>
</span><span id="1-1201">
</span><span id="1-1202"><span class="sd">        The :class:`.Session` object&#39;s default behavior is to</span>
</span><span id="1-1203"><span class="sd">        expire all state whenever the :meth:`Session.rollback`</span>
</span><span id="1-1204"><span class="sd">        or :meth:`Session.commit` methods are called, so that new</span>
</span><span id="1-1205"><span class="sd">        state can be loaded for the new transaction.   For this reason,</span>
</span><span id="1-1206"><span class="sd">        calling :meth:`Session.expire` only makes sense for the specific</span>
</span><span id="1-1207"><span class="sd">        case that a non-ORM SQL statement was emitted in the current</span>
</span><span id="1-1208"><span class="sd">        transaction.</span>
</span><span id="1-1209">
</span><span id="1-1210"><span class="sd">        :param instance: The instance to be refreshed.</span>
</span><span id="1-1211"><span class="sd">        :param attribute_names: optional list of string attribute names</span>
</span><span id="1-1212"><span class="sd">          indicating a subset of attributes to be expired.</span>
</span><span id="1-1213">
</span><span id="1-1214"><span class="sd">        .. seealso::</span>
</span><span id="1-1215">
</span><span id="1-1216"><span class="sd">            :ref:`session_expire` - introductory material</span>
</span><span id="1-1217">
</span><span id="1-1218"><span class="sd">            :meth:`.Session.expire`</span>
</span><span id="1-1219">
</span><span id="1-1220"><span class="sd">            :meth:`.Session.refresh`</span>
</span><span id="1-1221">
</span><span id="1-1222"><span class="sd">            :meth:`_orm.Query.populate_existing`</span>
</span><span id="1-1223">
</span><span id="1-1224">
</span><span id="1-1225"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1226">
</span><span id="1-1227">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attribute_names</span><span class="o">=</span><span class="n">attribute_names</span><span class="p">)</span>
</span><span id="1-1228">
</span><span id="1-1229">    <span class="k">def</span><span class="w"> </span><span class="nf">expire_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1230"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Expires all persistent instances within this Session.</span>
</span><span id="1-1231">
</span><span id="1-1232"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1233">
</span><span id="1-1234"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1235"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1236">
</span><span id="1-1237"><span class="sd">        When any attributes on a persistent instance is next accessed,</span>
</span><span id="1-1238"><span class="sd">        a query will be issued using the</span>
</span><span id="1-1239"><span class="sd">        :class:`.Session` object&#39;s current transactional context in order to</span>
</span><span id="1-1240"><span class="sd">        load all expired attributes for the given instance.   Note that</span>
</span><span id="1-1241"><span class="sd">        a highly isolated transaction will return the same values as were</span>
</span><span id="1-1242"><span class="sd">        previously read in that same transaction, regardless of changes</span>
</span><span id="1-1243"><span class="sd">        in database state outside of that transaction.</span>
</span><span id="1-1244">
</span><span id="1-1245"><span class="sd">        To expire individual objects and individual attributes</span>
</span><span id="1-1246"><span class="sd">        on those objects, use :meth:`Session.expire`.</span>
</span><span id="1-1247">
</span><span id="1-1248"><span class="sd">        The :class:`.Session` object&#39;s default behavior is to</span>
</span><span id="1-1249"><span class="sd">        expire all state whenever the :meth:`Session.rollback`</span>
</span><span id="1-1250"><span class="sd">        or :meth:`Session.commit` methods are called, so that new</span>
</span><span id="1-1251"><span class="sd">        state can be loaded for the new transaction.   For this reason,</span>
</span><span id="1-1252"><span class="sd">        calling :meth:`Session.expire_all` is not usually needed,</span>
</span><span id="1-1253"><span class="sd">        assuming the transaction is isolated.</span>
</span><span id="1-1254">
</span><span id="1-1255"><span class="sd">        .. seealso::</span>
</span><span id="1-1256">
</span><span id="1-1257"><span class="sd">            :ref:`session_expire` - introductory material</span>
</span><span id="1-1258">
</span><span id="1-1259"><span class="sd">            :meth:`.Session.expire`</span>
</span><span id="1-1260">
</span><span id="1-1261"><span class="sd">            :meth:`.Session.refresh`</span>
</span><span id="1-1262">
</span><span id="1-1263"><span class="sd">            :meth:`_orm.Query.populate_existing`</span>
</span><span id="1-1264">
</span><span id="1-1265">
</span><span id="1-1266"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1267">
</span><span id="1-1268">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">expire_all</span><span class="p">()</span>
</span><span id="1-1269">
</span><span id="1-1270">    <span class="k">def</span><span class="w"> </span><span class="nf">expunge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1271"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Remove the `instance` from this ``Session``.</span>
</span><span id="1-1272">
</span><span id="1-1273"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1274">
</span><span id="1-1275"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1276"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1277">
</span><span id="1-1278"><span class="sd">        This will free all internal references to the instance.  Cascading</span>
</span><span id="1-1279"><span class="sd">        will be applied according to the *expunge* cascade rule.</span>
</span><span id="1-1280">
</span><span id="1-1281">
</span><span id="1-1282"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1283">
</span><span id="1-1284">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">expunge</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-1285">
</span><span id="1-1286">    <span class="k">def</span><span class="w"> </span><span class="nf">expunge_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1287"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Remove all object instances from this ``Session``.</span>
</span><span id="1-1288">
</span><span id="1-1289"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1290">
</span><span id="1-1291"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1292"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1293">
</span><span id="1-1294"><span class="sd">        This is equivalent to calling ``expunge(obj)`` on all objects in this</span>
</span><span id="1-1295"><span class="sd">        ``Session``.</span>
</span><span id="1-1296">
</span><span id="1-1297">
</span><span id="1-1298"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1299">
</span><span id="1-1300">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">expunge_all</span><span class="p">()</span>
</span><span id="1-1301">
</span><span id="1-1302">    <span class="k">def</span><span class="w"> </span><span class="nf">is_modified</span><span class="p">(</span>
</span><span id="1-1303">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">include_collections</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1304">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1305"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return ``True`` if the given instance has locally</span>
</span><span id="1-1306"><span class="sd">        modified attributes.</span>
</span><span id="1-1307">
</span><span id="1-1308"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1309">
</span><span id="1-1310"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1311"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1312">
</span><span id="1-1313"><span class="sd">        This method retrieves the history for each instrumented</span>
</span><span id="1-1314"><span class="sd">        attribute on the instance and performs a comparison of the current</span>
</span><span id="1-1315"><span class="sd">        value to its previously flushed or committed value, if any.</span>
</span><span id="1-1316">
</span><span id="1-1317"><span class="sd">        It is in effect a more expensive and accurate</span>
</span><span id="1-1318"><span class="sd">        version of checking for the given instance in the</span>
</span><span id="1-1319"><span class="sd">        :attr:`.Session.dirty` collection; a full test for</span>
</span><span id="1-1320"><span class="sd">        each attribute&#39;s net &quot;dirty&quot; status is performed.</span>
</span><span id="1-1321">
</span><span id="1-1322"><span class="sd">        E.g.::</span>
</span><span id="1-1323">
</span><span id="1-1324"><span class="sd">            return session.is_modified(someobject)</span>
</span><span id="1-1325">
</span><span id="1-1326"><span class="sd">        A few caveats to this method apply:</span>
</span><span id="1-1327">
</span><span id="1-1328"><span class="sd">        * Instances present in the :attr:`.Session.dirty` collection may</span>
</span><span id="1-1329"><span class="sd">          report ``False`` when tested with this method.  This is because</span>
</span><span id="1-1330"><span class="sd">          the object may have received change events via attribute mutation,</span>
</span><span id="1-1331"><span class="sd">          thus placing it in :attr:`.Session.dirty`, but ultimately the state</span>
</span><span id="1-1332"><span class="sd">          is the same as that loaded from the database, resulting in no net</span>
</span><span id="1-1333"><span class="sd">          change here.</span>
</span><span id="1-1334"><span class="sd">        * Scalar attributes may not have recorded the previously set</span>
</span><span id="1-1335"><span class="sd">          value when a new value was applied, if the attribute was not loaded,</span>
</span><span id="1-1336"><span class="sd">          or was expired, at the time the new value was received - in these</span>
</span><span id="1-1337"><span class="sd">          cases, the attribute is assumed to have a change, even if there is</span>
</span><span id="1-1338"><span class="sd">          ultimately no net change against its database value. SQLAlchemy in</span>
</span><span id="1-1339"><span class="sd">          most cases does not need the &quot;old&quot; value when a set event occurs, so</span>
</span><span id="1-1340"><span class="sd">          it skips the expense of a SQL call if the old value isn&#39;t present,</span>
</span><span id="1-1341"><span class="sd">          based on the assumption that an UPDATE of the scalar value is</span>
</span><span id="1-1342"><span class="sd">          usually needed, and in those few cases where it isn&#39;t, is less</span>
</span><span id="1-1343"><span class="sd">          expensive on average than issuing a defensive SELECT.</span>
</span><span id="1-1344">
</span><span id="1-1345"><span class="sd">          The &quot;old&quot; value is fetched unconditionally upon set only if the</span>
</span><span id="1-1346"><span class="sd">          attribute container has the ``active_history`` flag set to ``True``.</span>
</span><span id="1-1347"><span class="sd">          This flag is set typically for primary key attributes and scalar</span>
</span><span id="1-1348"><span class="sd">          object references that are not a simple many-to-one.  To set this</span>
</span><span id="1-1349"><span class="sd">          flag for any arbitrary mapped column, use the ``active_history``</span>
</span><span id="1-1350"><span class="sd">          argument with :func:`.column_property`.</span>
</span><span id="1-1351">
</span><span id="1-1352"><span class="sd">        :param instance: mapped instance to be tested for pending changes.</span>
</span><span id="1-1353"><span class="sd">        :param include_collections: Indicates if multivalued collections</span>
</span><span id="1-1354"><span class="sd">         should be included in the operation.  Setting this to ``False`` is a</span>
</span><span id="1-1355"><span class="sd">         way to detect only local-column based properties (i.e. scalar columns</span>
</span><span id="1-1356"><span class="sd">         or many-to-one foreign keys) that would result in an UPDATE for this</span>
</span><span id="1-1357"><span class="sd">         instance upon flush.</span>
</span><span id="1-1358">
</span><span id="1-1359">
</span><span id="1-1360"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1361">
</span><span id="1-1362">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">is_modified</span><span class="p">(</span>
</span><span id="1-1363">            <span class="n">instance</span><span class="p">,</span> <span class="n">include_collections</span><span class="o">=</span><span class="n">include_collections</span>
</span><span id="1-1364">        <span class="p">)</span>
</span><span id="1-1365">
</span><span id="1-1366">    <span class="k">def</span><span class="w"> </span><span class="nf">in_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1367"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return True if this :class:`_orm.Session` has begun a transaction.</span>
</span><span id="1-1368">
</span><span id="1-1369"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1370">
</span><span id="1-1371"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1372"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1373">
</span><span id="1-1374"><span class="sd">        .. versionadded:: 1.4</span>
</span><span id="1-1375">
</span><span id="1-1376"><span class="sd">        .. seealso::</span>
</span><span id="1-1377">
</span><span id="1-1378"><span class="sd">            :attr:`_orm.Session.is_active`</span>
</span><span id="1-1379">
</span><span id="1-1380">
</span><span id="1-1381">
</span><span id="1-1382"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1383">
</span><span id="1-1384">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">()</span>
</span><span id="1-1385">
</span><span id="1-1386">    <span class="k">def</span><span class="w"> </span><span class="nf">in_nested_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1387"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return True if this :class:`_orm.Session` has begun a nested</span>
</span><span id="1-1388"><span class="sd">        transaction, e.g. SAVEPOINT.</span>
</span><span id="1-1389">
</span><span id="1-1390"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1391">
</span><span id="1-1392"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1393"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1394">
</span><span id="1-1395"><span class="sd">        .. versionadded:: 1.4</span>
</span><span id="1-1396">
</span><span id="1-1397">
</span><span id="1-1398"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1399">
</span><span id="1-1400">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">in_nested_transaction</span><span class="p">()</span>
</span><span id="1-1401">
</span><span id="1-1402">    <span class="nd">@property</span>
</span><span id="1-1403">    <span class="k">def</span><span class="w"> </span><span class="nf">dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1404"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The set of all persistent instances considered dirty.</span>
</span><span id="1-1405">
</span><span id="1-1406"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1407">
</span><span id="1-1408"><span class="sd">            Proxied for the :class:`_orm.Session` class</span>
</span><span id="1-1409"><span class="sd">            on behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1410">
</span><span id="1-1411"><span class="sd">        E.g.::</span>
</span><span id="1-1412">
</span><span id="1-1413"><span class="sd">            some_mapped_object in session.dirty</span>
</span><span id="1-1414">
</span><span id="1-1415"><span class="sd">        Instances are considered dirty when they were modified but not</span>
</span><span id="1-1416"><span class="sd">        deleted.</span>
</span><span id="1-1417">
</span><span id="1-1418"><span class="sd">        Note that this &#39;dirty&#39; calculation is &#39;optimistic&#39;; most</span>
</span><span id="1-1419"><span class="sd">        attribute-setting or collection modification operations will</span>
</span><span id="1-1420"><span class="sd">        mark an instance as &#39;dirty&#39; and place it in this set, even if</span>
</span><span id="1-1421"><span class="sd">        there is no net change to the attribute&#39;s value.  At flush</span>
</span><span id="1-1422"><span class="sd">        time, the value of each attribute is compared to its</span>
</span><span id="1-1423"><span class="sd">        previously saved value, and if there&#39;s no net change, no SQL</span>
</span><span id="1-1424"><span class="sd">        operation will occur (this is a more expensive operation so</span>
</span><span id="1-1425"><span class="sd">        it&#39;s only done at flush time).</span>
</span><span id="1-1426">
</span><span id="1-1427"><span class="sd">        To check if an instance has actionable net changes to its</span>
</span><span id="1-1428"><span class="sd">        attributes, use the :meth:`.Session.is_modified` method.</span>
</span><span id="1-1429">
</span><span id="1-1430">
</span><span id="1-1431"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1432">
</span><span id="1-1433">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">dirty</span>
</span><span id="1-1434">
</span><span id="1-1435">    <span class="nd">@property</span>
</span><span id="1-1436">    <span class="k">def</span><span class="w"> </span><span class="nf">deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1437"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The set of all instances marked as &#39;deleted&#39; within this ``Session``</span>
</span><span id="1-1438">
</span><span id="1-1439"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1440">
</span><span id="1-1441"><span class="sd">            Proxied for the :class:`_orm.Session` class</span>
</span><span id="1-1442"><span class="sd">            on behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1443">
</span><span id="1-1444"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1445">
</span><span id="1-1446">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">deleted</span>
</span><span id="1-1447">
</span><span id="1-1448">    <span class="nd">@property</span>
</span><span id="1-1449">    <span class="k">def</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1450"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The set of all instances marked as &#39;new&#39; within this ``Session``.</span>
</span><span id="1-1451">
</span><span id="1-1452"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1453">
</span><span id="1-1454"><span class="sd">            Proxied for the :class:`_orm.Session` class</span>
</span><span id="1-1455"><span class="sd">            on behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1456">
</span><span id="1-1457"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1458">
</span><span id="1-1459">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">new</span>
</span><span id="1-1460">
</span><span id="1-1461">    <span class="nd">@property</span>
</span><span id="1-1462">    <span class="k">def</span><span class="w"> </span><span class="nf">identity_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentityMap</span><span class="p">:</span>
</span><span id="1-1463"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Proxy for the :attr:`_orm.Session.identity_map` attribute</span>
</span><span id="1-1464"><span class="sd">        on behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1465">
</span><span id="1-1466"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1467">
</span><span id="1-1468">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">identity_map</span>
</span><span id="1-1469">
</span><span id="1-1470">    <span class="nd">@identity_map</span><span class="o">.</span><span class="n">setter</span>
</span><span id="1-1471">    <span class="k">def</span><span class="w"> </span><span class="nf">identity_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">IdentityMap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1472">        <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">identity_map</span> <span class="o">=</span> <span class="n">attr</span>
</span><span id="1-1473">
</span><span id="1-1474">    <span class="nd">@property</span>
</span><span id="1-1475">    <span class="k">def</span><span class="w"> </span><span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1476"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;True if this :class:`.Session` not in &quot;partial rollback&quot; state.</span>
</span><span id="1-1477">
</span><span id="1-1478"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1479">
</span><span id="1-1480"><span class="sd">            Proxied for the :class:`_orm.Session` class</span>
</span><span id="1-1481"><span class="sd">            on behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1482">
</span><span id="1-1483"><span class="sd">        .. versionchanged:: 1.4 The :class:`_orm.Session` no longer begins</span>
</span><span id="1-1484"><span class="sd">           a new transaction immediately, so this attribute will be False</span>
</span><span id="1-1485"><span class="sd">           when the :class:`_orm.Session` is first instantiated.</span>
</span><span id="1-1486">
</span><span id="1-1487"><span class="sd">        &quot;partial rollback&quot; state typically indicates that the flush process</span>
</span><span id="1-1488"><span class="sd">        of the :class:`_orm.Session` has failed, and that the</span>
</span><span id="1-1489"><span class="sd">        :meth:`_orm.Session.rollback` method must be emitted in order to</span>
</span><span id="1-1490"><span class="sd">        fully roll back the transaction.</span>
</span><span id="1-1491">
</span><span id="1-1492"><span class="sd">        If this :class:`_orm.Session` is not in a transaction at all, the</span>
</span><span id="1-1493"><span class="sd">        :class:`_orm.Session` will autobegin when it is first used, so in this</span>
</span><span id="1-1494"><span class="sd">        case :attr:`_orm.Session.is_active` will return True.</span>
</span><span id="1-1495">
</span><span id="1-1496"><span class="sd">        Otherwise, if this :class:`_orm.Session` is within a transaction,</span>
</span><span id="1-1497"><span class="sd">        and that transaction has not been rolled back internally, the</span>
</span><span id="1-1498"><span class="sd">        :attr:`_orm.Session.is_active` will also return True.</span>
</span><span id="1-1499">
</span><span id="1-1500"><span class="sd">        .. seealso::</span>
</span><span id="1-1501">
</span><span id="1-1502"><span class="sd">            :ref:`faq_session_rollback`</span>
</span><span id="1-1503">
</span><span id="1-1504"><span class="sd">            :meth:`_orm.Session.in_transaction`</span>
</span><span id="1-1505">
</span><span id="1-1506">
</span><span id="1-1507"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1508">
</span><span id="1-1509">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">is_active</span>
</span><span id="1-1510">
</span><span id="1-1511">    <span class="nd">@property</span>
</span><span id="1-1512">    <span class="k">def</span><span class="w"> </span><span class="nf">autoflush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1513"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Proxy for the :attr:`_orm.Session.autoflush` attribute</span>
</span><span id="1-1514"><span class="sd">        on behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1515">
</span><span id="1-1516"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1517">
</span><span id="1-1518">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">autoflush</span>
</span><span id="1-1519">
</span><span id="1-1520">    <span class="nd">@autoflush</span><span class="o">.</span><span class="n">setter</span>
</span><span id="1-1521">    <span class="k">def</span><span class="w"> </span><span class="nf">autoflush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1522">        <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">autoflush</span> <span class="o">=</span> <span class="n">attr</span>
</span><span id="1-1523">
</span><span id="1-1524">    <span class="nd">@property</span>
</span><span id="1-1525">    <span class="k">def</span><span class="w"> </span><span class="nf">no_autoflush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1526"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return a context manager that disables autoflush.</span>
</span><span id="1-1527">
</span><span id="1-1528"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1529">
</span><span id="1-1530"><span class="sd">            Proxied for the :class:`_orm.Session` class</span>
</span><span id="1-1531"><span class="sd">            on behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1532">
</span><span id="1-1533"><span class="sd">        e.g.::</span>
</span><span id="1-1534">
</span><span id="1-1535"><span class="sd">            with session.no_autoflush:</span>
</span><span id="1-1536">
</span><span id="1-1537"><span class="sd">                some_object = SomeClass()</span>
</span><span id="1-1538"><span class="sd">                session.add(some_object)</span>
</span><span id="1-1539"><span class="sd">                # won&#39;t autoflush</span>
</span><span id="1-1540"><span class="sd">                some_object.related_thing = session.query(SomeRelated).first()</span>
</span><span id="1-1541">
</span><span id="1-1542"><span class="sd">        Operations that proceed within the ``with:`` block</span>
</span><span id="1-1543"><span class="sd">        will not be subject to flushes occurring upon query</span>
</span><span id="1-1544"><span class="sd">        access.  This is useful when initializing a series</span>
</span><span id="1-1545"><span class="sd">        of objects which involve existing database queries,</span>
</span><span id="1-1546"><span class="sd">        where the uncompleted object should not yet be flushed.</span>
</span><span id="1-1547">
</span><span id="1-1548">
</span><span id="1-1549"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1550">
</span><span id="1-1551">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">no_autoflush</span>
</span><span id="1-1552">
</span><span id="1-1553">    <span class="nd">@property</span>
</span><span id="1-1554">    <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1555"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;A user-modifiable dictionary.</span>
</span><span id="1-1556">
</span><span id="1-1557"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1558">
</span><span id="1-1559"><span class="sd">            Proxied for the :class:`_orm.Session` class</span>
</span><span id="1-1560"><span class="sd">            on behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1561">
</span><span id="1-1562"><span class="sd">        The initial value of this dictionary can be populated using the</span>
</span><span id="1-1563"><span class="sd">        ``info`` argument to the :class:`.Session` constructor or</span>
</span><span id="1-1564"><span class="sd">        :class:`.sessionmaker` constructor or factory methods.  The dictionary</span>
</span><span id="1-1565"><span class="sd">        here is always local to this :class:`.Session` and can be modified</span>
</span><span id="1-1566"><span class="sd">        independently of all other :class:`.Session` objects.</span>
</span><span id="1-1567">
</span><span id="1-1568">
</span><span id="1-1569"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1570">
</span><span id="1-1571">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">info</span>
</span><span id="1-1572">
</span><span id="1-1573">    <span class="nd">@classmethod</span>
</span><span id="1-1574">    <span class="k">def</span><span class="w"> </span><span class="nf">object_session</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
</span><span id="1-1575"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the :class:`.Session` to which an object belongs.</span>
</span><span id="1-1576">
</span><span id="1-1577"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1578">
</span><span id="1-1579"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1580"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1581">
</span><span id="1-1582"><span class="sd">        This is an alias of :func:`.object_session`.</span>
</span><span id="1-1583">
</span><span id="1-1584">
</span><span id="1-1585"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1586">
</span><span id="1-1587">        <span class="k">return</span> <span class="n">Session</span><span class="o">.</span><span class="n">object_session</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-1588">
</span><span id="1-1589">    <span class="nd">@classmethod</span>
</span><span id="1-1590">    <span class="k">def</span><span class="w"> </span><span class="nf">identity_key</span><span class="p">(</span>
</span><span id="1-1591">        <span class="bp">cls</span><span class="p">,</span>
</span><span id="1-1592">        <span class="n">class_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1593">        <span class="n">ident</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1594">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-1595">        <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1596">        <span class="n">row</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Row</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">RowMapping</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1597">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1598">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_IdentityKeyType</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-1599"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return an identity key.</span>
</span><span id="1-1600">
</span><span id="1-1601"><span class="sd">        .. container:: class_bases</span>
</span><span id="1-1602">
</span><span id="1-1603"><span class="sd">            Proxied for the :class:`_orm.Session` class on</span>
</span><span id="1-1604"><span class="sd">            behalf of the :class:`_asyncio.AsyncSession` class.</span>
</span><span id="1-1605">
</span><span id="1-1606"><span class="sd">        This is an alias of :func:`.util.identity_key`.</span>
</span><span id="1-1607">
</span><span id="1-1608">
</span><span id="1-1609"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-1610">
</span><span id="1-1611">        <span class="k">return</span> <span class="n">Session</span><span class="o">.</span><span class="n">identity_key</span><span class="p">(</span>
</span><span id="1-1612">            <span class="n">class_</span><span class="o">=</span><span class="n">class_</span><span class="p">,</span>
</span><span id="1-1613">            <span class="n">ident</span><span class="o">=</span><span class="n">ident</span><span class="p">,</span>
</span><span id="1-1614">            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
</span><span id="1-1615">            <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
</span><span id="1-1616">            <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span id="1-1617">        <span class="p">)</span>
</span><span id="1-1618">
</span><span id="1-1619">    <span class="c1"># END PROXY METHODS AsyncSession</span>
</span><span id="1-1620">
</span><span id="1-1621">
</span><span id="1-1622"><span class="n">_AS</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_AS&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;AsyncSession&quot;</span><span class="p">)</span>
</span><span id="1-1623">
</span><span id="1-1624">
</span><span id="1-1625"><span class="k">class</span><span class="w"> </span><span class="nc">async_sessionmaker</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">_AS</span><span class="p">]):</span>
</span><span id="1-1626"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A configurable :class:`.AsyncSession` factory.</span>
</span><span id="1-1627">
</span><span id="1-1628"><span class="sd">    The :class:`.async_sessionmaker` factory works in the same way as the</span>
</span><span id="1-1629"><span class="sd">    :class:`.sessionmaker` factory, to generate new :class:`.AsyncSession`</span>
</span><span id="1-1630"><span class="sd">    objects when called, creating them given</span>
</span><span id="1-1631"><span class="sd">    the configurational arguments established here.</span>
</span><span id="1-1632">
</span><span id="1-1633"><span class="sd">    e.g.::</span>
</span><span id="1-1634">
</span><span id="1-1635"><span class="sd">        from sqlalchemy.ext.asyncio import create_async_engine</span>
</span><span id="1-1636"><span class="sd">        from sqlalchemy.ext.asyncio import AsyncSession</span>
</span><span id="1-1637"><span class="sd">        from sqlalchemy.ext.asyncio import async_sessionmaker</span>
</span><span id="1-1638">
</span><span id="1-1639">
</span><span id="1-1640"><span class="sd">        async def run_some_sql(</span>
</span><span id="1-1641"><span class="sd">            async_session: async_sessionmaker[AsyncSession],</span>
</span><span id="1-1642"><span class="sd">        ) -&gt; None:</span>
</span><span id="1-1643"><span class="sd">            async with async_session() as session:</span>
</span><span id="1-1644"><span class="sd">                session.add(SomeObject(data=&quot;object&quot;))</span>
</span><span id="1-1645"><span class="sd">                session.add(SomeOtherObject(name=&quot;other object&quot;))</span>
</span><span id="1-1646"><span class="sd">                await session.commit()</span>
</span><span id="1-1647">
</span><span id="1-1648">
</span><span id="1-1649"><span class="sd">        async def main() -&gt; None:</span>
</span><span id="1-1650"><span class="sd">            # an AsyncEngine, which the AsyncSession will use for connection</span>
</span><span id="1-1651"><span class="sd">            # resources</span>
</span><span id="1-1652"><span class="sd">            engine = create_async_engine(</span>
</span><span id="1-1653"><span class="sd">                &quot;postgresql+asyncpg://scott:tiger@localhost/&quot;</span>
</span><span id="1-1654"><span class="sd">            )</span>
</span><span id="1-1655">
</span><span id="1-1656"><span class="sd">            # create a reusable factory for new AsyncSession instances</span>
</span><span id="1-1657"><span class="sd">            async_session = async_sessionmaker(engine)</span>
</span><span id="1-1658">
</span><span id="1-1659"><span class="sd">            await run_some_sql(async_session)</span>
</span><span id="1-1660">
</span><span id="1-1661"><span class="sd">            await engine.dispose()</span>
</span><span id="1-1662">
</span><span id="1-1663"><span class="sd">    The :class:`.async_sessionmaker` is useful so that different parts</span>
</span><span id="1-1664"><span class="sd">    of a program can create new :class:`.AsyncSession` objects with a</span>
</span><span id="1-1665"><span class="sd">    fixed configuration established up front.  Note that :class:`.AsyncSession`</span>
</span><span id="1-1666"><span class="sd">    objects may also be instantiated directly when not using</span>
</span><span id="1-1667"><span class="sd">    :class:`.async_sessionmaker`.</span>
</span><span id="1-1668">
</span><span id="1-1669"><span class="sd">    .. versionadded:: 2.0  :class:`.async_sessionmaker` provides a</span>
</span><span id="1-1670"><span class="sd">       :class:`.sessionmaker` class that&#39;s dedicated to the</span>
</span><span id="1-1671"><span class="sd">       :class:`.AsyncSession` object, including pep-484 typing support.</span>
</span><span id="1-1672">
</span><span id="1-1673"><span class="sd">    .. seealso::</span>
</span><span id="1-1674">
</span><span id="1-1675"><span class="sd">        :ref:`asyncio_orm` - shows example use</span>
</span><span id="1-1676">
</span><span id="1-1677"><span class="sd">        :class:`.sessionmaker`  - general overview of the</span>
</span><span id="1-1678"><span class="sd">         :class:`.sessionmaker` architecture</span>
</span><span id="1-1679">
</span><span id="1-1680">
</span><span id="1-1681"><span class="sd">        :ref:`session_getting` - introductory text on creating</span>
</span><span id="1-1682"><span class="sd">        sessions using :class:`.sessionmaker`.</span>
</span><span id="1-1683">
</span><span id="1-1684"><span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa E501</span>
</span><span id="1-1685">
</span><span id="1-1686">    <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_AS</span><span class="p">]</span>
</span><span id="1-1687">
</span><span id="1-1688">    <span class="nd">@overload</span>
</span><span id="1-1689">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-1690">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1691">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AsyncSessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1692">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-1693">        <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_AS</span><span class="p">],</span>
</span><span id="1-1694">        <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1695">        <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1696">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1697">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1698">    <span class="p">):</span> <span class="o">...</span>
</span><span id="1-1699">
</span><span id="1-1700">    <span class="nd">@overload</span>
</span><span id="1-1701">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-1702">        <span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;async_sessionmaker[AsyncSession]&quot;</span><span class="p">,</span>
</span><span id="1-1703">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AsyncSessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1704">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-1705">        <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1706">        <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1707">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1708">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1709">    <span class="p">):</span> <span class="o">...</span>
</span><span id="1-1710">
</span><span id="1-1711">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-1712">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1713">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AsyncSessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1714">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-1715">        <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_AS</span><span class="p">]</span> <span class="o">=</span> <span class="n">AsyncSession</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
</span><span id="1-1716">        <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-1717">        <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-1718">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1719">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1720">    <span class="p">):</span>
</span><span id="1-1721"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a new :class:`.async_sessionmaker`.</span>
</span><span id="1-1722">
</span><span id="1-1723"><span class="sd">        All arguments here except for ``class_`` correspond to arguments</span>
</span><span id="1-1724"><span class="sd">        accepted by :class:`.Session` directly. See the</span>
</span><span id="1-1725"><span class="sd">        :meth:`.AsyncSession.__init__` docstring for more details on</span>
</span><span id="1-1726"><span class="sd">        parameters.</span>
</span><span id="1-1727">
</span><span id="1-1728">
</span><span id="1-1729"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1730">        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;bind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
</span><span id="1-1731">        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;autoflush&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">autoflush</span>
</span><span id="1-1732">        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;expire_on_commit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expire_on_commit</span>
</span><span id="1-1733">        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1734">            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
</span><span id="1-1735">        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="n">kw</span>
</span><span id="1-1736">        <span class="bp">self</span><span class="o">.</span><span class="n">class_</span> <span class="o">=</span> <span class="n">class_</span>
</span><span id="1-1737">
</span><span id="1-1738">    <span class="k">def</span><span class="w"> </span><span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AsyncSessionContextManager</span><span class="p">[</span><span class="n">_AS</span><span class="p">]:</span>
</span><span id="1-1739"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a context manager that both provides a new</span>
</span><span id="1-1740"><span class="sd">        :class:`_orm.AsyncSession` as well as a transaction that commits.</span>
</span><span id="1-1741">
</span><span id="1-1742">
</span><span id="1-1743"><span class="sd">        e.g.::</span>
</span><span id="1-1744">
</span><span id="1-1745"><span class="sd">            async def main():</span>
</span><span id="1-1746"><span class="sd">                Session = async_sessionmaker(some_engine)</span>
</span><span id="1-1747">
</span><span id="1-1748"><span class="sd">                async with Session.begin() as session:</span>
</span><span id="1-1749"><span class="sd">                    session.add(some_object)</span>
</span><span id="1-1750">
</span><span id="1-1751"><span class="sd">                # commits transaction, closes session</span>
</span><span id="1-1752">
</span><span id="1-1753"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1754">
</span><span id="1-1755">        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="p">()</span>
</span><span id="1-1756">        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">_maker_context_manager</span><span class="p">()</span>
</span><span id="1-1757">
</span><span id="1-1758">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">local_kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AS</span><span class="p">:</span>
</span><span id="1-1759"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a new :class:`.AsyncSession` object using the configuration</span>
</span><span id="1-1760"><span class="sd">        established in this :class:`.async_sessionmaker`.</span>
</span><span id="1-1761">
</span><span id="1-1762"><span class="sd">        In Python, the ``__call__`` method is invoked on an object when</span>
</span><span id="1-1763"><span class="sd">        it is &quot;called&quot; in the same way as a function::</span>
</span><span id="1-1764">
</span><span id="1-1765"><span class="sd">            AsyncSession = async_sessionmaker(async_engine, expire_on_commit=False)</span>
</span><span id="1-1766"><span class="sd">            session = AsyncSession()  # invokes sessionmaker.__call__()</span>
</span><span id="1-1767">
</span><span id="1-1768"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa E501</span>
</span><span id="1-1769">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="1-1770">            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span> <span class="ow">and</span> <span class="s2">&quot;info&quot;</span> <span class="ow">in</span> <span class="n">local_kw</span><span class="p">:</span>
</span><span id="1-1771">                <span class="n">d</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="1-1772">                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">local_kw</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">])</span>
</span><span id="1-1773">                <span class="n">local_kw</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="1-1774">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1775">                <span class="n">local_kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span id="1-1776">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">(</span><span class="o">**</span><span class="n">local_kw</span><span class="p">)</span>
</span><span id="1-1777">
</span><span id="1-1778">    <span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">new_kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1779"><span class="w">        </span><span class="sd">&quot;&quot;&quot;(Re)configure the arguments for this async_sessionmaker.</span>
</span><span id="1-1780">
</span><span id="1-1781"><span class="sd">        e.g.::</span>
</span><span id="1-1782">
</span><span id="1-1783"><span class="sd">            AsyncSession = async_sessionmaker(some_engine)</span>
</span><span id="1-1784">
</span><span id="1-1785"><span class="sd">            AsyncSession.configure(bind=create_async_engine(&quot;sqlite+aiosqlite://&quot;))</span>
</span><span id="1-1786"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa E501</span>
</span><span id="1-1787">
</span><span id="1-1788">        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
</span><span id="1-1789">
</span><span id="1-1790">    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="1-1791">        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(class_=</span><span class="si">%r</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="1-1792">            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="1-1793">            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="1-1794">            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
</span><span id="1-1795">        <span class="p">)</span>
</span><span id="1-1796">
</span><span id="1-1797">
</span><span id="1-1798"><span class="k">class</span><span class="w"> </span><span class="nc">_AsyncSessionContextManager</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">_AS</span><span class="p">]):</span>
</span><span id="1-1799">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;async_session&quot;</span><span class="p">,</span> <span class="s2">&quot;trans&quot;</span><span class="p">)</span>
</span><span id="1-1800">
</span><span id="1-1801">    <span class="n">async_session</span><span class="p">:</span> <span class="n">_AS</span>
</span><span id="1-1802">    <span class="n">trans</span><span class="p">:</span> <span class="n">AsyncSessionTransaction</span>
</span><span id="1-1803">
</span><span id="1-1804">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">async_session</span><span class="p">:</span> <span class="n">_AS</span><span class="p">):</span>
</span><span id="1-1805">        <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span> <span class="o">=</span> <span class="n">async_session</span>
</span><span id="1-1806">
</span><span id="1-1807">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AS</span><span class="p">:</span>
</span><span id="1-1808">        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
</span><span id="1-1809">        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">()</span>
</span><span id="1-1810">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span>
</span><span id="1-1811">
</span><span id="1-1812">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">traceback</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1813">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">go</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1814">            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
</span><span id="1-1815">            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
</span><span id="1-1816">
</span><span id="1-1817">        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">go</span><span class="p">())</span>
</span><span id="1-1818">        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">shield</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span id="1-1819">
</span><span id="1-1820">
</span><span id="1-1821"><span class="k">class</span><span class="w"> </span><span class="nc">AsyncSessionTransaction</span><span class="p">(</span>
</span><span id="1-1822">    <span class="n">ReversibleProxy</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">],</span>
</span><span id="1-1823">    <span class="n">StartableContext</span><span class="p">[</span><span class="s2">&quot;AsyncSessionTransaction&quot;</span><span class="p">],</span>
</span><span id="1-1824"><span class="p">):</span>
</span><span id="1-1825"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A wrapper for the ORM :class:`_orm.SessionTransaction` object.</span>
</span><span id="1-1826">
</span><span id="1-1827"><span class="sd">    This object is provided so that a transaction-holding object</span>
</span><span id="1-1828"><span class="sd">    for the :meth:`_asyncio.AsyncSession.begin` may be returned.</span>
</span><span id="1-1829">
</span><span id="1-1830"><span class="sd">    The object supports both explicit calls to</span>
</span><span id="1-1831"><span class="sd">    :meth:`_asyncio.AsyncSessionTransaction.commit` and</span>
</span><span id="1-1832"><span class="sd">    :meth:`_asyncio.AsyncSessionTransaction.rollback`, as well as use as an</span>
</span><span id="1-1833"><span class="sd">    async context manager.</span>
</span><span id="1-1834">
</span><span id="1-1835">
</span><span id="1-1836"><span class="sd">    .. versionadded:: 1.4</span>
</span><span id="1-1837">
</span><span id="1-1838"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-1839">
</span><span id="1-1840">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="s2">&quot;sync_transaction&quot;</span><span class="p">,</span> <span class="s2">&quot;nested&quot;</span><span class="p">)</span>
</span><span id="1-1841">
</span><span id="1-1842">    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span>
</span><span id="1-1843">    <span class="n">sync_transaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]</span>
</span><span id="1-1844">
</span><span id="1-1845">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">nested</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="1-1846">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
</span><span id="1-1847">        <span class="bp">self</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="n">nested</span>
</span><span id="1-1848">        <span class="bp">self</span><span class="o">.</span><span class="n">sync_transaction</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1849">
</span><span id="1-1850">    <span class="nd">@property</span>
</span><span id="1-1851">    <span class="k">def</span><span class="w"> </span><span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1852">        <span class="k">return</span> <span class="p">(</span>
</span><span id="1-1853">            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_transaction</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1854">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sync_transaction</span><span class="p">()</span><span class="o">.</span><span class="n">is_active</span>
</span><span id="1-1855">        <span class="p">)</span>
</span><span id="1-1856">
</span><span id="1-1857">    <span class="k">def</span><span class="w"> </span><span class="nf">_sync_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SessionTransaction</span><span class="p">:</span>
</span><span id="1-1858">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_transaction</span><span class="p">:</span>
</span><span id="1-1859">            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_for_not_started</span><span class="p">()</span>
</span><span id="1-1860">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_transaction</span>
</span><span id="1-1861">
</span><span id="1-1862">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1863"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Roll back this :class:`_asyncio.AsyncTransaction`.&quot;&quot;&quot;</span>
</span><span id="1-1864">        <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sync_transaction</span><span class="p">()</span><span class="o">.</span><span class="n">rollback</span><span class="p">)</span>
</span><span id="1-1865">
</span><span id="1-1866">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1867"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Commit this :class:`_asyncio.AsyncTransaction`.&quot;&quot;&quot;</span>
</span><span id="1-1868">
</span><span id="1-1869">        <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sync_transaction</span><span class="p">()</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>
</span><span id="1-1870">
</span><span id="1-1871">    <span class="nd">@classmethod</span>
</span><span id="1-1872">    <span class="k">def</span><span class="w"> </span><span class="nf">_regenerate_proxy_for_target</span><span class="p">(</span>  <span class="c1"># type: ignore[override]</span>
</span><span id="1-1873">        <span class="bp">cls</span><span class="p">,</span>
</span><span id="1-1874">        <span class="n">target</span><span class="p">:</span> <span class="n">SessionTransaction</span><span class="p">,</span>
</span><span id="1-1875">        <span class="n">async_session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
</span><span id="1-1876">        <span class="o">**</span><span class="n">additional_kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>  <span class="c1"># noqa: U100</span>
</span><span id="1-1877">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncSessionTransaction</span><span class="p">:</span>
</span><span id="1-1878">        <span class="n">sync_transaction</span> <span class="o">=</span> <span class="n">target</span>
</span><span id="1-1879">        <span class="n">nested</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">nested</span>
</span><span id="1-1880">        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-1881">        <span class="n">obj</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">async_session</span>
</span><span id="1-1882">        <span class="n">obj</span><span class="o">.</span><span class="n">sync_transaction</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_assign_proxied</span><span class="p">(</span><span class="n">sync_transaction</span><span class="p">)</span>
</span><span id="1-1883">        <span class="n">obj</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="n">nested</span>
</span><span id="1-1884">        <span class="k">return</span> <span class="n">obj</span>
</span><span id="1-1885">
</span><span id="1-1886">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span>
</span><span id="1-1887">        <span class="bp">self</span><span class="p">,</span> <span class="n">is_ctxmanager</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1888">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncSessionTransaction</span><span class="p">:</span>
</span><span id="1-1889">        <span class="bp">self</span><span class="o">.</span><span class="n">sync_transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_proxied</span><span class="p">(</span>
</span><span id="1-1890">            <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span>
</span><span id="1-1891">                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">begin_nested</span>
</span><span id="1-1892">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span>
</span><span id="1-1893">                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">sync_session</span><span class="o">.</span><span class="n">begin</span>
</span><span id="1-1894">            <span class="p">)</span>
</span><span id="1-1895">        <span class="p">)</span>
</span><span id="1-1896">        <span class="k">if</span> <span class="n">is_ctxmanager</span><span class="p">:</span>
</span><span id="1-1897">            <span class="bp">self</span><span class="o">.</span><span class="n">sync_transaction</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
</span><span id="1-1898">        <span class="k">return</span> <span class="bp">self</span>
</span><span id="1-1899">
</span><span id="1-1900">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">traceback</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1901">        <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span>
</span><span id="1-1902">            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_transaction</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span>
</span><span id="1-1903">        <span class="p">)</span>
</span><span id="1-1904">
</span><span id="1-1905">
</span><span id="1-1906"><span class="k">def</span><span class="w"> </span><span class="nf">async_object_session</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">]:</span>
</span><span id="1-1907"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the :class:`_asyncio.AsyncSession` to which the given instance</span>
</span><span id="1-1908"><span class="sd">    belongs.</span>
</span><span id="1-1909">
</span><span id="1-1910"><span class="sd">    This function makes use of the sync-API function</span>
</span><span id="1-1911"><span class="sd">    :class:`_orm.object_session` to retrieve the :class:`_orm.Session` which</span>
</span><span id="1-1912"><span class="sd">    refers to the given instance, and from there links it to the original</span>
</span><span id="1-1913"><span class="sd">    :class:`_asyncio.AsyncSession`.</span>
</span><span id="1-1914">
</span><span id="1-1915"><span class="sd">    If the :class:`_asyncio.AsyncSession` has been garbage collected, the</span>
</span><span id="1-1916"><span class="sd">    return value is ``None``.</span>
</span><span id="1-1917">
</span><span id="1-1918"><span class="sd">    This functionality is also available from the</span>
</span><span id="1-1919"><span class="sd">    :attr:`_orm.InstanceState.async_session` accessor.</span>
</span><span id="1-1920">
</span><span id="1-1921"><span class="sd">    :param instance: an ORM mapped instance</span>
</span><span id="1-1922"><span class="sd">    :return: an :class:`_asyncio.AsyncSession` object, or ``None``.</span>
</span><span id="1-1923">
</span><span id="1-1924"><span class="sd">    .. versionadded:: 1.4.18</span>
</span><span id="1-1925">
</span><span id="1-1926"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-1927">
</span><span id="1-1928">    <span class="n">session</span> <span class="o">=</span> <span class="n">object_session</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-1929">    <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1930">        <span class="k">return</span> <span class="n">async_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</span><span id="1-1931">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-1932">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-1933">
</span><span id="1-1934">
</span><span id="1-1935"><span class="k">def</span><span class="w"> </span><span class="nf">async_session</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">]:</span>
</span><span id="1-1936"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the :class:`_asyncio.AsyncSession` which is proxying the given</span>
</span><span id="1-1937"><span class="sd">    :class:`_orm.Session` object, if any.</span>
</span><span id="1-1938">
</span><span id="1-1939"><span class="sd">    :param session: a :class:`_orm.Session` instance.</span>
</span><span id="1-1940"><span class="sd">    :return: a :class:`_asyncio.AsyncSession` instance, or ``None``.</span>
</span><span id="1-1941">
</span><span id="1-1942"><span class="sd">    .. versionadded:: 1.4.18</span>
</span><span id="1-1943">
</span><span id="1-1944"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-1945">    <span class="k">return</span> <span class="n">AsyncSession</span><span class="o">.</span><span class="n">_retrieve_proxy_for_target</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">regenerate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="1-1946">
</span><span id="1-1947">
</span><span id="1-1948"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close_all_sessions</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1949"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Close all :class:`_asyncio.AsyncSession` sessions.</span>
</span><span id="1-1950">
</span><span id="1-1951"><span class="sd">    .. versionadded:: 2.0.23</span>
</span><span id="1-1952">
</span><span id="1-1953"><span class="sd">    .. seealso::</span>
</span><span id="1-1954">
</span><span id="1-1955"><span class="sd">        :func:`.session.close_all_sessions`</span>
</span><span id="1-1956">
</span><span id="1-1957"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-1958">    <span class="k">await</span> <span class="n">greenlet_spawn</span><span class="p">(</span><span class="n">_sync_close_all_sessions</span><span class="p">)</span>
</span><span id="1-1959">
</span><span id="1-1960">
</span><span id="1-1961"><span class="n">_instance_state</span><span class="o">.</span><span class="n">_async_provider</span> <span class="o">=</span> <span class="n">async_session</span>  <span class="c1"># type: ignore</span>
</span></pre></div>
        </article>
        
        <div class="navigation flex print:hidden">
  
  
</div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2023, Jacob Coffee</p>
        
        <p>
          Made with
          
          <a href="https://www.sphinx-doc.org/">Sphinx</a> and
          
          <a href="https://shibuya.lepture.com">Shibuya theme</a>.
        </p>
      </div>
      <div class="sy-foot-socials">
          <a href="https://github.com/JacobCoffee/byte-bot" aria-label="GitHub"><i class="i-icon github"></i></a>
          <a href="https://twitter.com/_scriptr" aria-label="X (Twitter)"><i class="i-icon x-twitter"></i></a>
          <a href="https://discord.gg/ZVG8hN6RrJ/" aria-label="Discord"><i class="i-icon discord"></i></a>
          <a href="https://youtube.com/@monorepo" aria-label="YouTube"><i class="i-icon youtube"></i></a>
      </div>
    </div>
  </div>
</footer></div>
      <script src="../../../../_static/documentation_options.js?v=8dde47fa"></script>
      <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../../../_static/shibuya.js?v=3e5c8598"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    
</body>
</html>